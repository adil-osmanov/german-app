<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>W√∂rterbuch Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        der: '#3b82f6', die: '#ef4444', das: '#10b981',
                        blue: {
                            50: 'rgb(var(--ac-50) / <alpha-value>)',
                            100: 'rgb(var(--ac-100) / <alpha-value>)',
                            200: 'rgb(var(--ac-200) / <alpha-value>)',
                            300: 'rgb(var(--ac-300) / <alpha-value>)',
                            400: 'rgb(var(--ac-400) / <alpha-value>)',
                            500: 'rgb(var(--ac-500) / <alpha-value>)',
                            600: 'rgb(var(--ac-600) / <alpha-value>)',
                            700: 'rgb(var(--ac-700) / <alpha-value>)',
                            800: 'rgb(var(--ac-800) / <alpha-value>)',
                            900: 'rgb(var(--ac-900) / <alpha-value>)',
                        }
                    }
                }
            }
        };
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        if ('serviceWorker' in navigator) window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js?v=6').catch(() => { }); });
    </script>
    <style>
        :root {
            --ac-50: 239 246 255;
            --ac-100: 219 234 254;
            --ac-200: 191 219 254;
            --ac-300: 147 197 253;
            --ac-400: 96 165 250;
            --ac-500: 59 130 246;
            --ac-600: 37 99 235;
            --ac-700: 29 78 216;
            --ac-800: 30 64 175;
            --ac-900: 30 58 138;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .dark .glass {
            background: rgba(17, 24, 39, 0.85);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .active-tab {
            color: #3b82f6;
            transform: translateY(-2px);
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .drag-handle-folder,
        .drag-handle-topic {
            touch-action: none;
            cursor: grab;
        }

        .drag-handle-folder:active,
        .drag-handle-topic:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.4;
            transform: scale(0.98);
            background: #f3f4f6;
            border-radius: 12px;
        }

        .dark .sortable-ghost {
            background: #1f2937;
        }

        @keyframes foldUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-15px) scale(0.97);
            }
        }

        .animate-fold-up {
            animation: foldUp 0.25s ease-out forwards;
        }
    </style>
</head>

<body
    class="bg-[#f2f2f7] dark:bg-black text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col overflow-hidden relative">

    <header
        class="fixed top-0 left-0 right-0 pt-12 pb-3 px-4 glass z-40 transition-all border-b border-gray-200 dark:border-gray-800">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <h1 id="header-title" class="text-xl font-extrabold tracking-tight">–°–ª–æ–≤–∞—Ä—å</h1>
            <div class="flex items-center gap-3">
                <button id="theme-toggle"
                    class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all text-gray-500 dark:text-gray-400">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z">
                        </path>
                    </svg>
                </button>
                <button onclick="document.getElementById('profile-modal').classList.remove('hidden')"
                    class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all text-gray-500 dark:text-gray-400 overflow-hidden flex items-center justify-center bg-cover bg-center"
                    style="width: 32px; height: 32px;" id="header-avatar" title="–°–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </button>
                <button onclick="document.getElementById('backup-modal').classList.remove('hidden')"
                    class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all text-gray-500 dark:text-gray-400"
                    title="–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                        </path>
                    </svg>
                </button>
                <button id="add-btn"
                    class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-600 active:scale-95 transition-all text-lg font-medium shadow-md shadow-blue-500/30">+</button>
            </div>
        </div>
    </header>

    <main id="main-scroll" class="pt-28 pb-24 max-w-2xl mx-auto px-3 w-full overflow-y-auto">

        <section id="view-dict" class="pt-4 pb-6">
            <div class="mb-5 mt-2">
                <div class="relative group">
                    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Å–ª–æ–≤..." autocomplete="off"
                        class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl py-3 pl-10 shadow-sm outline-none focus:ring-2 ring-blue-500/50 transition-all text-gray-900 dark:text-white text-sm">
                    <svg class="w-4 h-4 absolute left-4 top-3.5 text-gray-400 group-focus-within:text-blue-500 transition-colors"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <div
                class="flex bg-gray-200/60 dark:bg-gray-800/80 p-1 rounded-xl mb-4 border border-gray-100 dark:border-gray-800">
                <button id="dict-tab-active"
                    class="flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">–í
                    –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
                <button id="dict-tab-mastered"
                    class="flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 transition-all flex items-center justify-center gap-1 hover:text-gray-700 dark:hover:text-gray-300">–ê—Ä—Ö–∏–≤
                    üèÜ</button>
            </div>

            <div id="dict-list">
                <div class="text-center py-20">
                    <p class="text-gray-400 text-sm animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>
        </section>

        <section id="view-train" class="hidden relative pt-2 pb-6">
            <div id="train-setup-block" class="w-full animate-in fade-in slide-in-from-bottom-4 duration-300 sm:mt-4">
                <div
                    class="flex bg-gray-200/60 dark:bg-gray-800/80 p-1 rounded-xl mb-4 mt-1 gap-1 border border-gray-100 dark:border-gray-800">
                    <button id="dir-auto" onclick="setDirection('auto')"
                        class="flex-1 py-2 text-[10px] font-bold rounded-lg bg-white dark:bg-gray-700 text-blue-500 shadow-sm transition-all uppercase">–ú–∏–∫—Å</button>
                    <button id="dir-ru-de" onclick="setDirection('ru-de')"
                        class="flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 transition-all uppercase hover:text-gray-700 dark:hover:text-gray-300">–†–£–°
                        > –ù–ï–ú</button>
                    <button id="dir-de-ru" onclick="setDirection('de-ru')"
                        class="flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 transition-all uppercase hover:text-gray-700 dark:hover:text-gray-300">–ù–ï–ú
                        > –†–£–°</button>
                </div>
                <div id="train-topics-container" class="space-y-3"></div>
            </div>

            <div id="train-card-block"
                class="hidden w-full bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg text-center relative flex flex-col transition-all border border-gray-100 dark:border-gray-800 mt-2 sm:mt-6">
                <button id="btn-stop-training"
                    class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold z-10 transition-colors">√ó</button>

                <div class="mb-3"><span id="train-level-badge"
                        class="px-2.5 py-0.5 rounded-md text-[9px] font-bold uppercase tracking-widest bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">–£–∑–Ω–∞–≤–∞–Ω–∏–µ</span>
                </div>

                <div class="mb-5 w-full px-1">
                    <div
                        class="flex justify-between text-[10px] font-medium text-gray-400 mb-1.5 uppercase tracking-wider">
                        <span id="train-card-progress-text">–£—Ä–æ–≤–µ–Ω—å: 0/4</span>
                        <span id="train-total-cards">–û—Å—Ç–∞–ª–æ—Å—å: 0</span>
                    </div>
                    <div class="w-full bg-gray-100 dark:bg-gray-800 h-1.5 rounded-full overflow-hidden relative">
                        <div id="train-card-progress-fill" class="bg-blue-500 h-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>

                <div class="relative w-full flex justify-center items-center min-h-[60px] mb-4 px-10">
                    <h2 id="train-question"
                        class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight m-0 text-center break-words">
                        –ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <div class="absolute right-0 top-1/2 -translate-y-1/2"><button id="btn-speak-question"
                            class="hidden bg-gray-50 dark:bg-gray-800 w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-blue-500 transition-all border border-gray-100 dark:border-gray-700">üîä</button>
                    </div>
                </div>

                <p id="train-example-q"
                    class="text-sm text-blue-500 dark:text-blue-400 italic mb-5 hidden text-center w-full"></p>

                <button id="btn-show-answer"
                    class="w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-3.5 rounded-xl active:scale-95 transition-all mt-2 text-sm border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700">–ü–æ–∫–∞–∑–∞—Ç—å
                    –æ—Ç–≤–µ—Ç</button>

                <div id="train-answer-block" class="hidden w-full mt-3">
                    <div
                        class="flex flex-col justify-center items-center mb-6 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-100 dark:border-gray-800">
                        <div class="relative w-full flex justify-center items-center min-h-[40px] px-10 mb-2">
                            <p id="train-de-word"
                                class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight m-0 text-center">
                            </p>
                            <div class="absolute right-0 top-1/2 -translate-y-1/2"><button id="btn-speak-answer"
                                    class="hidden bg-blue-50 dark:bg-blue-900/30 w-8 h-8 rounded-full flex items-center justify-center text-blue-500 hover:scale-110 transition-transform">üîä</button>
                            </div>
                        </div>
                        <p id="train-de-plural" class="text-xs font-medium text-gray-500 mb-2 hidden"></p>

                        <p id="train-answer-example"
                            class="text-sm text-blue-500 dark:text-blue-400 italic mt-3 hidden text-center w-full"></p>
                    </div>

                    <div class="flex gap-2" id="sm2-buttons-block">
                        <button id="btn-forgot"
                            class="flex-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold py-3 rounded-xl border border-red-100 dark:border-red-900/30 active:scale-95 transition-all text-sm flex flex-col items-center hover:bg-red-100 dark:hover:bg-red-900/40">
                            <span class="mb-0.5">–ù–µ –ø–æ–º–Ω—é</span><span
                                class="text-[10px] font-medium opacity-70">–°–Ω–æ–≤–∞</span>
                        </button>
                        <button id="btn-remembered"
                            class="flex-1 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 font-bold py-3 rounded-xl border border-green-100 dark:border-green-900/30 active:scale-95 transition-all text-sm flex flex-col items-center hover:bg-green-100 dark:hover:bg-green-900/40">
                            <span class="mb-0.5">–ü–æ–º–Ω—é</span><span id="sm2-good-time"
                                class="text-[10px] font-medium opacity-70">X –¥–Ω</span>
                        </button>
                    </div>
                </div>

                <div id="train-manual-block" class="hidden w-full mt-3">
                    <div class="flex gap-2 mb-2 w-full">
                        <input type="text" id="manual-article" placeholder="der" autocomplete="off"
                            class="w-[60px] bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-1 text-center outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-sm"
                            style="text-align-last: center;">
                        <div class="flex-1 relative flex items-center min-w-0">
                            <input type="text" id="manual-main" placeholder="–í–ø–∏—à–∏—Ç–µ —Å–ª–æ–≤–æ..." autocomplete="off"
                                class="w-full bg-gray-50 dark:bg-gray-800 rounded-lg py-3 pl-3 pr-10 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-sm">
                            <button id="btn-mic" type="button"
                                class="absolute right-1 p-2 text-gray-400 hover:text-blue-500 transition-colors rounded-md active:scale-90"
                                title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                                    </path>
                                </svg></button>
                        </div>
                    </div>
                    <div class="flex gap-2 mb-2 w-full hidden" id="manual-plural-container">
                        <div
                            class="bg-gray-100 dark:bg-gray-800 rounded-lg py-3 px-1 text-center outline-none font-medium text-gray-500 w-[60px] min-w-0 flex items-center justify-center text-xs">
                            die (pl)</div>
                        <input type="text" id="manual-plural" placeholder="–§–æ—Ä–º–∞ –º–Ω. —á–∏—Å–ª–∞..." autocomplete="off"
                            class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-3 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-sm">
                    </div>
                    <div class="flex gap-2 mb-2 w-full hidden" id="manual-verb-forms-container">
                        <input type="text" id="manual-praeteritum" placeholder="Pr√§teritum" autocomplete="off"
                            class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-2 text-center outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-xs">
                        <input type="text" id="manual-partizip" placeholder="Partizip II" autocomplete="off"
                            class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-2 text-center outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-xs">
                    </div>
                    <div id="manual-feedback"
                        class="hidden w-full text-center py-3 rounded-lg font-medium text-sm mb-3 transition-all"></div>

                    <div id="train-umlauts" class="flex justify-center gap-2 mb-4">
                        <button type="button" tabindex="-1" onmousedown="insertChar('√§', event)"
                            class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√§</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√∂', event)"
                            class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√∂</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√º', event)"
                            class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√º</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√ü', event)"
                            class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√ü</button>
                    </div>
                    <button id="btn-check-manual"
                        class="w-full bg-blue-500 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-all disabled:opacity-50 text-sm shadow-md shadow-blue-500/20 hover:bg-blue-600">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>
        </section>

        <section id="view-practice" class="hidden relative pt-2 pb-6">

            <div id="practice-menu" class="space-y-4 px-2 mt-4 animate-in fade-in duration-300">
                <div class="mb-6 text-center">
                    <h2 class="text-3xl font-black tracking-tight mb-2 text-gray-900 dark:text-white">–ü—Ä–∞–∫—Ç–∏–∫–∞</h2>
                    <p class="text-gray-500 text-sm leading-relaxed">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤.</p>
                </div>

                <button onclick="startBuilder()"
                    class="w-full text-left bg-gradient-to-br from-blue-500 to-indigo-600 hover:scale-[0.98] transition-all p-5 rounded-[2rem] shadow-md shadow-blue-500/20 text-white flex justify-between items-center group">
                    <div>
                        <span
                            class="text-[10px] font-black uppercase tracking-widest mb-1 block opacity-80">–°–∏–Ω—Ç–∞–∫—Å–∏—Å</span>
                        <h3 class="text-xl font-bold">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ—Ä–∞–∑</h3>
                        <p class="text-blue-100 text-[11px] font-medium mt-1">–°–±–æ—Ä–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫.</p>
                    </div>
                    <div
                        class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm text-xl">
                        üß©</div>
                </button>

                <button onclick="startVerbTrainer()"
                    class="w-full text-left bg-gradient-to-br from-orange-400 to-red-500 hover:scale-[0.98] transition-all p-5 rounded-[2rem] shadow-md shadow-orange-500/20 text-white flex justify-between items-center group mb-4">
                    <div>
                        <span
                            class="text-[10px] font-black uppercase tracking-widest mb-1 block opacity-80">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</span>
                        <h3 class="text-xl font-bold">–ì–ª–∞–≥–æ–ª—ã</h3>
                        <p class="text-orange-100 text-[11px] font-medium mt-1">–¢—Ä–µ–Ω–∏—Ä—É–π Pr√§teritum –∏ Partizip II.</p>
                    </div>
                    <div
                        class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm text-xl">
                        ‚öîÔ∏è</div>
                </button>

                <button onclick="startListeningQuiz()"
                    class="w-full text-left bg-gradient-to-br from-green-500 to-emerald-600 hover:scale-[0.98] transition-all p-5 rounded-[2rem] shadow-md shadow-green-500/20 text-white flex justify-between items-center group mb-4">
                    <div>
                        <span
                            class="text-[10px] font-black uppercase tracking-widest mb-1 block opacity-80">–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ</span>
                        <h3 class="text-xl font-bold">–ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                        <p class="text-green-100 text-[11px] font-medium mt-1">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–∞ —Å–ª—É—Ö.</p>
                    </div>
                    <div
                        class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm text-xl flex-shrink-0">
                        üéß</div>
                </button>

                <button onclick="startSprint()"
                    class="w-full text-left bg-gradient-to-br from-purple-500 to-fuchsia-600 hover:scale-[0.98] transition-all p-5 rounded-[2rem] shadow-md shadow-purple-500/20 text-white flex justify-between items-center group">
                    <div>
                        <span
                            class="text-[10px] font-black uppercase tracking-widest mb-1 block opacity-80">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                        <h3 class="text-xl font-bold">–°–ø—Ä–∏–Ω—Ç</h3>
                        <p class="text-purple-100 text-[11px] font-medium mt-1">–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å–ª–æ–≤ (–Ω–∞ –≤—Ä–µ–º—è).</p>
                    </div>
                    <div
                        class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm text-xl flex-shrink-0">
                        ‚ö°</div>
                </button>

                <button onclick="startMatchGame()"
                    class="w-full text-left bg-gradient-to-br from-indigo-500 to-blue-600 hover:scale-[0.98] transition-all p-5 rounded-[2rem] shadow-md shadow-indigo-500/20 text-white flex justify-between items-center group mb-2">
                    <div>
                        <span
                            class="text-[10px] font-black uppercase tracking-widest mb-1 block opacity-80">–†–µ–∞–∫—Ü–∏—è</span>
                        <h3 class="text-xl font-bold">–ü–æ–¥–±–æ—Ä –ø–∞—Ä</h3>
                        <p class="text-indigo-100 text-[11px] font-medium mt-1">–°–æ–µ–¥–∏–Ω–∏ —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –≤—Ä–µ–º—è.</p>
                    </div>
                    <div
                        class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm text-xl flex-shrink-0">
                        üîó</div>
                </button>
            </div>

            <div id="match-game" class="hidden mt-4 animate-in slide-in-from-bottom-4 duration-300">
                <div
                    class="bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg border border-gray-100 dark:border-gray-800 relative">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">–ü–æ–¥–±–æ—Ä –ø–∞—Ä</span>
                        <div class="flex items-center gap-3">
                            <span id="match-timer"
                                class="font-mono text-lg font-bold text-gray-700 dark:text-gray-300">0.0—Å</span>
                            <button onclick="closePractice()"
                                class="text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold transition-colors">√ó</button>
                        </div>
                    </div>
                    <div id="match-grid" class="grid grid-cols-2 gap-3 mb-6 min-h-[300px]"></div>
                    <button id="btn-match-retry" onclick="startMatchGame()"
                        class="hidden w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3.5 rounded-xl transition-all shadow-md shadow-indigo-500/20 active:scale-95">–ò–≥—Ä–∞—Ç—å
                        —Å–Ω–æ–≤–∞</button>
                    <p id="match-feedback" class="text-center font-bold text-lg mt-4 hidden animate-in fade-in zoom-in">
                    </p>
                </div>
            </div>

            <div id="builder-game" class="hidden mt-4 animate-in slide-in-from-bottom-4 duration-300">
                <div
                    class="bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg border border-gray-100 dark:border-gray-800 relative">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">–°–æ–±–µ—Ä–∏
                            –æ—Ä–∏–≥–∏–Ω–∞–ª</span>
                        <button onclick="closePractice()"
                            class="text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold transition-colors">√ó</button>
                    </div>

                    <p id="builder-target-word"
                        class="text-sm font-medium text-gray-500 mb-5 bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-center leading-relaxed">
                    </p>

                    <div id="builder-dropzone"
                        class="min-h-[70px] flex flex-wrap content-start gap-2 p-3 bg-blue-50/50 dark:bg-blue-900/10 rounded-xl border-2 border-dashed border-blue-200 dark:border-blue-800/50 mb-6 transition-colors">
                    </div>
                    <div id="builder-pool" class="flex flex-wrap justify-center gap-2 min-h-[80px]"></div>
                    <div id="builder-feedback"
                        class="hidden w-full text-center py-3 rounded-xl font-bold text-sm mt-4 transition-all"></div>

                    <button id="btn-check-builder" onclick="checkBuilder()"
                        class="w-full bg-gray-100 dark:bg-gray-800 text-gray-400 font-bold py-3.5 rounded-xl mt-6 transition-all border border-transparent"
                        disabled>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>

            <div id="verb-trainer-game" class="hidden mt-4 animate-in slide-in-from-bottom-4 duration-300">
                <div
                    class="bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg border border-gray-100 dark:border-gray-800 text-center relative flex flex-col transition-all">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
                            –ø–∞–º—è—Ç–∏</span>
                        <button onclick="closePractice()"
                            class="text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold transition-colors">√ó</button>
                    </div>

                    <div class="flex bg-gray-100 dark:bg-gray-800/80 p-1 rounded-xl mb-6">
                        <button id="vt-mode-praet" onclick="setVTMode('praet')"
                            class="flex-1 py-2 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">Pr√§teritum
                            (2 —Ñ.)</button>
                        <button id="vt-mode-perf" onclick="setVTMode('perf')"
                            class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300">Partizip
                            II (3 —Ñ.)</button>
                    </div>

                    <div class="mb-8">
                        <span id="vt-counter"
                            class="text-[10px] font-medium text-gray-400 uppercase tracking-wider mb-2 block">–û—Å—Ç–∞–ª–æ—Å—å:
                            0</span>
                        <p id="vt-ru" class="text-sm text-gray-500 mb-1 font-medium"></p>
                        <h2 id="vt-inf" class="text-3xl font-black text-gray-900 dark:text-white tracking-tight"></h2>
                    </div>

                    <button id="vt-btn-show" onclick="showVTAnswer()"
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-md shadow-orange-500/20 active:scale-95 transition-all">–ü–æ–∫–∞–∑–∞—Ç—å
                        –æ—Ç–≤–µ—Ç</button>

                    <div id="vt-answer-block" class="hidden w-full space-y-4">
                        <div
                            class="p-6 bg-orange-50 dark:bg-orange-900/20 rounded-2xl border border-orange-100 dark:border-orange-800/50 flex flex-col justify-center min-h-[100px]">
                            <p id="vt-answer" class="text-3xl font-black text-orange-600 dark:text-orange-400"></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="answerVerb(false)"
                                class="flex-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold py-4 rounded-xl border border-red-100 dark:border-red-900/30 active:scale-95 transition-all">–ù–µ
                                –ø–æ–º–Ω—é</button>
                            <button onclick="answerVerb(true)"
                                class="flex-1 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 font-bold py-4 rounded-xl border border-green-100 dark:border-green-900/30 active:scale-95 transition-all">–ü–æ–º–Ω—é</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="listening-game" class="hidden mt-4 animate-in slide-in-from-bottom-4 duration-300">
                <div
                    class="bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg border border-gray-100 dark:border-gray-800 text-center relative flex flex-col transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">–ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                        <button onclick="closePractice()"
                            class="text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold transition-colors">√ó</button>
                    </div>
                    <div class="mb-8 flex flex-col items-center">
                        <span id="listening-counter"
                            class="text-[10px] font-medium text-gray-400 uppercase tracking-wider mb-6 block">–û—Å—Ç–∞–ª–æ—Å—å:
                            0</span>
                        <button onclick="playListeningWord()"
                            class="w-24 h-24 bg-green-500 hover:bg-green-600 rounded-full text-white text-5xl flex items-center justify-center shadow-lg shadow-green-500/30 transform active:scale-95 transition-all">
                            ‚ñ∂Ô∏è
                        </button>
                        <p class="text-xs text-gray-400 mt-4 font-medium">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–ª—É—à–∞—Ç—å</p>
                    </div>
                    <div id="listening-options" class="grid grid-cols-1 gap-3 w-full"></div>
                </div>
            </div>

            <div id="sprint-game" class="hidden mt-4 animate-in slide-in-from-bottom-4 duration-300">
                <div
                    class="bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg border border-gray-100 dark:border-gray-800 text-center relative flex flex-col transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">–°–ø—Ä–∏–Ω—Ç</span>
                        <button onclick="closePractice()"
                            class="text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold transition-colors">√ó</button>
                    </div>
                    <div class="mb-8">
                        <div class="w-full bg-gray-100 dark:bg-gray-800 h-2 rounded-full overflow-hidden mb-6">
                            <div id="sprint-progress"
                                class="bg-purple-500 h-full transition-all duration-1000 ease-linear"
                                style="width: 100%"></div>
                        </div>
                        <span id="sprint-score"
                            class="text-[10px] font-bold text-purple-500 uppercase tracking-wider mb-2 block">–°—á–µ—Ç:
                            0</span>
                        <h2 id="sprint-word"
                            class="text-3xl font-black text-gray-900 dark:text-white tracking-tight leading-tight"></h2>
                    </div>
                    <div id="sprint-options" class="grid grid-cols-1 gap-3 w-full"></div>
                </div>
            </div>
        </section>

        <section id="view-stats" class="hidden pb-10 pt-4"></section>
    </main>

    <div id="backup-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex justify-center items-center p-4"
        onclick="if(event.target === this) this.classList.add('hidden')">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 text-center relative">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold">–î–∞–Ω–Ω—ã–µ</h2><button
                    onclick="document.getElementById('backup-modal').classList.add('hidden')"
                    class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800">√ó</button>
            </div>
            <button onclick="exportData()" id="btn-trigger-export"
                class="w-full bg-blue-500 text-white font-medium py-3.5 rounded-xl mb-4">–°–∫–∞—á–∞—Ç—å –±–∞–∑—É (.csv)</button>
            <button id="btn-trigger-restore" onclick="document.getElementById('file-restore').click()"
                class="w-full bg-gray-50 dark:bg-gray-800 font-medium py-3.5 rounded-xl border border-gray-200 dark:border-gray-700">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                –∏–∑ —Ñ–∞–π–ª–∞</button>
            <input type="file" id="file-restore" accept=".csv" class="hidden">
        </div>
    </div>

    <div id="profile-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex justify-center items-center p-4 transition-all"
        onclick="if(event.target === this) this.classList.add('hidden')">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 text-center relative">
            <h2 class="text-xl font-bold mb-6">–ö—Ç–æ —É—á–∏—Ç —Å–ª–æ–≤–∞?</h2>

            <div class="space-y-3 mb-6">
                <button onclick="setProfile('osman')" id="profile-btn-osman"
                    class="w-full flex items-center p-4 rounded-xl border-2 transition-all group">
                    <div class="relative flex-shrink-0"
                        onclick="event.stopPropagation(); document.getElementById('file-avatar-osman').click()">
                        <div id="avatar-osman"
                            class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl font-bold bg-cover bg-center group-hover:opacity-80 transition-all">
                            –û</div>
                        <div class="absolute -bottom-1 -right-1 bg-white dark:bg-gray-800 rounded-full p-1 shadow-sm border border-gray-100 dark:border-gray-700 hover:scale-110 transition-transform"
                            title="–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
                            <svg class="w-3 h-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4 flex flex-col items-start w-full">
                        <span class="font-bold text-lg">Adil Osmanov</span>
                    </div>
                </button>
                <input type="file" id="file-avatar-osman" accept="image/*" class="hidden"
                    onchange="uploadAvatar('osman', this)">

                <button onclick="setProfile('girlfriend')" id="profile-btn-girlfriend"
                    class="w-full flex items-center p-4 rounded-xl border-2 transition-all group">
                    <div class="relative flex-shrink-0"
                        onclick="event.stopPropagation(); document.getElementById('file-avatar-girlfriend').click()">
                        <div id="avatar-girlfriend"
                            class="w-12 h-12 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-xl font-bold bg-cover bg-center group-hover:opacity-80 transition-all">
                            –î</div>
                        <div class="absolute -bottom-1 -right-1 bg-white dark:bg-gray-800 rounded-full p-1 shadow-sm border border-gray-100 dark:border-gray-700 hover:scale-110 transition-transform"
                            title="–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
                            <svg class="w-3 h-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <span class="ml-4 font-bold text-lg">Ewelin Osmanov</span>
                </button>
                <input type="file" id="file-avatar-girlfriend" accept="image/*" class="hidden"
                    onchange="uploadAvatar('girlfriend', this)">
            </div>

            <button onclick="document.getElementById('profile-modal').classList.add('hidden')"
                class="w-full bg-gray-100 dark:bg-gray-800 font-medium py-3 rounded-xl hidden"
                id="profile-close-btn">–°–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="add-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex justify-center items-center p-4"
        onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-gray-900 w-full max-w-lg rounded-[2rem] p-5 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 max-h-[90dvh] flex flex-col relative"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-white">–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ</h2>
                <button id="close-modal"
                    class="text-gray-400 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors">√ó</button>
            </div>
            <div class="overflow-y-auto pr-1 -mr-1 pb-1">
                <div id="modal-tabs" class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl mb-4">
                    <button id="tab-single"
                        class="flex-1 py-2 text-sm font-medium rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">–û–¥–Ω–æ
                        —Å–ª–æ–≤–æ</button>
                    <button id="tab-bulk"
                        class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300">–°–ø–∏—Å–∫–æ–º
                        (CSV)</button>
                </div>

                <div id="form-single">
                    <div
                        class="flex bg-gray-50 dark:bg-gray-800/50 p-1 rounded-lg mb-3 border border-gray-100 dark:border-gray-800">
                        <button id="type-noun"
                            class="flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded-md bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ</button>
                        <button id="type-verb"
                            class="flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300">–ì–ª–∞–≥–æ–ª
                            / –î—Ä—É–≥–æ–µ</button>
                    </div>
                    <form id="add-form" class="space-y-3">
                        <div id="article-selector" class="flex gap-1 w-full mb-1">
                            <button type="button" id="btn-art-der" onclick="selectArticle('der')"
                                class="flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium transition-all shadow-sm text-sm">der</button>
                            <button type="button" id="btn-art-die" onclick="selectArticle('die')"
                                class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-500 font-medium transition-all text-sm hover:bg-gray-100 dark:hover:bg-gray-700">die</button>
                            <button type="button" id="btn-art-das" onclick="selectArticle('das')"
                                class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-500 font-medium transition-all text-sm hover:bg-gray-100 dark:hover:bg-gray-700">das</button>
                        </div>
                        <div class="flex flex-col w-full">
                            <input type="text" id="word-de" placeholder="–°–ª–æ–≤–æ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º..." required
                                autocomplete="off"
                                class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all text-sm">
                            <span id="translate-loader-de"
                                class="text-[10px] text-blue-500 mt-1 ml-2 hidden font-medium flex items-center gap-1 animate-pulse">–ü–µ—Ä–µ–≤–æ–∂—É...</span>
                            <span id="duplicate-warning"
                                class="text-[10px] text-red-500 mt-1 ml-2 hidden font-medium flex items-center gap-1"></span>
                        </div>
                        <div class="flex gap-2 w-full" id="plural-input-group">
                            <div
                                class="bg-gray-100 dark:bg-gray-800 rounded-xl py-3 px-2 text-center outline-none font-medium text-gray-500 w-[60px] min-w-0 flex items-center justify-center text-xs">
                                die (pl)</div>
                            <input type="text" id="word-plural" placeholder="–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ..." autocomplete="off"
                                class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all min-w-0 text-sm">
                        </div>
                        <div class="flex gap-2 w-full hidden" id="verb-forms-group">
                            <input type="text" id="word-praeteritum" placeholder="Pr√§teritum..." autocomplete="off"
                                class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all min-w-0 text-sm">
                            <input type="text" id="word-partizip" placeholder="Partizip II..." autocomplete="off"
                                class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all min-w-0 text-sm">
                        </div>
                        <div class="flex flex-col w-full">
                            <input type="text" id="word-ru" placeholder="–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π..." required
                                autocomplete="off"
                                class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white transition-all text-sm">
                            <span id="translate-loader-ru"
                                class="text-[10px] text-blue-500 mt-1 ml-2 hidden font-medium flex items-center gap-1 animate-pulse">–ü–µ—Ä–µ–≤–æ–∂—É...</span>
                        </div>
                        <input type="text" id="word-example" placeholder="–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..."
                            class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-sm text-gray-900 dark:text-white transition-all">
                        <div class="flex w-full gap-2">
                            <div class="flex-[2] min-w-0"><input type="text" id="word-folder" list="folder-list"
                                    placeholder="–ö—É—Ä—Å" required
                                    class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none text-xs font-medium text-gray-900 dark:text-white focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700">
                            </div>
                            <div class="flex-[1] min-w-0"><input type="text" id="word-level" list="level-list"
                                    placeholder="–£—Ä."
                                    class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-1 outline-none text-xs font-medium text-gray-900 dark:text-white focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-center uppercase">
                            </div>
                            <div class="flex-[2] min-w-0"><input type="text" id="word-subfolder" list="subfolder-list"
                                    placeholder="–¢–µ–º–∞" required
                                    class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none text-xs font-medium text-gray-900 dark:text-white focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700">
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-500 text-white font-medium py-3.5 rounded-xl mt-2 active:scale-95 transition-all text-sm hover:bg-blue-600 shadow-md shadow-blue-500/20">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
                <div class="hidden space-y-3" id="form-bulk">
                    <p class="text-xs text-gray-500 text-center mb-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ .csv</p>
                    <div class="flex w-full gap-2">
                        <div class="flex-[2] min-w-0"><input type="text" id="bulk-folder" list="folder-list"
                                placeholder="–ö—É—Ä—Å"
                                class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none font-medium text-gray-900 dark:text-white text-xs border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-green-500/50">
                        </div>
                        <div class="flex-[1] min-w-0"><input type="text" id="bulk-level" list="level-list"
                                placeholder="–£—Ä."
                                class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-1 outline-none font-medium text-gray-900 dark:text-white text-xs text-center uppercase border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-green-500/50">
                        </div>
                        <div class="flex-[2] min-w-0"><input type="text" id="bulk-subfolder" list="subfolder-list"
                                placeholder="–¢–µ–º–∞"
                                class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none font-medium text-gray-900 dark:text-white text-xs border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-green-500/50">
                        </div>
                    </div>
                    <div class="mt-2 p-6 border-2 border-dashed border-green-300 dark:border-green-800/50 bg-green-50 dark:bg-green-900/10 rounded-xl text-center transition-all group hover:bg-green-100 dark:hover:bg-green-900/20 cursor-pointer"
                        onclick="document.getElementById('bulk-file').click()">
                        <input type="file" id="bulk-file" accept=".csv" class="hidden">
                        <div class="flex flex-col items-center gap-2 pointer-events-none">
                            <svg class="w-8 h-8 text-green-500 group-hover:scale-110 transition-transform" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                </path>
                            </svg>
                            <span class="text-green-600 dark:text-green-400 font-medium text-sm"
                                id="bulk-file-label">–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª</span>
                        </div>
                    </div>
                    <button id="btn-upload-csv"
                        class="w-full bg-green-500 text-white font-medium py-3.5 rounded-xl mt-2 active:scale-95 transition-all text-sm hover:bg-green-600 shadow-md shadow-green-500/30">–ó–∞–≥—Ä—É–∑–∏—Ç—å
                        —Å–ª–æ–≤–∞</button>
                </div>
            </div>
        </div>
    </div>

    <nav
        class="fixed bottom-0 left-0 right-0 w-full glass border-t border-gray-200 dark:border-gray-800 z-30 pt-2 pb-[calc(env(safe-area-inset-bottom,0px)+8px)] px-2">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button id="nav-dict"
                class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group w-1/4">
                <svg class="w-6 h-6 group-[.active-tab]:text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                    </path>
                </svg>
                <span class="text-[9px] font-medium group-[.active-tab]:text-blue-500 truncate">–°–ª–æ–≤–∞—Ä—å</span>
            </button>
            <button id="nav-train"
                class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group w-1/4">
                <svg class="w-6 h-6 group-[.active-tab]:text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
                <span class="text-[9px] font-medium group-[.active-tab]:text-blue-500 truncate">–£—á–∏—Ç—å</span>
            </button>
            <button id="nav-practice"
                class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group w-1/4">
                <svg class="w-6 h-6 group-[.active-tab]:text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5">
                    </path>
                </svg>
                <span class="text-[9px] font-medium group-[.active-tab]:text-blue-500 truncate">–ü—Ä–∞–∫—Ç–∏–∫–∞</span>
            </button>
            <button id="nav-stats"
                class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group w-1/4">
                <svg class="w-6 h-6 group-[.active-tab]:text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
                <span class="text-[9px] font-medium group-[.active-tab]:text-blue-500 truncate">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
            </button>
        </div>
    </nav>

    <datalist id="folder-list"></datalist><datalist id="level-list"></datalist><datalist id="subfolder-list"></datalist>

    <script>
        const escapeStr = (str) => (str || '').replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "&quot;");

        // –£—Ç–∏–ª–∏—Ç–∞ –æ—á–∏—Å—Ç–∫–∏ –Ω–µ–º–µ—Ü–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —Ä—É—Å—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        const extractGermanSentence = (ex) => {
            if (!ex) return "";
            return ex.split(/[-‚Äî(/\[]/)[0].trim().replace(/[.,?!]/g, '');
        };

        const API_URL = '/words';
        let currentType = 'noun';
        let editId = null;
        let globalWords = [];
        let serverHistory = {};

        let sessionStartMs = 0;
        const DAILY_GOAL_MINUTES = 15;
        const MAX_SCORE = 4;

        let dictTabFilter = 'active';
        let trainDirection = 'auto';
        let currentIsGermanQuestion = false;
        let currentArticle = 'der';
        let collapsedDictTopics = {};

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) { recognition = new SpeechRecognition(); recognition.interimResults = false; recognition.maxAlternatives = 1; }

        function calculateSM2(quality, repetitions = 0, interval = 0, easeFactor = 2.5, currentScore = 0) {
            if (repetitions === 0 && currentScore > 0) {
                repetitions = currentScore;
                if (interval === 0) {
                    if (currentScore === 1) interval = 1;
                    else if (currentScore === 2) interval = 4;
                    else if (currentScore === 3) interval = 12;
                    else interval = 36;
                }
            }
            if (quality < 3) { repetitions = 0; interval = 0; }
            else { if (repetitions === 0) interval = 1; else if (repetitions === 1) interval = 4; else interval = Math.round(interval * easeFactor * 1.2); repetitions++; }
            easeFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            if (easeFactor < 1.3) easeFactor = 1.3;
            return { repetitions, interval, easeFactor };
        }

        function formatInterval(days) {
            if (!days || days <= 0) return '1 –¥–Ω';
            if (days < 30) return `${days} –¥–Ω`;
            if (days < 365) return `${(days / 30).toFixed(1).replace('.0', '')} –º–µ—Å`;
            return `${(days / 365).toFixed(1).replace('.0', '')} –≥`;
        }

        let currentUser = localStorage.getItem('appUser');
        if (!currentUser) {
            document.getElementById('profile-modal').classList.remove('hidden');
        } else {
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('profile-close-btn').classList.remove('hidden');
        }

        // --- INDEXED DB OFFLINE OFFLINE-SYNC ---
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open('worterbuch_idb', 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('words')) db.createObjectStore('words', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('sync_queue')) db.createObjectStore('sync_queue', { keyPath: 'id', autoIncrement: true });
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        async function idbGetWords() {
            try {
                const db = await dbPromise;
                return new Promise(res => {
                    const tx = db.transaction('words', 'readonly');
                    const req = tx.objectStore('words').getAll();
                    req.onsuccess = () => res(req.result || []);
                });
            } catch (e) { return []; }
        }

        async function idbSaveWords(wordsList) {
            try {
                const db = await dbPromise;
                return new Promise(res => {
                    const tx = db.transaction('words', 'readwrite');
                    tx.objectStore('words').clear();
                    wordsList.forEach(w => tx.objectStore('words').put(w));
                    tx.oncomplete = () => res();
                });
            } catch (e) { }
        }

        async function queueOfflineUpdate(endpoint, method, payload) {
            try {
                const db = await dbPromise;
                return new Promise(res => {
                    const tx = db.transaction('sync_queue', 'readwrite');
                    tx.objectStore('sync_queue').put({ endpoint, method, payload, timestamp: Date.now() });
                    tx.oncomplete = () => res();
                });
            } catch (e) { }
        }

        async function processSyncQueue() {
            if (!navigator.onLine) return;
            try {
                const db = await dbPromise;
                const items = await new Promise(res => {
                    const tx = db.transaction('sync_queue', 'readonly');
                    const req = tx.objectStore('sync_queue').getAll();
                    req.onsuccess = () => res(req.result || []);
                });

                if (items.length > 0) {
                    console.log(`Syncing ${items.length} offline operations...`);
                    for (let item of items) {
                        const ok = await apiFetch(item.endpoint, { method: item.method, headers: { 'Content-Type': 'application/json' }, body: item.payload && JSON.stringify(item.payload), _isSync: true }).then(() => true).catch(() => false);
                        if (ok) {
                            await new Promise(res => {
                                const tx = db.transaction('sync_queue', 'readwrite');
                                tx.objectStore('sync_queue').delete(item.id);
                                tx.oncomplete = () => res();
                            });
                        }
                    }
                    console.log('Sync complete');
                    fetchWords();
                }
            } catch (e) { console.error(e); }
        }

        window.addEventListener('online', () => {
            setTimeout(processSyncQueue, 1500);
        });

        async function apiFetch(url, options = {}) {
            if (!currentUser) currentUser = 'osman';
            if (!options.headers) options.headers = {};
            options.headers['x-user'] = currentUser;

            const isScoreUpdate = url.includes('/score') && options.method === 'PUT';

            if (!navigator.onLine && isScoreUpdate && !options._isSync) {
                // Mock success for offline score update
                await queueOfflineUpdate(url, options.method, JSON.parse(options.body));
                return { ok: true, json: async () => ({ status: 'queued offline' }) };
            }

            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error('Network Error');
                return res;
            } catch (e) {
                if (isScoreUpdate && !options._isSync) {
                    await queueOfflineUpdate(url, options.method, JSON.parse(options.body));
                    return { ok: true, json: async () => ({ status: 'queued offline' }) };
                }
                throw e;
            }
        }

        function loadAvatars() {
            ['osman', 'girlfriend'].forEach(user => {
                const av = localStorage.getItem('avatar_' + user);
                const el = document.getElementById('avatar-' + user);
                if (av && el) {
                    el.style.backgroundImage = `url(${av})`; el.innerText = '';
                } else if (el) {
                    el.style.backgroundImage = 'none'; el.innerText = user === 'osman' ? '–û' : '–î';
                }
            });
            const hdAv = document.getElementById('header-avatar');
            if (hdAv && currentUser) {
                const currentAv = localStorage.getItem('avatar_' + currentUser);
                if (currentAv) {
                    hdAv.style.backgroundImage = `url(${currentAv})`; hdAv.innerHTML = '';
                    hdAv.classList.replace('p-1.5', 'p-0'); hdAv.style.border = '1px solid #e5e7eb';
                } else {
                    hdAv.style.backgroundImage = 'none'; hdAv.classList.replace('p-0', 'p-1.5'); hdAv.style.border = 'none';
                    hdAv.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`;
                }
            }
        }

        window.uploadAvatar = (user, input) => {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const MAX_SIZE = 150;
                    let width = img.width, height = img.height; const size = Math.min(width, height);
                    canvas.width = MAX_SIZE; canvas.height = MAX_SIZE;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, (width - size) / 2, (height - size) / 2, size, size, 0, 0, MAX_SIZE, MAX_SIZE);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    try { localStorage.setItem('avatar_' + user, dataUrl); loadAvatars(); }
                    catch (err) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!"); }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
            input.value = '';
        };

        function updateProfileUI() {
            if (!currentUser) return;
            document.getElementById('profile-btn-osman').className = currentUser === 'osman' ? "w-full flex items-center p-4 rounded-xl border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20 transition-all text-gray-900 dark:text-white" : "w-full flex items-center p-4 rounded-xl border-2 border-transparent bg-gray-50 dark:bg-gray-800 transition-all hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white";
            document.getElementById('profile-btn-girlfriend').className = currentUser === 'girlfriend' ? "w-full flex items-center p-4 rounded-xl border-2 border-pink-500 bg-pink-50 dark:bg-pink-900/20 transition-all text-gray-900 dark:text-white" : "w-full flex items-center p-4 rounded-xl border-2 border-transparent bg-gray-50 dark:bg-gray-800 transition-all hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white";
            loadAvatars();
        }
        updateProfileUI();

        window.setProfile = async (user) => {
            currentUser = user;
            localStorage.setItem('appUser', user);
            updateProfileUI();
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('profile-close-btn').classList.remove('hidden');
            globalWords = []; serverHistory = {};
            await switchView('dict');
        };

        const getLevelColor = (level) => {
            if (!level) return 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400';
            const l = level.toUpperCase().replace(/–ê/g, 'A').replace(/–í/g, 'B').replace(/–°/g, 'C');
            if (l.includes('A1')) return 'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-400';
            if (l.includes('A2')) return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';
            if (l.includes('B1')) return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400';
            if (l.includes('B2')) return 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400';
            if (l.includes('C1')) return 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';
            return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
        };

        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const updateIcons = () => { if (document.documentElement.classList.contains('dark')) { darkIcon.classList.add('hidden'); lightIcon.classList.remove('hidden'); } else { lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden'); } };
        updateIcons();
        themeToggleBtn.onclick = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; updateIcons(); };

        window.speakWord = (text, event) => { if (event) event.stopPropagation(); window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'de-DE'; u.rate = 0.85; window.speechSynthesis.speak(u); };
        window.activeInput = null; document.addEventListener('focusin', e => { if (e.target.tagName === 'INPUT') window.activeInput = e.target; });
        window.insertChar = (char, event) => {
            event.preventDefault(); if (!window.activeInput) return;
            const start = window.activeInput.selectionStart; const end = window.activeInput.selectionEnd; const val = window.activeInput.value;
            window.activeInput.value = val.slice(0, start) + char + val.slice(end); window.activeInput.selectionStart = window.activeInput.selectionEnd = start + 1; window.activeInput.dispatchEvent(new Event('input'));
        };
        const handleEnter = (e) => {
            if (e.key === 'Enter') {
                const btnCheck = document.getElementById('btn-check-manual'); const btnNext = document.getElementById('btn-show-answer');
                if (btnCheck && !btnCheck.disabled && !document.getElementById('train-manual-block').classList.contains('hidden')) { e.preventDefault(); btnCheck.click(); }
                else if (btnNext && !btnNext.classList.contains('hidden')) { e.preventDefault(); btnNext.click(); }
            }
        };
        document.addEventListener('keydown', handleEnter);

        async function saveSessionTime() {
            if (sessionStartMs > 0) {
                const elapsedMs = Date.now() - sessionStartMs;
                const tzoffset = (new Date()).getTimezoneOffset() * 60000;
                const localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 10);
                try { await apiFetch('/history', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date_str: localISOTime, ms_spent: elapsedMs }) }); } catch (e) { }
                sessionStartMs = 0;
            }
        }

        const views = { dict: document.getElementById('view-dict'), train: document.getElementById('view-train'), practice: document.getElementById('view-practice'), stats: document.getElementById('view-stats') };
        const navBtns = { dict: document.getElementById('nav-dict'), train: document.getElementById('nav-train'), practice: document.getElementById('nav-practice'), stats: document.getElementById('nav-stats') };
        const isWordDue = (w) => Date.now() >= (w.next_review || 0);

        window.fetchWords = async () => {
            try {
                if (!navigator.onLine) throw new Error('Offline mode');
                const res = await apiFetch(API_URL); const data = await res.json();
                if (Array.isArray(data)) {
                    globalWords = data.map(w => ({ ...w, ease_factor: w.ease_factor || 2.5, interval: w.interval || 0, repetitions: w.repetitions || 0 }));
                    await idbSaveWords(globalWords);
                }
                setTimeout(processSyncQueue, 500);
            } catch (e) {
                try {
                    const offDb = await idbGetWords();
                    if (offDb && offDb.length > 0) {
                        globalWords = offDb;
                        console.log("Loaded words from IndexedDB.");
                    } else {
                        const saved = localStorage.getItem('offline_words_db');
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            if (Array.isArray(parsed)) {
                                globalWords = parsed;
                                await idbSaveWords(globalWords);
                            }
                        }
                    }
                } catch (err) { }
            }
            if (!Array.isArray(globalWords)) globalWords = [];
            try {
                document.getElementById('folder-list').innerHTML = [...new Set(globalWords.map(w => w.folder))].filter(Boolean).map(f => `<option value="${escapeStr(f)}">`).join('');
                document.getElementById('level-list').innerHTML = [...new Set(globalWords.map(w => w.level).filter(Boolean))].map(l => `<option value="${escapeStr(l)}">`).join('');
                document.getElementById('subfolder-list').innerHTML = [...new Set(globalWords.map(w => w.subfolder))].filter(Boolean).map(s => `<option value="${escapeStr(s)}">`).join('');
            } catch (e) { }
        };

        async function switchView(target) {
            if (target !== 'train' && target !== 'practice') saveSessionTime();

            Object.keys(views).forEach(v => {
                const isActive = (v === target);
                views[v].classList.toggle('hidden', !isActive);
                navBtns[v].classList.toggle('active-tab', isActive);
                if (isActive) navBtns[v].classList.remove('text-gray-400'); else navBtns[v].classList.add('text-gray-400');
            });
            document.getElementById('header-title').innerText = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
            document.getElementById('add-btn').classList.toggle('hidden', target !== 'dict');

            await fetchWords();
            document.getElementById('header-title').innerText = { dict: '–°–ª–æ–≤–∞—Ä—å', train: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', practice: '–ü—Ä–∞–∫—Ç–∏–∫–∞', stats: '–ü—Ä–æ–≥—Ä–µ—Å—Å' }[target];

            try {
                if (target === 'dict') renderDict();
                if (target === 'train') setupTrainMenu();
                if (target === 'practice') { closePractice(); }
                if (target === 'stats') loadStats();
            } catch (e) { }
            window.scrollTo(0, 0);
        }

        navBtns.dict.onclick = () => switchView('dict');
        navBtns.train.onclick = () => switchView('train');
        navBtns.practice.onclick = () => switchView('practice');
        navBtns.stats.onclick = () => switchView('stats');

        window.selectArticle = (art) => {
            currentArticle = art;
            const btns = { der: document.getElementById('btn-art-der'), die: document.getElementById('btn-art-die'), das: document.getElementById('btn-art-das') };
            Object.values(btns).forEach(b => { b.className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-500 font-medium transition-all text-sm hover:bg-gray-100 dark:hover:bg-gray-700"; });
            if (art === 'der') btns.der.className = "flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium transition-all shadow-sm text-sm";
            else if (art === 'die') btns.die.className = "flex-1 py-2 rounded-lg border-2 border-red-500 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium transition-all shadow-sm text-sm";
            else if (art === 'das') btns.das.className = "flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-medium transition-all shadow-sm text-sm";
        };

        const wordInp = document.getElementById('word-de');
        wordInp.oninput = () => {
            if (currentType !== 'noun') return;
            const w = wordInp.value.trim().toLowerCase(); let g = null;
            if (w.match(/(ung|heit|keit|schaft|tion|t√§t|ik|ur|enz|anz|ie|e)$/)) g = 'die';
            else if (w.match(/(chen|lein|ment|um|ma|nis|o)$/)) g = 'das';
            else if (w.match(/(ismus|ling|ig|or|ist|ant|ent|er)$/)) g = 'der';
            if (g && currentArticle !== g) selectArticle(g);
        };

        document.getElementById('dict-tab-active').onclick = () => { dictTabFilter = 'active'; renderDictTabs(); };
        document.getElementById('dict-tab-mastered').onclick = () => { dictTabFilter = 'mastered'; renderDictTabs(); };
        function renderDictTabs() {
            document.getElementById('dict-tab-active').className = dictTabFilter === 'active' ? "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('dict-tab-mastered').className = dictTabFilter === 'mastered' ? "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all flex items-center justify-center gap-1 text-gray-900 dark:text-white" : "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 transition-all flex items-center justify-center gap-1 hover:text-gray-700 dark:hover:text-gray-300";
            renderDict();
        }

        const searchInp = document.getElementById('search-input');
        searchInp.oninput = () => { if (searchInp.value.trim().length > 0) collapsedDictTopics = {}; renderDict(searchInp.value.toLowerCase()); };
        window.toggleTopic = (topicKey) => { collapsedDictTopics[topicKey] = !collapsedDictTopics[topicKey]; renderDict(searchInp.value.toLowerCase()); };

        function renderDict(query = searchInp.value.toLowerCase()) {
            const container = document.getElementById('dict-list');
            try {
                let filtered = globalWords.filter(w => (w.word_de || "").toLowerCase().includes(query) || (w.word_ru || "").toLowerCase().includes(query));
                if (dictTabFilter === 'active') filtered = filtered.filter(w => w.score < MAX_SCORE);
                else filtered = filtered.filter(w => w.score >= MAX_SCORE);

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="text-center py-20"><p class="text-gray-400 font-medium text-sm">${dictTabFilter === 'mastered' ? '–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç üòî' : '–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Ç–µ–∫—É—â–∏–µ —Å–ª–æ–≤–∞ –≤—ã—É—á–µ–Ω—ã üéâ'}</p></div>`; return;
                }

                const colors = { der: 'text-der', die: 'text-die', das: 'text-das' };
                const grouped = {};
                filtered.forEach(w => {
                    const f = w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞'; const l = w.level || '–û–±—â–µ–µ'; const s = w.subfolder || '–ë–µ–∑ —Ç–µ–º—ã';
                    if (!grouped[f]) grouped[f] = {}; if (!grouped[f][l]) grouped[f][l] = {}; if (!grouped[f][l][s]) grouped[f][l][s] = [];
                    grouped[f][l][s].push(w);
                });

                let savedFolderOrder = []; let savedTopicOrder = {};
                try { savedFolderOrder = JSON.parse(localStorage.getItem('folderOrder')) || []; } catch (e) { }
                try { savedTopicOrder = JSON.parse(localStorage.getItem('topicOrder')) || {}; } catch (e) { }

                const folderNames = Object.keys(grouped).sort((a, b) => { let idxA = savedFolderOrder.indexOf(a); let idxB = savedFolderOrder.indexOf(b); if (idxA === -1) idxA = 9999; if (idxB === -1) idxB = 9999; return idxA - idxB; });

                let html = '<div id="dict-folders-container">';
                folderNames.forEach(f => {
                    const safeF = escapeStr(f);
                    html += `
                    <div class="dict-folder mb-6 bg-white dark:bg-gray-900 rounded-[1.5rem] shadow-sm border border-gray-100 dark:border-gray-800 overflow-hidden" data-folder="${safeF}">
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 p-4 border-b border-gray-100 dark:border-gray-800">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="cursor-move drag-handle-folder text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg></div>
                                <h2 class="text-base font-bold text-gray-900 dark:text-white truncate">${f}</h2>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <button onclick="renameFolder('${safeF}')" class="p-2 text-gray-400 hover:text-blue-500 transition-colors" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                <button onclick="fastAddCourse('${safeF}')" class="text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-blue-100 active:scale-95 transition-all">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="dict-topics-container p-2 space-y-2" data-folder="${safeF}">
                    `;

                    let topics = [];
                    for (const l in grouped[f]) { for (const s in grouped[f][l]) { topics.push({ l, s, words: grouped[f][l][s], key: `${f}|${l}|${s}` }); } }
                    topics.sort((a, b) => { let orderArr = savedTopicOrder[f] || []; let idxA = orderArr.indexOf(a.key); let idxB = orderArr.indexOf(b.key); if (idxA === -1) idxA = 9999; if (idxB === -1) idxB = 9999; return idxA - idxB; });

                    topics.forEach(t => {
                        const l = t.l; const s = t.s; const wordsInTopic = t.words; const topicKey = t.key;
                        const safeL = escapeStr(l); const safeS = escapeStr(s); const safeTopicKey = escapeStr(topicKey);
                        if (collapsedDictTopics[topicKey] === undefined) collapsedDictTopics[topicKey] = true;
                        const isCollapsed = collapsedDictTopics[topicKey]; const chevronClass = isCollapsed ? '' : 'rotate-180';

                        html += `
                        <div class="dict-topic bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 overflow-hidden transition-all" data-topic="${safeTopicKey}">
                            <div class="flex justify-between items-center p-3 pr-2 transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div class="flex items-center gap-2 min-w-0 flex-1">
                                    <div class="cursor-move drag-handle-topic text-gray-400 hover:text-gray-600 p-1 -ml-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg></div>
                                    <div class="flex items-center gap-2 min-w-0 flex-1 cursor-pointer" onclick="toggleTopic('${safeTopicKey}')">
                                        <svg class="w-4 h-4 text-gray-400 transition-transform ${chevronClass} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        ${l !== '–û–±—â–µ–µ' ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md flex-shrink-0 ${getLevelColor(l)}">${l}</span>` : ''}
                                        <h3 class="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">${s} <span class="text-gray-400 font-normal">(${wordsInTopic.length})</span></h3>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 pl-2">
                                    <button onclick="renameSubfolder('${safeF}', '${safeL}', '${safeS}'); event.stopPropagation();" class="p-1.5 text-gray-400 hover:text-blue-500 transition-colors" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–º—É"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                    <button onclick="fastAdd('${safeF}', '${safeL}', '${safeS}'); event.stopPropagation();" class="text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100 active:scale-95 transition-all">+ –°–ª–æ–≤–æ</button>
                                    <button onclick="deleteFolder('${safeF}', '${safeL}', '${safeS}'); event.stopPropagation();" class="text-red-400 p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-all" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>

                            <div class="${isCollapsed ? 'hidden' : 'p-2 space-y-1.5 bg-gray-50 dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800'}">
                        `;

                        wordsInTopic.forEach(w => {
                            let extraInfo = '';
                            if (w.word_type === 'noun' && w.plural) extraInfo = `(pl. ${w.plural})`;
                            else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) extraInfo = `(${w.praeteritum || '-'}, ${w.partizip || '-'})`;
                            const safeWordDe = escapeStr(w.word_de);

                            html += `
                            <div onclick="openEdit(${w.id})" class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 flex justify-between items-center active:scale-[0.99] transition-all cursor-pointer hover:border-blue-200">
                                <div class="flex-1 pr-3 min-w-0">
                                    <p class="text-base font-bold text-gray-900 dark:text-white leading-tight truncate">${w.word_type === 'noun' ? `<span class="${colors[w.article]} font-normal mr-1">${w.article}</span>` : ''}${w.word_de} <span class="text-gray-400 text-xs font-normal ml-1">${extraInfo}</span></p>
                                    <p class="text-gray-500 text-sm font-medium mt-0.5 truncate">${w.word_ru}</p>
                                   ${w.example ? `<p class="text-[11px] text-blue-500 dark:text-blue-400 mt-1.5 italic leading-tight truncate">"${escapeStr(w.example.split(/[-‚Äî(/\[]/)[0].trim())}"</p>` : ''}
                                </div>
                                <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                    <div class="flex gap-1 mb-1">
                                        <button onclick="speakWord('${(w.word_type === 'noun' ? w.article + ' ' : '') + safeWordDe}', event)" class="p-2 bg-gray-50 dark:bg-gray-700 rounded-full text-gray-400 hover:text-blue-500 transition-colors">üîä</button>
                                        <button onclick="deleteWord(${w.id}, event)" class="p-2 bg-gray-50 dark:bg-gray-700 rounded-full text-gray-400 hover:text-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                    <span class="text-xs font-bold ${w.score >= MAX_SCORE ? 'text-green-500' : (w.score >= 3 ? 'text-orange-500' : 'text-gray-400')}">${Math.min(w.score, MAX_SCORE)}/${MAX_SCORE}</span>
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    });
                    html += `</div></div>`;
                });
                html += '</div>';

                container.innerHTML = html;
                setTimeout(initSortable, 100);
            } catch (err) { container.innerHTML = `<div class="text-center py-20 text-red-500">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à.</div>`; }
        }

        function initSortable() {
            if (typeof Sortable === 'undefined') { setTimeout(initSortable, 500); return; }
            const folderContainer = document.getElementById('dict-folders-container');
            if (folderContainer) {
                new Sortable(folderContainer, {
                    handle: '.drag-handle-folder', animation: 250, delay: 150, delayOnTouchOnly: true, ghostClass: 'sortable-ghost',
                    onEnd: function () { const order = Array.from(folderContainer.querySelectorAll('.dict-folder')).map(el => el.dataset.folder); localStorage.setItem('folderOrder', JSON.stringify(order)); }
                });
            }
            document.querySelectorAll('.dict-topics-container').forEach(topicContainer => {
                new Sortable(topicContainer, {
                    handle: '.drag-handle-topic', animation: 250, delay: 150, delayOnTouchOnly: true, ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        const f = evt.item.closest('.dict-folder').dataset.folder;
                        const order = Array.from(topicContainer.querySelectorAll('.dict-topic')).map(el => el.dataset.topic);
                        let savedTopicOrder = {}; try { savedTopicOrder = JSON.parse(localStorage.getItem('topicOrder')) || {}; } catch (e) { }
                        savedTopicOrder[f] = order; localStorage.setItem('topicOrder', JSON.stringify(savedTopicOrder));
                    }
                });
            });
        }

        window.renameFolder = async (oldFolder) => {
            const newFolder = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∫—É—Ä—Å–∞ "${oldFolder}":`, oldFolder);
            if (newFolder && newFolder.trim() !== '' && newFolder.trim() !== oldFolder) {
                try { await apiFetch('/words/rename_folder', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_folder: oldFolder, new_folder: newFolder.trim() }) }); await fetchWords(); renderDict(); } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!'); }
            }
        };

        window.renameSubfolder = async (f, l, oldS) => {
            const newS = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–º—ã "${oldS}":`, oldS);
            if (newS && newS.trim() !== '' && newS.trim() !== oldS) {
                try {
                    await apiFetch('/words/rename_subfolder', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder: f, level: l, old_subfolder: oldS, new_subfolder: newS.trim() }) });
                    const oldKey = `${f}|${l}|${oldS}`; const newKey = `${f}|${l}|${newS.trim()}`;
                    if (collapsedDictTopics[oldKey] !== undefined) { collapsedDictTopics[newKey] = collapsedDictTopics[oldKey]; delete collapsedDictTopics[oldKey]; }
                    await fetchWords(); renderDict();
                } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!'); }
            }
        };

        const modal = document.getElementById('add-modal');
        const setType = (t) => {
            currentType = t;
            document.getElementById('type-noun').className = t === 'noun' ? "flex-1 py-2 text-xs font-bold uppercase tracking-wide rounded-md bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-2 text-xs font-bold uppercase tracking-wide text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('type-verb').className = t === 'verb' ? "flex-1 py-2 text-xs font-bold uppercase tracking-wide rounded-md bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-2 text-xs font-bold uppercase tracking-wide text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('article-selector').classList.toggle('hidden', t === 'verb');
            document.getElementById('plural-input-group').classList.toggle('hidden', t === 'verb');
            const verbGroup = document.getElementById('verb-forms-group');
            if (verbGroup) verbGroup.classList.toggle('hidden', t !== 'verb');
        };

        document.getElementById('type-noun').onclick = () => setType('noun');
        document.getElementById('type-verb').onclick = () => setType('verb');

        const showSingleTab = () => {
            document.getElementById('form-single').classList.remove('hidden'); document.getElementById('form-bulk').classList.add('hidden');
            document.getElementById('tab-single').className = "flex-1 py-2 text-sm font-medium rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white";
            document.getElementById('tab-bulk').className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
        };
        const showBulkTab = () => {
            document.getElementById('form-bulk').classList.remove('hidden'); document.getElementById('form-single').classList.add('hidden');
            document.getElementById('tab-bulk').className = "flex-1 py-2 text-sm font-bold rounded-lg bg-green-500 text-white shadow-md shadow-green-500/40 transition-all transform scale-[1.02]";
            document.getElementById('tab-single').className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
        };

        document.getElementById('tab-single').onclick = showSingleTab;
        document.getElementById('tab-bulk').onclick = showBulkTab;

        document.getElementById('add-btn').onclick = () => {
            editId = null; document.getElementById('modal-title').innerText = "–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ"; document.getElementById('add-form').reset(); checkDuplicate();
            document.getElementById('bulk-folder').value = ''; document.getElementById('bulk-level').value = ''; document.getElementById('bulk-subfolder').value = '';
            const bulkFile = document.getElementById('bulk-file'); if (bulkFile) bulkFile.value = '';
            const bulkLabel = document.getElementById('bulk-file-label'); if (bulkLabel) bulkLabel.innerText = '–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª';
            setType('noun'); showSingleTab(); selectArticle('der'); modal.classList.remove('hidden');
        };
        document.getElementById('close-modal').onclick = () => modal.classList.add('hidden');

        window.openEdit = (id) => {
            const w = globalWords.find(x => x.id === id); if (!w) return;
            editId = w.id; document.getElementById('modal-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"; showSingleTab();
            setType(w.word_type); if (w.word_type === 'noun') selectArticle(w.article || 'der');
            document.getElementById('word-de').value = w.word_de; document.getElementById('word-ru').value = w.word_ru; checkDuplicate();
            document.getElementById('word-plural').value = w.plural || ""; document.getElementById('word-praeteritum').value = w.praeteritum || "";
            document.getElementById('word-partizip').value = w.partizip || ""; document.getElementById('word-example').value = w.example || "";
            document.getElementById('word-folder').value = w.folder; document.getElementById('word-level').value = w.level || ""; document.getElementById('word-subfolder').value = w.subfolder;
            modal.classList.remove('hidden');
        };

        function checkDuplicate() {
            const val = document.getElementById('word-de').value.trim().toLowerCase();
            const warning = document.getElementById('duplicate-warning');
            if (!val) { warning.classList.add('hidden'); return; }

            const duplicateWord = globalWords.find(w => w.word_de.toLowerCase() === val && (!editId || w.id !== editId));
            if (duplicateWord) {
                const iconSVG = `<svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
                warning.innerHTML = `${iconSVG}<span>–£–∂–µ –µ—Å—Ç—å: <b>${duplicateWord.word_ru}</b> (–ö—É—Ä—Å: ${duplicateWord.folder} / ${duplicateWord.subfolder})</span>`;
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        document.getElementById('word-de').addEventListener('input', checkDuplicate);

        // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–í–û–î –ò –ü–û–î–°–¢–ê–ù–û–í–ö–ê –ê–†–¢–ò–ö–õ–ï–ô ---
        async function autoTranslate(sourceInput, targetInput, isSourceRu) {
            const query = sourceInput.value.trim();
            if (!query) return;
            // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–µ –ø–æ–ª–µ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º (—É–≤–∞–∂–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥)
            if (targetInput.value.trim().length > 0) return;

            const loaderId = isSourceRu ? 'translate-loader-de' : 'translate-loader-ru';
            const loader = document.getElementById(loaderId);
            if (loader) loader.classList.remove('hidden');

            try {
                // –ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ Google Translate (–Ω–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π, –Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–π endpoint)
                const sl = isSourceRu ? 'ru' : 'de';
                const tl = isSourceRu ? 'de' : 'ru';
                const translateUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(query)}`;

                const res = await fetch(translateUrl);
                const data = await res.json();
                let translated = data[0][0][0];
                targetInput.value = translated;

                // –ï—Å–ª–∏ –º—ã –ø–µ—Ä–µ–≤–µ–ª–∏ –Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π (–∏–ª–∏ —Å –Ω–µ–º–µ—Ü–∫–æ–≥–æ), –ø–æ–ø—ã—Ç–∞–µ–º—Å—è —É–∑–Ω–∞—Ç—å —Ä–æ–¥ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ
                let deWord = isSourceRu ? translated : query;
                if (deWord) {
                    try {
                        const wikUrl = `https://de.wiktionary.org/w/api.php?origin=*&action=query&prop=revisions&rvprop=content&titles=${encodeURIComponent(deWord)}&format=json`;
                        const wikRes = await fetch(wikUrl, { headers: { 'User-Agent': 'OsmanovDictTool/1.0 (osmanov@example.com)' } });
                        const wikData = await wikRes.json();
                        const pages = wikData.query.pages;
                        const pageId = Object.keys(pages)[0];

                        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞–≤–∏–º der, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–º –Ω–∏—á–µ–≥–æ
                        let genus = 'der';
                        let plural = '';

                        if (pageId !== '-1') {
                            const content = pages[pageId].revisions[0]['*'];

                            // 1. –ò—â–µ–º —Ä–æ–¥ (Genus)
                            const genusMatch = content.match(/\{\{Genus\|([mfn])\}\}/) || content.match(/\{\{([mfn])\}\}/);
                            if (genusMatch) {
                                const g = genusMatch[1];
                                if (g === 'm') genus = 'der';
                                else if (g === 'f') genus = 'die';
                                else if (g === 'n') genus = 'das';
                            } else {
                                if (content.includes('{{m}}')) genus = 'der';
                                else if (content.includes('{{f}}')) genus = 'die';
                                else if (content.includes('{{n}}')) genus = 'das';
                                else if (deWord.endsWith('chen') || deWord.endsWith('lein') || deWord.endsWith('ment') || deWord.endsWith('um')) genus = 'das';
                                else if (deWord.endsWith('ung') || deWord.endsWith('keit') || deWord.endsWith('heit') || deWord.endsWith('schaft') || deWord.endsWith('tion') || deWord.endsWith('t√§t') || deWord.endsWith('ik') || deWord.endsWith('ie') || deWord.endsWith('ur') || deWord.endsWith('enz') || deWord.endsWith('anz')) genus = 'die';
                                else if (deWord.endsWith('er') || deWord.endsWith('ig') || deWord.endsWith('ling') || deWord.endsWith('ismus')) genus = 'der';
                            }
                            selectArticle(genus);

                            // 2. –ò—â–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ (Plural)
                            const pMatch = content.match(/Nominativ Plural\s*=\s*([^<\n\|\}]+)/);
                            if (pMatch) {
                                plural = pMatch[1].trim();
                                if (plural.startsWith('die ')) plural = plural.substring(4);
                                const pluralInput = document.getElementById('word-plural');
                                if (pluralInput && !pluralInput.value) {
                                    pluralInput.value = plural;
                                }
                            }

                            // 3. –ò—â–µ–º —Ñ–æ—Ä–º—ã –≥–ª–∞–≥–æ–ª–æ–≤ (Pr√§teritum, Partizip II)
                            const praetMatch = content.match(/Pr√§teritum_ich=([^<\n\|\}]+)/);
                            const partMatch = content.match(/Partizip II=([^<\n\|\}]+)/);

                            if (praetMatch || partMatch) {
                                // –≠—Ç–æ –≥–ª–∞–≥–æ–ª!
                                setType('verb');
                                if (praetMatch) {
                                    const praetInput = document.getElementById('word-praeteritum');
                                    if (praetInput && !praetInput.value) praetInput.value = praetMatch[1].trim();
                                }
                                if (partMatch) {
                                    const partInput = document.getElementById('word-partizip');
                                    if (partInput && !partInput.value) partInput.value = partMatch[1].trim();
                                }
                            } else {
                                // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ä–º –≥–ª–∞–≥–æ–ª–∞, —Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –¥—Ä. –æ—Å—Ç–∞–≤–∏–º noun
                                setType('noun');
                                selectArticle(genus);
                            }

                            // 4. –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (Beispiel)
                            const examplesBlock = content.split('{{Beispiele}}')[1] || content.split('==== Beispiele ====\n')[1];
                            if (examplesBlock) {
                                const lines = examplesBlock.split('\n');
                                for (let line of lines) {
                                    if (line.match(/^:\[\d+\]\s/)) {
                                        let text = line.replace(/^:\[\d+\]\s*/, '');
                                        text = text.replace(/\{\{[^}]+\}\}/g, '').trim();
                                        text = text.replace(/'''/g, '');
                                        text = text.replace(/''/g, '');
                                        text = text.replace(/<ref.*?<\/ref>/g, '');
                                        const exampleInput = document.getElementById('word-example');
                                        if (exampleInput && !exampleInput.value) exampleInput.value = text.trim();
                                        break;
                                    }
                                    if (line.includes('{{Wortbildung}}') || line.includes('{{√úbersetzungen}}')) break;
                                }
                            }
                        }
                    } catch (e) { console.log('Wiktionary error', e); }
                }

                checkDuplicate(); // –û–±–Ω–æ–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
            } catch (err) {
                console.error("Translation error:", err);
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        document.getElementById('word-ru').addEventListener('blur', () => {
            autoTranslate(document.getElementById('word-ru'), document.getElementById('word-de'), true);
        });

        document.getElementById('word-de').addEventListener('blur', () => {
            autoTranslate(document.getElementById('word-de'), document.getElementById('word-ru'), false);
        });

        window.fastAdd = (folder, level, subfolder) => {
            editId = null; document.getElementById('modal-title').innerText = "–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ"; document.getElementById('add-form').reset(); setType('noun'); showSingleTab(); selectArticle('der');
            checkDuplicate();
            const lvl = level === '–û–±—â–µ–µ' ? '' : level;
            document.getElementById('word-folder').value = folder; document.getElementById('word-level').value = lvl; document.getElementById('word-subfolder').value = subfolder;
            document.getElementById('bulk-folder').value = folder; document.getElementById('bulk-level').value = lvl; document.getElementById('bulk-subfolder').value = subfolder;
            modal.classList.remove('hidden'); setTimeout(() => document.getElementById('word-de').focus(), 150);
        };

        window.fastAddCourse = (folder) => {
            editId = null; document.getElementById('modal-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É / —Å–ª–æ–≤–∞"; document.getElementById('add-form').reset(); setType('noun'); showSingleTab(); selectArticle('der');
            checkDuplicate();
            document.getElementById('word-folder').value = folder; document.getElementById('word-level').value = ''; document.getElementById('word-subfolder').value = '';
            document.getElementById('bulk-folder').value = folder; document.getElementById('bulk-level').value = ''; document.getElementById('bulk-subfolder').value = '';
            modal.classList.remove('hidden'); setTimeout(() => document.getElementById('word-subfolder').focus(), 150);
        };

        window.deleteWord = async (id, event) => {
            if (event) event.stopPropagation();
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –Ω–∞–≤—Å–µ–≥–¥–∞?')) { await apiFetch(`${API_URL}/${id}`, { method: 'DELETE' }); await fetchWords(); renderDict(); }
        };

        window.deleteFolder = async (f, l, s) => {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É "${s}" —Å–æ –≤—Å–µ–º–∏ —Å–ª–æ–≤–∞–º–∏ –≤–Ω—É—Ç—Ä–∏?`)) { await apiFetch('/words/delete_folder', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder: f, level: l, subfolder: s }) }); await fetchWords(); renderDict(); }
        };

        document.getElementById('add-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                word_type: currentType, article: currentType === 'noun' ? currentArticle : '',
                word_de: document.getElementById('word-de').value.trim(), plural: currentType === 'noun' ? document.getElementById('word-plural').value.trim() : '',
                praeteritum: currentType === 'verb' ? document.getElementById('word-praeteritum').value.trim() : '', partizip: currentType === 'verb' ? document.getElementById('word-partizip').value.trim() : '',
                word_ru: document.getElementById('word-ru').value.trim(), example: document.getElementById('word-example').value.trim(),
                folder: document.getElementById('word-folder').value.trim(), level: document.getElementById('word-level').value.trim(), subfolder: document.getElementById('word-subfolder').value.trim()
            };
            const url = editId ? `${API_URL}/${editId}/full` : API_URL;
            await apiFetch(url, { method: editId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            modal.classList.add('hidden'); searchInp.value = '';
            const newTopicKey = `${payload.folder}|${payload.level || '–û–±—â–µ–µ'}|${payload.subfolder}`; collapsedDictTopics[newTopicKey] = false;
            await fetchWords(); renderDict();
        };

        document.getElementById('btn-upload-csv').onclick = async () => {
            const f = new FormData();
            const folder = document.getElementById('bulk-folder').value.trim(); const level = document.getElementById('bulk-level').value.trim(); const subfolder = document.getElementById('bulk-subfolder').value.trim(); const fileInput = document.getElementById('bulk-file');
            if (!folder || !subfolder || !fileInput.files[0]) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫—É—Ä—Å, —Ç–µ–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");
            f.append('folder', folder); f.append('level', level); f.append('subfolder', subfolder); f.append('file', fileInput.files[0]);
            const btn = document.getElementById('btn-upload-csv'); btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...'; btn.disabled = true;
            try {
                await apiFetch('/upload_csv', { method: 'POST', body: f }); modal.classList.add('hidden');
                const newTopicKey = `${folder}|${level || '–û–±—â–µ–µ'}|${subfolder}`; collapsedDictTopics[newTopicKey] = false;
                await fetchWords(); renderDict();
            } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!"); }
            finally { btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞'; btn.disabled = false; }
        };

        document.getElementById('bulk-file').onchange = function () {
            const label = document.getElementById('bulk-file-label');
            if (this.files[0]) label.innerText = this.files[0].name; else label.innerText = '–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª';
        };

        window.exportData = async () => {
            const btn = document.getElementById('btn-trigger-export');
            const prevText = btn.innerHTML;
            btn.innerHTML = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...'; btn.disabled = true;
            try {
                const res = await apiFetch(`/export_csv`);
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_${currentUser}.csv`;
                document.body.appendChild(a); a.click(); a.remove();
            } catch (e) { alert("–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏!"); }
            finally { btn.innerHTML = prevText; btn.disabled = false; }
        };

        document.getElementById('file-restore').onchange = async function () {
            if (!this.files[0]) return;
            const btn = document.getElementById('btn-trigger-restore');
            btn.innerHTML = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...'; btn.disabled = true;
            const f = new FormData(); f.append('file', this.files[0]);
            try {
                await apiFetch('/restore_backup', { method: 'POST', body: f });
                document.getElementById('backup-modal').classList.add('hidden');
                await fetchWords(); renderDict(); switchView('dict');
            } catch (e) { alert("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!"); }
            finally { btn.innerHTML = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞'; btn.disabled = false; this.value = ''; }
        };

        let trainList = []; let curIdx = 0; let cardTimeout = null;

        window.setDirection = (dir) => {
            trainDirection = dir;
            const activeCls = "flex-1 py-2 text-[10px] font-bold rounded-lg bg-white dark:bg-gray-700 text-blue-500 shadow-sm transition-all uppercase";
            const inactiveCls = "flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 transition-all uppercase hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('dir-auto').className = dir === 'auto' ? activeCls : inactiveCls;
            document.getElementById('dir-ru-de').className = dir === 'ru-de' ? activeCls : inactiveCls;
            document.getElementById('dir-de-ru').className = dir === 'de-ru' ? activeCls : inactiveCls;
        };

        function setupTrainMenu() {
            const container = document.getElementById('train-topics-container');
            try {
                container.innerHTML = '';
                const availableCount = globalWords.filter(w => isWordDue(w)).length;
                const masteredCount = globalWords.filter(w => w.score >= MAX_SCORE).length;
                const waitingCount = globalWords.filter(w => !isWordDue(w)).length;
                const weakWordsCount = globalWords.filter(w => w.score < 2 && isWordDue(w)).length;

                let html = `
                    <button onclick="startTraining('all')" class="w-full text-left bg-gradient-to-br from-blue-500 to-indigo-600 hover:scale-[0.98] transition-all p-5 rounded-2xl shadow-md text-white flex justify-between items-center group mb-3">
                        <div>
                            <h3 class="text-lg font-bold">–°–ª–æ–≤–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                            <p class="text-blue-100 text-[11px] font-medium mt-1">–î–æ—Å—Ç—É–ø–Ω–æ: ${availableCount} ${waitingCount > 0 ? `| –û–∂–∏–¥–∞—é—Ç: ${waitingCount}` : ''}</p>
                        </div>
                        <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                    </button>
                `;

                if (weakWordsCount > 0) {
                    html += `
                        <button onclick="startTraining('weak')" class="w-full text-left bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800/50 hover:scale-[0.98] transition-all p-4 rounded-xl flex justify-between items-center group mb-3">
                            <div>
                                <h3 class="text-orange-700 dark:text-orange-400 text-sm font-bold">–°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞</h3>
                                <p class="text-orange-600/70 dark:text-orange-500/70 text-[10px] font-medium mt-0.5">–ù–æ–≤—ã–µ –∏–ª–∏ –∑–∞–±—ã—Ç—ã–µ: ${weakWordsCount}</p>
                            </div>
                            <div class="text-orange-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>
                        </button>
                    `;
                }

                if (masteredCount > 0) {
                    html += `
                        <button onclick="startTraining('mastered')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center group mb-3">
                            <div>
                                <h3 class="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2">üèÜ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞—Ä—Ö–∏–≤</h3>
                                <p class="text-gray-500 text-[10px] font-medium mt-0.5">–ò–∑—É—á–µ–Ω–æ: ${masteredCount}</p>
                            </div>
                            <div class="text-gray-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        </button>
                    `;
                }

                const groupedTopics = {};
                globalWords.forEach(w => {
                    const f = w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞'; const key = `${w.folder}|${w.level || '–û–±—â–µ–µ'}|${w.subfolder}`;
                    if (!groupedTopics[f]) groupedTopics[f] = new Set(); groupedTopics[f].add(key);
                });

                const activeTopicsHTML = []; const masteredTopicsHTML = [];

                for (const folder in groupedTopics) {
                    const courseWords = globalWords.filter(w => (w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞') === folder);
                    const cWordsCount = courseWords.filter(w => isWordDue(w)).length;

                    let folderActiveHTML = '';
                    if (cWordsCount > 0) {
                        folderActiveHTML += `
                            <button onclick="startTraining('course|${escapeStr(folder)}')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-2 mt-4 flex justify-between items-center group">
                                <div>
                                    <h3 class="text-sm font-bold text-gray-900 dark:text-white">${folder} (–í–µ—Å—å –∫—É—Ä—Å)</h3>
                                    <p class="text-[11px] text-gray-500 font-medium mt-0.5">–î–æ—Å—Ç—É–ø–Ω–æ: ${cWordsCount}</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700 w-8 h-8 rounded-full flex items-center justify-center text-gray-400"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                            </button>
                        `;
                    } else {
                        folderActiveHTML += `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-5 mb-2 ml-1">${folder}</h3>`;
                    }

                    let folderMasteredHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-5 mb-2 ml-1">${folder}</h3>`;
                    let hasActive = false; let hasMastered = false;

                    groupedTopics[folder].forEach(t => {
                        const [f, l, s] = t.split('|');
                        const allInTopic = globalWords.filter(w => w.folder === f && (w.level || '–û–±—â–µ–µ') === l && w.subfolder === s);
                        const wordsCount = allInTopic.filter(w => isWordDue(w)).length;
                        const waitingCount = allInTopic.filter(w => !isWordDue(w)).length;
                        const archivedCount = allInTopic.filter(w => w.score >= MAX_SCORE).length;

                        if (wordsCount === 0 && waitingCount === 0 && archivedCount > 0) {
                            hasMastered = true;
                            folderMasteredHTML += `
                                <button onclick="startTraining('${escapeStr(t)}', true)" class="w-full text-left bg-gray-50 dark:bg-gray-800/40 hover:scale-[0.98] transition-all p-3 rounded-lg border border-gray-100 dark:border-gray-800 flex justify-between items-center mb-1.5 opacity-70">
                                    <div>
                                        <div class="flex items-center gap-2 mb-0.5"><h3 class="text-sm font-medium text-gray-600 dark:text-gray-400 line-through">${s}</h3></div>
                                        <p class="text-xs text-gray-400">–í –∞—Ä—Ö–∏–≤–µ: ${archivedCount}</p>
                                    </div>
                                    <div class="text-green-500">‚úì</div>
                                </button>
                            `;
                        } else {
                            hasActive = true;
                            folderActiveHTML += `
                                <button onclick="startTraining('${escapeStr(t)}')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-3 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center mb-1.5 ml-2 w-[calc(100%-8px)]">
                                    <div>
                                        <div class="flex items-center gap-2 mb-0.5">
                                            ${l !== '–û–±—â–µ–µ' ? `<span class="text-[10px] font-bold px-1.5 py-0.5 rounded-md ${getLevelColor(l)}">${l}</span>` : ''}
                                            <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">${s}</h3>
                                        </div>
                                        <p class="text-xs text-gray-500">–°–ª–æ–≤: ${wordsCount} <span class="opacity-60">${waitingCount > 0 ? `| –û–∂–∏–¥–∞—é—Ç: ${waitingCount}` : ''}</span></p>
                                    </div>
                                    <div class="text-gray-400"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                                </button>
                            `;
                        }
                    });

                    if (hasActive) activeTopicsHTML.push(folderActiveHTML);
                    if (hasMastered) masteredTopicsHTML.push(folderMasteredHTML);
                }

                container.innerHTML = html + activeTopicsHTML.join('') + (masteredTopicsHTML.length > 0 ? '<div class="mt-6 border-t border-gray-200 dark:border-gray-800 pt-4"></div><h2 class="text-sm font-bold text-center text-gray-500 mb-3">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ç–µ–º—ã</h2>' + masteredTopicsHTML.join('') : '');
                document.getElementById('train-setup-block').classList.remove('hidden'); document.getElementById('train-card-block').classList.add('hidden');
            } catch (err) { }
        }

        window.startTraining = (sel, forceArchive = false) => {
            let availableWords = globalWords.filter(w => isWordDue(w));

            if (sel === 'all') { trainList = availableWords; }
            else if (sel === 'weak') { trainList = availableWords.filter(w => w.score < 2); }
            else if (sel.startsWith('course|')) { const courseName = sel.split('|')[1]; trainList = availableWords.filter(w => (w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞') === courseName); }
            else if (sel === 'mastered' || forceArchive) {
                if (forceArchive) { const [f, l, s] = sel.split('|'); trainList = globalWords.filter(w => w.folder === f && (w.level || '–û–±—â–µ–µ') === l && w.subfolder === s); }
                else { trainList = globalWords.filter(w => w.score >= MAX_SCORE); }
            }
            else { const [f, l, s] = sel.split('|'); trainList = availableWords.filter(w => w.folder === f && (w.level || '–û–±—â–µ–µ') === l && w.subfolder === s); }

            if (!trainList.length) return alert('–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Å–ª–æ–≤ –Ω–µ—Ç! –û—Ç–¥—ã—Ö–∞–π.');
            trainList.sort(() => 0.5 - Math.random()); curIdx = 0; sessionStartMs = Date.now();
            document.getElementById('train-setup-block').classList.add('hidden'); document.getElementById('train-card-block').classList.remove('hidden'); renderCard();
        };

        document.getElementById('btn-stop-training').onclick = () => {
            if (cardTimeout) clearTimeout(cardTimeout);
            saveSessionTime(); setupTrainMenu();
        };

        function renderCard() {
            const cardBlock = document.getElementById('train-card-block');
            cardBlock.classList.remove('animate-fold-up');

            if (curIdx >= trainList.length) {
                saveSessionTime(); document.getElementById('main-scroll').scrollTo(0, 0); setupTrainMenu(); return;
            }

            const w = trainList[curIdx];
            const qEl = document.getElementById('train-question'); const exQ = document.getElementById('train-example-q'); const badge = document.getElementById('train-level-badge');

            document.getElementById('train-total-cards').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${trainList.length - curIdx}`;
            document.getElementById('train-card-progress-text').innerText = `–û—Å–≤–æ–µ–Ω–æ: ${Math.min(w.score, MAX_SCORE)}/${MAX_SCORE}`;
            document.getElementById('train-card-progress-fill').style.width = `${Math.min(100, (w.score / MAX_SCORE) * 100)}%`;

            document.getElementById('train-answer-block').classList.add('hidden'); document.getElementById('train-manual-block').classList.add('hidden');
            document.getElementById('btn-show-answer').classList.add('hidden'); document.getElementById('manual-feedback').classList.add('hidden');
            document.getElementById('train-de-plural').classList.add('hidden');
            if (exQ) {
                exQ.classList.add('hidden');
                exQ.className = "text-sm text-blue-500 dark:text-blue-400 italic mb-5 hidden text-center w-full";
            }

            const manArt = document.getElementById('manual-article'); const manMain = document.getElementById('manual-main');
            const manPluralContainer = document.getElementById('manual-plural-container'); const manPlural = document.getElementById('manual-plural');
            const manVerbContainer = document.getElementById('manual-verb-forms-container'); const manPraet = document.getElementById('manual-praeteritum'); const manPart = document.getElementById('manual-partizip');
            const btnCheck = document.getElementById('btn-check-manual'); const umlautBar = document.getElementById('train-umlauts');
            const btnSpeakQ = document.getElementById('btn-speak-question'); const btnSpeakAns = document.getElementById('btn-speak-answer'); const btnMic = document.getElementById('btn-mic');

            if (manArt) manArt.disabled = false; if (manMain) manMain.disabled = false; if (manPlural) manPlural.disabled = false;
            if (manPraet) manPraet.disabled = false; if (manPart) manPart.disabled = false; if (btnCheck) btnCheck.disabled = false;

            const fullGerman = (w.word_type === 'noun' ? (w.article || '') + ' ' : '') + (w.word_de || '');
            let state = w.score < (MAX_SCORE - 1) ? 'L1' : w.score < MAX_SCORE ? 'L2' : 'Archive';

            if (trainDirection === 'de-ru') currentIsGermanQuestion = true;
            else if (trainDirection === 'ru-de') currentIsGermanQuestion = false;
            else currentIsGermanQuestion = state === 'L2' ? false : Math.random() > 0.5;

            if (currentIsGermanQuestion) {
                if (btnSpeakQ) { btnSpeakQ.classList.remove('hidden'); btnSpeakQ.onclick = (e) => speakWord(fullGerman, e); }
                if (btnSpeakAns) btnSpeakAns.classList.add('hidden');
            } else {
                if (btnSpeakQ) btnSpeakQ.classList.add('hidden');
                if (btnSpeakAns) { btnSpeakAns.classList.remove('hidden'); btnSpeakAns.onclick = (e) => speakWord(fullGerman, e); }
            }

            if (recognition && btnMic) {
                btnMic.classList.remove('hidden');
                btnMic.onclick = () => {
                    recognition.lang = currentIsGermanQuestion ? 'ru-RU' : 'de-DE'; recognition.start();
                    btnMic.classList.add('text-red-500', 'animate-pulse'); btnMic.classList.remove('text-gray-400');
                };
                recognition.onresult = (event) => {
                    let transcript = event.results[0][0].transcript.replace(/[.,!?]$/, '').trim();
                    if (!currentIsGermanQuestion && w.word_type === 'noun') {
                        const parts = transcript.split(' '); const art = parts[0].toLowerCase();
                        if (['der', 'die', 'das'].includes(art)) { manArt.value = art; manMain.value = parts.slice(1).join(' '); } else manMain.value = transcript;
                    } else manMain.value = transcript;
                };
                recognition.onend = () => { btnMic.classList.remove('text-red-500', 'animate-pulse'); btnMic.classList.add('text-gray-400'); };
                recognition.onerror = () => { btnMic.classList.remove('text-red-500', 'animate-pulse'); btnMic.classList.add('text-gray-400'); };
            } else if (btnMic) { btnMic.classList.add('hidden'); }

            const ansEx = document.getElementById('train-answer-example');
            if (w.example && ansEx) { ansEx.innerText = '"' + extractGermanSentence(w.example) + '"'; ansEx.classList.remove('hidden'); } else if (ansEx) ansEx.classList.add('hidden');

            document.getElementById('train-de-word').innerText = currentIsGermanQuestion ? (w.word_ru || '') : fullGerman;
            if (w.word_type === 'noun' && w.plural) document.getElementById('train-de-plural').innerText = `–º–Ω. —á.: die ${w.plural}`;
            else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) document.getElementById('train-de-plural').innerText = `–§–æ—Ä–º—ã: ${w.praeteritum || '-'}, ${w.partizip || '-'}`;

            if (state === 'L1' || state === 'Archive') {
                if (badge) {
                    if (state === 'Archive') { badge.innerText = "–ê—Ä—Ö–∏–≤"; badge.className = "px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-gray-100 dark:bg-gray-800 text-gray-500"; }
                    else { badge.innerText = `–£–∑–Ω–∞–≤–∞–Ω–∏–µ (${w.score}/${MAX_SCORE})`; badge.className = "px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400"; }
                }
                if (qEl) qEl.innerText = currentIsGermanQuestion ? fullGerman : (w.word_ru || '');
                document.getElementById('btn-show-answer').classList.remove('hidden');

                document.getElementById('btn-forgot').onclick = () => updateScoreWithSM2(0);
                document.getElementById('btn-remembered').onclick = () => updateScoreWithSM2(4);

                const goodCalc = calculateSM2(4, w.repetitions, w.interval, w.ease_factor, w.score);
                document.getElementById('sm2-good-time').innerText = formatInterval(goodCalc.interval);

            } else if (state === 'L2') {
                if (badge) { badge.innerText = `–ü–∏—Å—å–º–æ (–§–∏–Ω–∞–ª)`; badge.className = "px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400"; }
                if (qEl) qEl.innerText = currentIsGermanQuestion ? fullGerman : (w.word_ru || '');
                if (!currentIsGermanQuestion && w.example && exQ) {
                    try {
                        const deSentence = extractGermanSentence(w.example);
                        const safeWord = (w.word_de || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        exQ.innerHTML = escapeStr(deSentence).replace(new RegExp(safeWord, 'ig'), '_____');
                    } catch (e) { exQ.innerHTML = escapeStr(w.example); }
                    exQ.classList.remove('hidden');
                }

                document.getElementById('train-manual-block').classList.remove('hidden');

                if (currentIsGermanQuestion) {
                    if (manArt) manArt.classList.add('hidden');
                    if (manMain) { manMain.value = ''; manMain.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥..."; }
                    if (manPluralContainer) manPluralContainer.classList.add('hidden'); if (manVerbContainer) manVerbContainer.classList.add('hidden'); if (umlautBar) umlautBar.classList.add('hidden');
                    setTimeout(() => { if (manMain) manMain.focus() }, 150);
                } else {
                    if (manArt) { manArt.classList.remove('hidden'); manArt.classList.toggle('hidden', w.word_type === 'verb'); manArt.value = ''; }
                    if (manMain) { manMain.value = ''; manMain.placeholder = "–°–ª–æ–≤–æ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º..."; }
                    if (w.word_type === 'noun' && w.plural) { if (manPluralContainer) manPluralContainer.classList.remove('hidden'); if (manPlural) manPlural.value = ''; } else { if (manPluralContainer) manPluralContainer.classList.add('hidden'); }
                    if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) { if (manVerbContainer) manVerbContainer.classList.remove('hidden'); if (manPraet) manPraet.value = ''; if (manPart) manPart.value = ''; } else { if (manVerbContainer) manVerbContainer.classList.add('hidden'); }
                    if (umlautBar) umlautBar.classList.remove('hidden');
                    setTimeout(() => { const target = w.word_type === 'noun' ? document.getElementById('manual-article') : document.getElementById('manual-main'); if (target) target.focus(); }, 150);
                }
            }
        }

        async function updateScoreWithSM2(quality) {
            const cardBlock = document.getElementById('train-card-block');
            cardBlock.classList.add('animate-fold-up');

            const w = trainList[curIdx];

            // –¢–£–†–ë–û: –ï—Å–ª–∏ –∑–∞–±—ã–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∫–æ–Ω–µ—Ü –∫–æ–ª–æ–¥—ã
            if (quality === 0) {
                trainList.push(w);
            }

            const sm2Result = calculateSM2(quality, w.repetitions, w.interval, w.ease_factor, w.score);

            let nextReviewMs = 0;
            if (sm2Result.interval === 0) nextReviewMs = Date.now() + 10 * 60 * 1000;
            else nextReviewMs = Date.now() + sm2Result.interval * 24 * 60 * 60 * 1000;

            let newScore = w.score;
            if (quality >= 3) newScore = Math.min(w.score + 1, MAX_SCORE);
            else newScore = 0;

            try {
                await apiFetch(`${API_URL}/${w.id}/score`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score: newScore, next_review: nextReviewMs, ease_factor: sm2Result.easeFactor, interval: sm2Result.interval, repetitions: sm2Result.repetitions })
                });
            } catch (e) { }

            w.score = newScore;
            w.next_review = nextReviewMs;
            w.ease_factor = sm2Result.easeFactor;
            w.interval = sm2Result.interval;
            w.repetitions = sm2Result.repetitions;

            const gwItem = globalWords.find(gw => gw.id === w.id);
            if (gwItem && gwItem !== w) {
                gwItem.score = newScore; gwItem.next_review = nextReviewMs;
                gwItem.ease_factor = sm2Result.easeFactor; gwItem.interval = sm2Result.interval; gwItem.repetitions = sm2Result.repetitions;
            }

            idbSaveWords(globalWords); // Persist to IndexedDB immediately for offline reliability
            curIdx++; setTimeout(renderCard, 250);
        }

        document.getElementById('btn-show-answer').onclick = () => {
            document.getElementById('btn-show-answer').classList.add('hidden'); document.getElementById('train-answer-block').classList.remove('hidden');
            const w = trainList[curIdx]; if (w.word_type === 'noun' && w.plural) document.getElementById('train-de-plural').classList.remove('hidden'); else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) document.getElementById('train-de-plural').classList.remove('hidden');
        };

        document.getElementById('btn-check-manual').onclick = () => {
            const w = trainList[curIdx];
            const art = (document.getElementById('manual-article').value || "").trim().toLowerCase();
            const main = (document.getElementById('manual-main').value || "").trim();
            const typedPlural = (document.getElementById('manual-plural').value || "").trim().toLowerCase();
            const typedPraet = (document.getElementById('manual-praeteritum').value || "").trim().toLowerCase();
            const typedPart = (document.getElementById('manual-partizip').value || "").trim().toLowerCase();

            const feedback = document.getElementById('manual-feedback'); const btnCheck = document.getElementById('btn-check-manual');
            let isCorrect = false; let correctAnswer = "";

            if (!currentIsGermanQuestion) {
                const expectedArt = (w.article ? w.article.toLowerCase() : ""); const expectedWord = (w.word_de ? w.word_de.toLowerCase() : "");
                const expectedPlural = (w.plural ? w.plural.toLowerCase() : ""); const expectedPraet = (w.praeteritum ? w.praeteritum.toLowerCase() : ""); const expectedPart = (w.partizip ? w.partizip.toLowerCase() : "");

                if (w.word_type === 'noun') {
                    if (w.plural) { isCorrect = (art === expectedArt) && (main.toLowerCase() === expectedWord) && (typedPlural === expectedPlural); correctAnswer = `${w.article} ${w.word_de} (die ${w.plural})`; }
                    else { isCorrect = (art === expectedArt) && (main.toLowerCase() === expectedWord); correctAnswer = `${w.article} ${w.word_de}`; }
                } else if (w.word_type === 'verb') {
                    let baseCorrect = (main.toLowerCase() === expectedWord); let formsCorrect = true;
                    if (w.praeteritum || w.partizip) { formsCorrect = (typedPraet === expectedPraet) && (typedPart === expectedPart); correctAnswer = `${w.word_de} (${w.praeteritum}, ${w.partizip})`; }
                    else { correctAnswer = w.word_de; }
                    isCorrect = baseCorrect && formsCorrect;
                } else { isCorrect = main.toLowerCase() === expectedWord; correctAnswer = w.word_de; }
            } else { const expectedWord = (w.word_ru ? w.word_ru.toLowerCase() : ""); isCorrect = main.toLowerCase() === expectedWord; correctAnswer = w.word_ru; }

            document.getElementById('manual-article').disabled = true; document.getElementById('manual-main').disabled = true; document.getElementById('manual-plural').disabled = true; document.getElementById('manual-praeteritum').disabled = true; document.getElementById('manual-partizip').disabled = true; btnCheck.disabled = true;
            feedback.className = "w-full text-center py-3 rounded-xl font-medium text-sm mb-3 transition-all animate-in fade-in zoom-in duration-200 border";

            if (isCorrect) {
                const nextCalc = calculateSM2(4, w.repetitions, w.interval, w.ease_factor, w.score);
                feedback.classList.add('bg-green-50', 'text-green-600', 'border-green-200', 'dark:bg-green-900/20', 'dark:border-green-800'); feedback.innerText = `–í–µ—Ä–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑: ${formatInterval(nextCalc.interval)}`; feedback.classList.remove('hidden');
                cardTimeout = setTimeout(() => updateScoreWithSM2(4), 1200);
            } else {
                feedback.classList.add('bg-red-50', 'text-red-600', 'border-red-200', 'dark:bg-red-900/20', 'dark:border-red-800'); feedback.innerText = `–û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correctAnswer}`; feedback.classList.remove('hidden');
                cardTimeout = setTimeout(() => updateScoreWithSM2(0), 2500);
            }
        };

        // --- –ú–ò–ù–ò-–ò–ì–†–ê 1: –ö–û–ù–°–¢–†–£–ö–¢–û–† –§–†–ê–ó ---
        let builderTarget = "";
        let builderWords = [];
        let builderSelected = [];

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--;[array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; }
            return array;
        }

        window.startBuilder = () => {
            const validWords = globalWords.filter(w => {
                if (!w.example || (w.word_type !== 'noun' && w.word_type !== 'verb')) return false;
                let deText = extractGermanSentence(w.example);
                if (deText.includes(':')) return false;
                let parts = deText.split(/\s+/).filter(Boolean);
                return parts.length >= 3 && parts.length <= 8;
            });

            if (validWords.length === 0) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –≤–∞—à–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö!");

            const randomWord = validWords[Math.floor(Math.random() * validWords.length)];
            builderTarget = extractGermanSentence(randomWord.example);

            const cleanText = builderTarget.replace(/[.,?!]/g, '').trim();
            let pool = cleanText.split(/\s+/).filter(Boolean);

            const availableDistractors = globalWords.filter(w => w.word_de && !pool.includes(w.word_de));
            if (availableDistractors.length >= 2) {
                const distractors = availableDistractors.sort(() => 0.5 - Math.random()).slice(0, 2).map(w => w.word_de);
                pool = pool.concat(distractors);
            }

            builderWords = shuffle(pool);
            builderSelected = [];

            sessionStartMs = Date.now();
            document.getElementById('practice-menu').classList.add('hidden');
            document.getElementById('builder-game').classList.remove('hidden');

            document.getElementById('builder-target-word').innerHTML = `–°–æ–±–µ—Ä–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—Ä–∞–∑—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é —Å–ª–æ–≤–æ:<br><strong class="text-blue-500 text-lg block mt-2">${randomWord.word_ru}</strong>`;

            renderBuilder();
        };

        function renderBuilder() {
            const pool = document.getElementById('builder-pool');
            const dropzone = document.getElementById('builder-dropzone');
            const btnCheck = document.getElementById('btn-check-builder');
            const feedback = document.getElementById('builder-feedback');

            feedback.classList.add('hidden');
            btnCheck.disabled = builderSelected.length === 0;
            btnCheck.className = builderSelected.length === 0 ? "w-full bg-gray-100 dark:bg-gray-800 text-gray-400 font-bold py-3.5 rounded-xl mt-6 transition-all border border-transparent" : "w-full bg-blue-500 text-white font-bold py-3.5 rounded-xl mt-6 shadow-md shadow-blue-500/20 active:scale-95 transition-all";

            pool.innerHTML = builderWords.map((w, i) => {
                return `<button onclick="builderSelect(${i})" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 shadow-sm rounded-lg font-medium active:scale-95 transition-transform">${w}</button>`;
            }).join('');

            dropzone.innerHTML = builderSelected.map((w, i) => `<button onclick="builderDeselect(${i})" class="px-4 py-2 bg-blue-500 text-white shadow-md rounded-lg font-bold active:scale-95 transition-transform animate-in zoom-in duration-200">${w}</button>`).join('');
        }

        window.builderSelect = (index) => { builderSelected.push(builderWords.splice(index, 1)[0]); renderBuilder(); };
        window.builderDeselect = (index) => { builderWords.push(builderSelected.splice(index, 1)[0]); renderBuilder(); };

        window.checkBuilder = () => {
            const userStr = builderSelected.join('').toLowerCase();
            const targetStr = builderTarget.replace(/[.,?!]/g, '').replace(/\s+/g, '').toLowerCase();
            const feedback = document.getElementById('builder-feedback');
            const btnCheck = document.getElementById('btn-check-builder');

            feedback.classList.remove('hidden');
            btnCheck.disabled = true;

            if (userStr === targetStr) {
                feedback.className = "w-full text-center py-3 rounded-xl font-bold text-sm mt-4 transition-all bg-green-50 text-green-600 border border-green-200 dark:bg-green-900/20 dark:border-green-800 animate-in fade-in zoom-in";
                feedback.innerHTML = `–°—É–ø–µ—Ä! <br><span class="font-normal text-xs italic text-green-600/70 mt-1 block">${builderTarget}</span>`;
                setTimeout(() => startBuilder(), 2000);
            } else {
                feedback.className = "w-full text-center py-3 rounded-xl font-bold text-sm mt-4 transition-all bg-red-50 text-red-600 border border-red-200 dark:bg-red-900/20 dark:border-red-800 animate-in fade-in zoom-in";
                feedback.innerHTML = `–û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: <br><span class="font-normal text-xs italic text-red-600/70 mt-1 block">${builderTarget}</span>`;
                setTimeout(() => { builderWords = builderWords.concat(builderSelected); builderSelected = []; renderBuilder(); }, 3000);
            }
        };

        // --- –ú–ò–ù–ò-–ò–ì–†–ê 2: –¢–†–ï–ù–ê–ñ–ï–† –ì–õ–ê–ì–û–õ–û–í (–ö–ê–†–¢–û–ß–ö–ò) ---
        let vtQueue = [];
        let vtIdx = 0;
        let vtMode = 'praet';

        window.startVerbTrainer = () => {
            vtQueue = globalWords.filter(w => w.word_type === 'verb' && w.praeteritum && w.partizip).sort(() => 0.5 - Math.random());
            if (vtQueue.length === 0) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—ã Pr√§teritum –∏ Partizip II —É –≥–ª–∞–≥–æ–ª–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ!");

            vtIdx = 0;
            sessionStartMs = Date.now();
            document.getElementById('practice-menu').classList.add('hidden');
            document.getElementById('verb-trainer-game').classList.remove('hidden');
            renderVerbCard();
        };

        window.setVTMode = (mode) => {
            vtMode = mode;
            document.getElementById('vt-mode-praet').className = mode === 'praet' ? "flex-1 py-2 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('vt-mode-perf').className = mode === 'perf' ? "flex-1 py-2 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            renderVerbCard();
        };

        window.renderVerbCard = () => {
            if (vtIdx >= vtQueue.length) {
                alert("–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –≥–ª–∞–≥–æ–ª—ã –ø—Ä–æ–π–¥–µ–Ω—ã.");
                closePractice();
                return;
            }
            const w = vtQueue[vtIdx];
            document.getElementById('vt-counter').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${vtQueue.length - vtIdx}`;
            document.getElementById('vt-ru').innerText = w.word_ru;
            document.getElementById('vt-inf').innerText = w.word_de;

            document.getElementById('vt-answer-block').classList.add('hidden');
            document.getElementById('vt-btn-show').classList.remove('hidden');
        };

        window.showVTAnswer = () => {
            const w = vtQueue[vtIdx];
            document.getElementById('vt-answer').innerText = vtMode === 'praet' ? w.praeteritum : w.partizip;
            document.getElementById('vt-btn-show').classList.add('hidden');
            document.getElementById('vt-answer-block').classList.remove('hidden');
        };

        window.answerVerb = (remembered) => {
            if (!remembered) { vtQueue.push({ ...vtQueue[vtIdx] }); } // –ï—Å–ª–∏ –∑–∞–±—ã–ª ‚Äî –∫–∏–¥–∞–µ–º –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
            vtIdx++;
            renderVerbCard();
        };

        // --- –ú–ò–ù–ò-–ò–ì–†–ê: –ü–û–î–ë–û–† –ü–ê–† (MATCH) ---
        let matchCards = [];
        let matchSelectedIds = [];
        let matchStartTime = 0;
        let matchPairsLeft = 0;

        window.startMatchGame = () => {
            const validWords = globalWords.filter(w => w.word_de && w.word_ru).sort(() => 0.5 - Math.random());
            if (validWords.length < 6) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–≤ –¥–ª—è –∏–≥—Ä—ã (–º–∏–Ω–∏–º—É–º 6).");

            const selectedWords = validWords.slice(0, 6);
            matchCards = [];

            selectedWords.forEach(w => {
                const de = (w.word_type === 'noun' && w.article ? w.article + ' ' : '') + w.word_de;
                matchCards.push({ id: w.id, text: de, lang: 'de' });
                matchCards.push({ id: w.id, text: w.word_ru, lang: 'ru' });
            });

            matchCards.sort(() => 0.5 - Math.random());
            matchSelectedIds = [];
            matchPairsLeft = 6;
            matchStartTime = Date.now();
            sessionStartMs = Date.now();

            document.getElementById('practice-menu').classList.add('hidden');
            document.getElementById('match-game').classList.remove('hidden');

            document.getElementById('btn-match-retry').classList.add('hidden');
            document.getElementById('match-feedback').classList.add('hidden');

            if (window.matchTimerInt) clearInterval(window.matchTimerInt);
            window.matchTimerInt = setInterval(() => {
                const elapsed = (Date.now() - matchStartTime) / 1000;
                document.getElementById('match-timer').innerText = elapsed.toFixed(1) + '—Å';
            }, 100);

            renderMatchGrid();
        };

        function renderMatchGrid() {
            const grid = document.getElementById('match-grid');
            grid.innerHTML = matchCards.map((c, i) => {
                const isSelected = matchSelectedIds.includes(i);
                let btnClass = isSelected
                    ? "bg-indigo-100 dark:bg-indigo-900/40 border-indigo-500 text-indigo-700 dark:text-indigo-300 scale-95"
                    : "bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 hover:border-indigo-300 dark:hover:border-indigo-700 hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20";

                if (c.matched) btnClass = "opacity-0 pointer-events-none scale-90";

                return `<button onclick="matchSelect(${i})" class="relative p-3 sm:p-4 rounded-xl border-2 font-medium text-xs sm:text-sm flex items-center justify-center text-center transition-all duration-200 active:scale-95 min-h-[80px] ${btnClass}">
                    ${c.text}
                </button>`;
            }).join('');
        }

        window.matchSelect = (index) => {
            if (matchCards[index].matched || matchSelectedIds.includes(index) || matchSelectedIds.length >= 2) return;

            matchSelectedIds.push(index);
            renderMatchGrid();

            if (matchSelectedIds.length === 2) {
                const [i1, i2] = matchSelectedIds;
                const c1 = matchCards[i1];
                const c2 = matchCards[i2];

                if (c1.id === c2.id && c1.lang !== c2.lang) {
                    setTimeout(() => {
                        matchCards[i1].matched = true;
                        matchCards[i2].matched = true;
                        matchSelectedIds = [];
                        matchPairsLeft--;
                        renderMatchGrid();

                        if (matchPairsLeft === 0) {
                            clearInterval(window.matchTimerInt);
                            const finalTime = ((Date.now() - matchStartTime) / 1000).toFixed(1);
                            document.getElementById('btn-match-retry').classList.remove('hidden');
                            const fb = document.getElementById('match-feedback');
                            fb.className = "text-center py-4 rounded-xl font-bold mt-4 transition-all bg-green-50 text-green-600 border border-green-200 dark:bg-green-900/20 dark:border-green-800 animate-in fade-in zoom-in";
                            fb.innerHTML = `–ü–æ–±–µ–¥–∞! üéâ <br><span class="text-sm font-medium mt-1">–¢–≤–æ–µ –≤—Ä–µ–º—è: ${finalTime}—Å</span>`;
                            fb.classList.remove('hidden');
                        }
                    }, 300);
                } else {
                    setTimeout(() => {
                        matchSelectedIds = [];
                        renderMatchGrid();
                    }, 500);
                }
            }
        };

        window.closePractice = () => {
            saveSessionTime();
            document.getElementById('practice-menu').classList.remove('hidden');
            document.getElementById('match-game').classList.add('hidden');
            document.getElementById('builder-game').classList.add('hidden');
            document.getElementById('verb-trainer-game').classList.add('hidden');
            document.getElementById('listening-game').classList.add('hidden');
            document.getElementById('sprint-game').classList.add('hidden');
            if (sprintTimer) clearInterval(sprintTimer);
            if (window.matchTimerInt) clearInterval(window.matchTimerInt);
        };

        // --- –ú–ò–ù–ò-–ò–ì–†–ê 3: –ê–£–î–ò–†–û–í–ê–ù–ò–ï ---
        let listQueue = [];
        let listIdx = 0;
        let listCurrentWord = null;

        window.startListeningQuiz = () => {
            if (globalWords.length < 4) return alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 4 —Å–ª–æ–≤–∞ –≤ –±–∞–∑–µ!");
            listQueue = globalWords.slice().sort(() => 0.5 - Math.random()).slice(0, 20); // 20 words per run
            listIdx = 0;
            sessionStartMs = Date.now();
            document.getElementById('practice-menu').classList.add('hidden');
            document.getElementById('listening-game').classList.remove('hidden');
            nextListeningWord();
        };

        window.playListeningWord = () => {
            if (!listCurrentWord) return;
            speakWord(listCurrentWord.word_de);
        };

        function nextListeningWord() {
            if (listIdx >= listQueue.length) {
                alert("–£—Ä–∞! –ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
                closePractice();
                return;
            }
            listCurrentWord = listQueue[listIdx];
            document.getElementById('listening-counter').innerText = `–°–ª–æ–≤–æ: ${listIdx + 1} –∏–∑ ${listQueue.length}`;

            // Generate options
            let options = [listCurrentWord];
            let pool = globalWords.filter(w => w.id !== listCurrentWord.id);
            pool = pool.sort(() => 0.5 - Math.random());
            options.push(pool[0], pool[1], pool[2]);
            options = options.sort(() => 0.5 - Math.random()); // shuffle

            const block = document.getElementById('listening-options');
            block.innerHTML = '';

            options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "p-4 bg-gray-50 dark:bg-gray-800 rounded-xl text-sm font-medium flex justify-between items-center hover:bg-green-50 hover:text-green-700 dark:hover:bg-green-900/30 dark:hover:text-green-400 transition-colors border border-gray-100 dark:border-gray-700 active:scale-95";
                btn.innerHTML = `<span>${opt.word_ru}</span><span class="text-[10px] text-gray-400 font-black border border-gray-200 dark:border-gray-700 px-1.5 py-0.5 rounded ml-2">${idx + 1}</span>`;
                btn.onclick = () => checkListening(opt.id, btn);
                block.appendChild(btn);
            });

            setTimeout(playListeningWord, 500);
        }

        function checkListening(id, btn) {
            if (id === listCurrentWord.id) {
                btn.className = "p-4 bg-green-500 shadow-md shadow-green-500/30 rounded-xl text-sm font-bold text-white transition-all border border-green-600 transform scale-[1.02]";
                setTimeout(() => { listIdx++; nextListeningWord(); }, 800);
            } else {
                btn.className = "p-4 bg-red-500 rounded-xl text-sm font-bold text-white transition-all border border-red-600";
                setTimeout(() => { btn.className = "p-4 bg-gray-50 dark:bg-gray-800 rounded-xl text-sm font-medium transition-colors border border-gray-100 dark:border-gray-700"; }, 800);
            }
        }

        // --- –ú–ò–ù–ò-–ò–ì–†–ê 4: –°–ü–†–ò–ù–¢ ---
        let sprintScore = 0;
        let sprintTimer = null;
        let sprintCurrentWord = null;
        let sprintTimeLeft = 60; // 60 seconds
        let sprintMistakes = 0;

        window.startSprint = () => {
            if (globalWords.length < 5) return alert("–î–ª—è —Å–ø—Ä–∏–Ω—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 5 —Å–ª–æ–≤!");
            sprintScore = 0;
            sprintTimeLeft = 60; // Reset sprintTimeLeft
            sprintMistakes = 0;
            document.getElementById('sprint-score').innerText = `–°—á–µ—Ç: 0`;
            sessionStartMs = Date.now();
            document.getElementById('practice-menu').classList.add('hidden');
            document.getElementById('sprint-game').classList.remove('hidden');
            document.getElementById('sprint-progress').style.width = `100%`;

            nextSprintWord();

            sprintTimer = setInterval(() => {
                sprintTimeLeft--;
                document.getElementById('sprint-progress').style.width = `${(sprintTimeLeft / 60) * 100}%`;
                if (sprintTimeLeft <= 0) {
                    clearInterval(sprintTimer);
                    if (sprintMistakes === 0 && sprintScore >= 10) {
                        let ps = parseInt(localStorage.getItem('perfectSprints') || '0', 10);
                        localStorage.setItem('perfectSprints', ps + 1);
                        alert(`–°–ø—Ä–∏–Ω—Ç –æ–∫–æ–Ω—á–µ–Ω! –í–∞—à —Å—á–µ—Ç: ${sprintScore}. –í—ã –ø–æ–ª—É—á–∏–ª–∏ –∑–Ω–∞—á–æ–∫ "–ò–¥–µ–∞–ª—å–Ω—ã–π –°–ø—Ä–∏–Ω—Ç"! ‚ö°`);
                    } else {
                        alert(`–°–ø—Ä–∏–Ω—Ç –æ–∫–æ–Ω—á–µ–Ω! –í–∞—à —Å—á–µ—Ç: ${sprintScore}. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å ‚ö°`);
                    }
                    closePractice();
                }
            }, 1000);
        };

        function nextSprintWord() {
            let pool = globalWords.slice();
            pool = pool.sort(() => 0.5 - Math.random());
            sprintCurrentWord = pool[0];

            document.getElementById('sprint-word').innerText = sprintCurrentWord.word_ru;

            let options = [sprintCurrentWord, pool[1], pool[2], pool[3]];
            options = options.sort(() => 0.5 - Math.random());

            const block = document.getElementById('sprint-options');
            block.innerHTML = '';

            options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "p-4 bg-gray-50 dark:bg-gray-800 rounded-xl text-sm font-bold flex justify-between items-center hover:bg-purple-50 hover:text-purple-700 dark:hover:bg-purple-900/30 dark:hover:text-purple-400 transition-colors border border-gray-200 dark:border-gray-700 active:scale-95";
                btn.innerHTML = `<span>${opt.word_de}</span><span class="text-[10px] text-gray-400 font-black border border-gray-200 dark:border-gray-700 px-1.5 py-0.5 rounded ml-2">${idx + 1}</span>`;
                btn.onclick = () => checkSprint(opt.id, btn);
                block.appendChild(btn);
            });
        }

        function checkSprint(id, btn) {
            if (id === sprintCurrentWord.id) {
                sprintScore++;
                document.getElementById('sprint-score').innerText = `–°—á–µ—Ç: ${sprintScore}`;
                btn.className = "p-4 bg-purple-500 shadow-md shadow-purple-500/30 rounded-xl text-sm font-bold text-white transition-all border border-purple-600 transform scale-[1.02]";
                setTimeout(() => nextSprintWord(), 300);
            } else {
                sprintMistakes++;
                sprintTimeLeft -= 5; // penalty
                if (sprintTimeLeft < 0) sprintTimeLeft = 0;
                document.getElementById('sprint-progress').style.width = `${(sprintTimeLeft / 60) * 100}%`;
                btn.className = "p-4 bg-red-500 rounded-xl text-sm font-bold text-white transition-all border border-red-600";
            }
        }

        // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            // Flashcards Shortcuts
            if (!document.getElementById('view-train').classList.contains('hidden') && !document.getElementById('train-card-block').classList.contains('hidden')) {
                // Showing answer
                if (!document.getElementById('btn-show-answer').classList.contains('hidden')) {
                    if (e.code === 'Space' || e.code === 'Enter') {
                        e.preventDefault();
                        document.getElementById('btn-show-answer').click();
                        return;
                    }
                } else if (!document.getElementById('train-answer-block').classList.contains('hidden')) {
                    if (e.code === 'Digit1') {
                        e.preventDefault();
                        document.getElementById('btn-forgot').click();
                        return;
                    } else if (e.code === 'Digit2' || e.code === 'Space' || e.code === 'Enter') {
                        e.preventDefault();
                        document.getElementById('btn-remembered').click();
                        return;
                    }
                }
            }

            // Sprint Game Shortcuts
            if (!document.getElementById('sprint-game').classList.contains('hidden')) {
                const buttons = document.getElementById('sprint-options').querySelectorAll('button');
                if (e.code === 'Digit1' && buttons[0]) { e.preventDefault(); buttons[0].click(); }
                if (e.code === 'Digit2' && buttons[1]) { e.preventDefault(); buttons[1].click(); }
                if (e.code === 'Digit3' && buttons[2]) { e.preventDefault(); buttons[2].click(); }
                if (e.code === 'Digit4' && buttons[3]) { e.preventDefault(); buttons[3].click(); }
            }

            // Listening Game Shortcuts
            if (!document.getElementById('listening-game').classList.contains('hidden')) {
                if (e.code === 'Space') { e.preventDefault(); playListeningWord(); return; }
                const buttons = document.getElementById('listening-options').querySelectorAll('button');
                if (e.code === 'Digit1' && buttons[0]) { e.preventDefault(); buttons[0].click(); }
                if (e.code === 'Digit2' && buttons[1]) { e.preventDefault(); buttons[1].click(); }
                if (e.code === 'Digit3' && buttons[2]) { e.preventDefault(); buttons[2].click(); }
                if (e.code === 'Digit4' && buttons[3]) { e.preventDefault(); buttons[3].click(); }
            }
        });

        // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –¢–ï–ü–õ–û–í–ê–Ø –ö–ê–†–¢–ê ---
        function generateHeatmap(history) {
            let daysHtml = '';
            const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            let maxMins = DAILY_GOAL_MINUTES;

            for (let i = 6; i >= 0; i--) {
                let d = new Date(); d.setDate(d.getDate() - i);
                let iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
                let mins = (history[iso] || 0) / 60000;
                if (mins > maxMins) maxMins = mins;
            }

            for (let i = 6; i >= 0; i--) {
                let d = new Date(); d.setDate(d.getDate() - i);
                let iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
                let mins = (history[iso] || 0) / 60000;

                let dayName = i === 0 ? '–°–µ–≥–æ–¥–Ω—è' : dayNames[d.getDay()];
                let heightPct = mins === 0 ? 0 : Math.max(5, (mins / maxMins) * 100);
                let barColor = mins >= DAILY_GOAL_MINUTES ? 'bg-blue-600 dark:bg-blue-500 shadow-md shadow-blue-500/20' : (mins > 0 ? 'bg-blue-300 dark:bg-blue-400' : 'bg-transparent');
                let textColor = i === 0 ? 'text-blue-600 dark:text-blue-400 font-black' : 'text-gray-400 font-bold';

                daysHtml += `
                <div class="flex flex-col items-center flex-1 gap-1.5 group">
                    <span class="text-[10px] font-bold ${mins > 0 ? 'text-gray-500 dark:text-gray-300' : 'text-transparent'} transition-all">${Math.round(mins)}–º</span>
                    <div class="w-full max-w-[36px] h-28 bg-gray-50 dark:bg-gray-800/50 rounded-[10px] flex flex-col justify-end overflow-hidden border border-gray-100 dark:border-gray-700/50">
                        <div class="w-full ${barColor} transition-all duration-1000 ease-out rounded-[8px]" style="height: ${heightPct}%"></div>
                    </div>
                    <span class="text-[9px] ${textColor} uppercase tracking-widest mt-1 truncate max-w-full px-1 text-center">${dayName}</span>
                </div>`;
            }

            return `
            <div class="flex items-end justify-between w-full mt-2 mb-2 px-1 gap-2">
                ${daysHtml}
            </div>
            `;
        }



        async function loadStats() {
            const stats = document.getElementById('view-stats');
            try {
                try { const res = await apiFetch('/history'); serverHistory = await res.json(); }
                catch (e) { serverHistory = JSON.parse(localStorage.getItem('studyHistory')) || {}; }

                let leaderboardHtml = '';
                try {
                    const lbRes = await fetch('/leaderboard', { headers: { 'x-user': currentUser } });
                    if (lbRes.ok) {
                        const lbData = await lbRes.json();
                        const tzoffset = (new Date()).getTimezoneOffset() * 60000;
                        const todayStr = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 10);
                        const yesterdayStr = (new Date(Date.now() - tzoffset - 86400000)).toISOString().slice(0, 10);

                        lbData.forEach(user => {
                            let streak = 0;
                            if (user.history && user.history.length > 0) {
                                const dates = user.history.sort((a, b) => b.localeCompare(a));
                                if (dates[0] === todayStr || dates[0] === yesterdayStr) {
                                    let currDate = new Date(dates[0]);
                                    for (let d of dates) {
                                        if (d === currDate.toISOString().slice(0, 10)) {
                                            streak++;
                                            currDate.setDate(currDate.getDate() - 1);
                                        } else {
                                            break;
                                        }
                                    }
                                }
                            }
                            user.streak = streak;
                        });

                        lbData.sort((a, b) => b.total_ms - a.total_ms);

                        leaderboardHtml = '<h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-2 mt-2">–†–µ–π—Ç–∏–Ω–≥ (–ü–æ –≤—Ä–µ–º–µ–Ω–∏)</h3><div class="space-y-3 mb-8">';

                        const avatars = {
                            'osman': localStorage.getItem('avatar_osman'),
                            'girlfriend': localStorage.getItem('avatar_girlfriend')
                        };

                        lbData.forEach((user, index) => {
                            const isMe = user.username === currentUser;
                            const avatarUrl = avatars[user.username] || '';
                            const initials = user.username === 'osman' ? '–û' : (user.username === 'girlfriend' ? '–î' : user.username[0].toUpperCase());
                            const name = user.username === 'osman' ? 'Adil Osmanov' : (user.username === 'girlfriend' ? 'Ewelin Osmanov' : user.username);

                            const totalMinutes = Math.floor((user.total_ms || 0) / 60000);
                            const hours = Math.floor(totalMinutes / 60);
                            const mins = totalMinutes % 60;
                            const timeStr = hours > 0 ? `${hours}—á ${mins}–º` : `${mins}–º`;

                            const pbgColor = index === 0 ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800' :
                                (index === 1 ? 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700' : 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800');
                            const troColor = index === 0 ? 'text-yellow-500' : (index === 1 ? 'text-gray-400' : 'text-orange-500');

                            leaderboardHtml += `
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-4 transition-all hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <div class="w-8 h-8 rounded-full ${pbgColor} flex items-center justify-center font-bold text-sm border flex-shrink-0 ${troColor}">${index + 1}</div>
                                    <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 bg-cover bg-center flex items-center justify-center text-lg font-bold text-gray-400 flex-shrink-0" style="${avatarUrl ? `background-image: url(${avatarUrl})` : ''}">
                                        ${!avatarUrl ? initials : ''}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-bold text-base text-gray-900 dark:text-white truncate flex items-center gap-2">
                                            ${name} ${isMe ? '<span class="text-[9px] bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-400 px-1.5 py-0.5 rounded uppercase tracking-wider">–í—ã</span>' : ''}
                                        </h3>
                                        <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-500 font-medium mt-1">
                                            <span class="flex items-center gap-1" title="–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è"><span class="text-purple-500">‚è≥</span> ${timeStr}</span>
                                            <span class="flex items-center gap-1" title="–£–¥–∞—Ä–Ω—ã–π —Ä–µ–∂–∏–º"><span class="text-orange-500">üî•</span> ${user.streak} –¥–Ω.</span>
                                            <span class="flex items-center gap-1" title="–û–ø—ã—Ç"><span class="text-blue-500">üèÜ</span> ${user.total_xp} XP</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        leaderboardHtml += '</div>';
                    }
                } catch (e) { }

                const total = globalWords.length;
                const mastered = globalWords.filter(w => w.score >= MAX_SCORE).length;
                const pctMastery = total === 0 ? 0 : Math.round((mastered / total) * 100);

                let statusLevel = "–ù–æ–≤–∏—á–æ–∫ (A1)";
                if (mastered > 50) statusLevel = "–°—Ç—É–¥–µ–Ω—Ç (A2)";
                if (mastered > 200) statusLevel = "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (B1)";
                if (mastered > 500) statusLevel = "–ü—Ä–æ—Ñ–∏ (B2+)";

                const folders = {};
                globalWords.forEach(w => {
                    const k = `${w.folder}| ${w.level || '–û–±—â–µ–µ'}| ${w.subfolder} `;
                    if (!folders[k]) folders[k] = { f: w.folder, l: w.level || '–û–±—â–µ–µ', s: w.subfolder, total: 0, done: 0 };
                    folders[k].total++; if (w.score >= MAX_SCORE) folders[k].done++;
                });

                const sortedFolders = Object.values(folders).sort((a, b) => {
                    const pctA = a.done / a.total; const pctB = b.done / b.total;
                    if (pctB !== pctA) return pctA - pctB; return a.s.localeCompare(b.s);
                });

                let streak = 0;
                let d = new Date(); let tz = d.getTimezoneOffset() * 60000;
                let todayIso = new Date(d.getTime() - tz).toISOString().slice(0, 10);
                d.setDate(d.getDate() - 1); let yesterdayIso = new Date(d.getTime() - tz).toISOString().slice(0, 10);

                const goalMs = DAILY_GOAL_MINUTES * 60000;
                let checkD = new Date();
                if ((serverHistory[todayIso] || 0) >= goalMs) { } else if ((serverHistory[yesterdayIso] || 0) >= goalMs) { checkD.setDate(checkD.getDate() - 1); } else { checkD = null; }
                if (checkD) {
                    while (true) {
                        let iso = new Date(checkD.getTime() - checkD.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
                        if ((serverHistory[iso] || 0) >= goalMs) { streak++; checkD.setDate(checkD.getDate() - 1); } else { break; }
                    }
                }
                let minutesToday = Math.floor((serverHistory[todayIso] || 0) / 60000);

                const pctMinutes = Math.min(100, (minutesToday / DAILY_GOAL_MINUTES) * 100);
                const isGoalMet = minutesToday >= DAILY_GOAL_MINUTES;

                let learnedVerbs = globalWords.filter(w => w.word_type === 'verb' && w.score >= MAX_SCORE).length;
                let has100Verbs = learnedVerbs >= 100;
                let hasWeekStreak = streak >= 7;
                let perfectSprints = parseInt(localStorage.getItem('perfectSprints') || '0', 10);
                let hasPerfectSprint = perfectSprints > 0;

                let badgesHtml = ``;



                stats.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-800 p-6 rounded-[2rem] shadow-lg mb-8 relative overflow-hidden text-center text-white border border-blue-500/30">
                        <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_top_right,rgba(255,255,255,0.1),transparent)]"></div>
                        
                        <h3 class="text-xs font-black uppercase tracking-[0.2em] text-blue-200 mb-6 drop-shadow-md">–í—Ä–µ–º—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                        
                        <div class="flex items-center justify-center mb-6 relative">
                            <div class="w-40 h-40 relative flex items-center justify-center">
                                <svg class="w-full h-full transform -rotate-90 drop-shadow-lg">
                                    <circle cx="80" cy="80" r="72" stroke="currentColor" class="text-blue-900/40" stroke-width="14" fill="none"/>
                                    <circle cx="80" cy="80" r="72" stroke="currentColor" class="${isGoalMet ? 'text-green-400' : 'text-blue-300'} transition-all duration-1000 ease-out" stroke-width="14" fill="none" stroke-dasharray="452.4" stroke-dashoffset="${452.4 * (1 - pctMinutes / 100)}" stroke-linecap="round"/>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                    <span class="text-5xl font-black tracking-tighter leading-none">${minutesToday}</span>
                                    <span class="text-xs font-medium text-blue-200 uppercase tracking-widest mt-1">–ú–∏–Ω—É—Ç</span>
                                </div>
                            </div>
                        </div>

                        ${isGoalMet ?
                        `<div class="inline-flex items-center gap-2 bg-green-500/20 border border-green-400/30 px-4 py-2 rounded-full backdrop-blur-sm">
                                <span class="text-xl">üî•</span>
                                <span class="text-sm font-bold text-green-300">–¶–µ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!</span>
                            </div>` :
                        `<div class="inline-flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full border border-white/10 backdrop-blur-sm">
                                <span class="text-xs font-bold text-blue-100 uppercase tracking-widest">–¶–µ–ª—å: ${DAILY_GOAL_MINUTES} –º–∏–Ω</span>
                            </div>`
                    }
                    </div>

                    <div class="flex items-center justify-between mb-8 px-2">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-2xl shadow-inner border border-gray-200 dark:border-gray-700">
                                üéì
                            </div>
                            <div>
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–†–∞–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                                <p class="text-lg font-black text-gray-900 dark:text-white leading-none">${statusLevel}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–û—Å–≤–æ–µ–Ω–æ</h3>
                            <p class="text-2xl font-black text-blue-500 leading-none">${pctMastery}%</p>
                        </div>
                    </div>
                    

                    ${leaderboardHtml}

                    <div class="bg-white dark:bg-gray-800 p-5 rounded-[1.5rem] shadow-sm border border-gray-100 dark:border-gray-700 mb-8 overflow-hidden">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-1">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–°—Ç—Ä–∏–∫: ${streak})</h3>
                        </div>
                        <div class="w-full overflow-x-auto pb-2 scrollbar-hide">
                            ${generateHeatmap(serverHistory)}
                        </div>
                    </div>
                    


                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-2">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫—É—Ä—Å–∞–º</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-4">
                        ${sortedFolders.map(dat => {
                        const pct = Math.round((dat.done / dat.total) * 100);
                        const isDone = pct === 100;
                        const barColor = isDone ? 'bg-green-500' : 'bg-blue-500';
                        const textColor = isDone ? 'text-green-600 dark:text-green-400' : 'text-gray-900 dark:text-white';

                        return `
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 relative flex flex-col justify-between overflow-hidden">
                                <button onclick="resetFolderStats('${escapeStr(dat.f)}', '${escapeStr(dat.l)}', '${escapeStr(dat.s)}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors z-10" title="–°–±—Ä–æ—Å–∏—Ç—å">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                </button>
                                <div class="relative z-10 mb-5">
                                    <div class="flex items-center gap-2 mb-2 pr-6">
                                        ${dat.l !== '–û–±—â–µ–µ' ? `<span class="text-[9px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-md ${getLevelColor(dat.l)}">${dat.l}</span>` : ''}
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest truncate">${dat.f}</span>
                                    </div>
                                    <h4 class="font-bold text-base ${textColor} pr-4">${dat.s}</h4>
                                </div>
                                <div class="relative z-10 mt-auto">
                                    <div class="flex justify-between items-end mb-2">
                                        <span class="text-xl font-black ${isDone ? 'text-green-500' : 'text-blue-500'}">${pct}%</span>
                                        <span class="text-xs font-medium text-gray-400">${dat.done} / ${dat.total}</span>
                                    </div>
                                    <div class="w-full bg-gray-100 dark:bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="${barColor} h-full transition-all duration-1000 ease-out" style="width: ${pct}%"></div>
                                    </div>
                                </div>
                            </div>`;
                    }).join('')}
                    </div>
                `;
            } catch (err) { }
        }

        window.resetFolderStats = async (f, l, s) => {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —Ç–µ–º—ã "${s}" ?`)) {
                try {
                    await apiFetch('/words/reset_folder', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder: f, level: l, subfolder: s }) });
                    await fetchWords(); await loadStats();
                } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞!"); }
            }
        };

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                if (sessionStartMs > 0) saveSessionTime();
            } else {
                if (!document.getElementById('train-card-block').classList.contains('hidden')) {
                    sessionStartMs = Date.now();
                }
            }
        });

        switchView('dict');
    </script>
</body>

</html>