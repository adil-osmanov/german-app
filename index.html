<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>W√∂rterbuch Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { 
                        der: '#3b82f6', die: '#ef4444', das: '#10b981'
                    }
                } 
            } 
        };
        
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').catch(()=>{}); });
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; -webkit-tap-highlight-color: transparent; height: 100dvh; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .dark .glass { background: rgba(17, 24, 39, 0.85); border-color: rgba(255,255,255,0.05); }
        .active-tab { color: #3b82f6; transform: translateY(-2px); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .drag-handle-folder, .drag-handle-topic { touch-action: none; cursor: grab; }
        .drag-handle-folder:active, .drag-handle-topic:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; transform: scale(0.98); background: #f3f4f6; border-radius: 12px; }
        .dark .sortable-ghost { background: #1f2937; }

        @keyframes foldUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-15px) scale(0.97); }
        }
        .animate-fold-up { animation: foldUp 0.25s ease-out forwards; }
    </style>
</head>
<body class="bg-[#f2f2f7] dark:bg-black text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col overflow-hidden">

    <div class="hidden bg-teal-100 text-teal-700 dark:bg-teal-900/40 dark:text-teal-400 bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400 bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-400 bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-400 bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400 bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-400 bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400 line-through grayscale opacity-60 bg-emerald-500 text-emerald-50 text-teal-500"></div>

    <header class="fixed top-0 left-0 right-0 pt-12 pb-3 px-4 glass z-40 transition-all border-b border-gray-200 dark:border-gray-800">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <h1 id="header-title" class="text-xl font-extrabold tracking-tight">–°–ª–æ–≤–∞—Ä—å</h1>
            <div class="flex items-center gap-3">
                 <button id="theme-toggle" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all text-gray-500 dark:text-gray-400">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
                </button>
                <button id="add-btn" class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-600 active:scale-95 transition-all text-lg font-medium shadow-md shadow-blue-500/30">+</button>
            </div>
        </div>
    </header>

    <main id="main-scroll" class="pt-28 pb-24 max-w-2xl mx-auto px-3 w-full overflow-y-auto">
        
        <section id="view-dict" class="pt-4 pb-6">
            <div class="mb-5 mt-2">
                <div class="relative group">
                    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Å–ª–æ–≤..." autocomplete="off" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl py-3 pl-10 shadow-sm outline-none focus:ring-2 ring-blue-500/50 transition-all text-gray-900 dark:text-white text-sm">
                    <svg class="w-4 h-4 absolute left-4 top-3.5 text-gray-400 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            
            <div class="flex bg-gray-200/60 dark:bg-gray-800/80 p-1 rounded-xl mb-4 border border-gray-100 dark:border-gray-800">
                <button id="dict-tab-active" class="flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
                <button id="dict-tab-mastered" class="flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 transition-all flex items-center justify-center gap-1 hover:text-gray-700 dark:hover:text-gray-300">–ê—Ä—Ö–∏–≤ üèÜ</button>
            </div>

            <div id="dict-list">
                <div class="text-center py-20"><p class="text-gray-400 text-sm animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>
            </div>
        </section>

        <section id="view-train" class="hidden relative pt-2 pb-6">
            <div id="train-setup-block" class="w-full animate-in fade-in slide-in-from-bottom-4 duration-300 sm:mt-4">
                <div class="flex bg-gray-200/60 dark:bg-gray-800/80 p-1 rounded-xl mb-4 mt-1 gap-1 border border-gray-100 dark:border-gray-800">
                    <button id="dir-auto" onclick="setDirection('auto')" class="flex-1 py-2 text-[10px] font-bold rounded-lg bg-white dark:bg-gray-700 text-blue-500 shadow-sm transition-all uppercase">–ú–∏–∫—Å</button>
                    <button id="dir-ru-de" onclick="setDirection('ru-de')" class="flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 transition-all uppercase hover:text-gray-700 dark:hover:text-gray-300">–†–£–° > –ù–ï–ú</button>
                    <button id="dir-de-ru" onclick="setDirection('de-ru')" class="flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 transition-all uppercase hover:text-gray-700 dark:hover:text-gray-300">–ù–ï–ú > –†–£–°</button>
                </div>
                <div id="train-topics-container" class="space-y-3"></div>
            </div>

            <div id="train-card-block" class="hidden w-full bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-lg text-center relative flex flex-col transition-all border border-gray-100 dark:border-gray-800 mt-2 sm:mt-6">
                <button id="btn-stop-training" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold z-10 transition-colors">√ó</button>
                
                <div class="mb-3"><span id="train-level-badge" class="px-2.5 py-0.5 rounded-md text-[9px] font-bold uppercase tracking-widest bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">–£—Ä–æ–≤–µ–Ω—å 1</span></div>
                
                <div class="mb-5 w-full px-1">
                    <div class="flex justify-between text-[10px] font-medium text-gray-400 mb-1.5 uppercase tracking-wider">
                        <span id="train-card-progress-text">–ü—Ä–æ–≥—Ä–µ—Å—Å: 0/6</span>
                        <span id="train-total-cards">–û—Å—Ç–∞–ª–æ—Å—å: 0</span>
                    </div>
                    <div class="w-full bg-gray-100 dark:bg-gray-800 h-1.5 rounded-full overflow-hidden relative">
                        <div id="train-card-progress-fill" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="relative w-full flex justify-center items-center min-h-[60px] mb-4 px-10">
                    <h2 id="train-question" class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight m-0 text-center break-words">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <div class="absolute right-0 top-1/2 -translate-y-1/2">
                        <button id="btn-speak-question" class="hidden bg-gray-50 dark:bg-gray-800 w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-blue-500 transition-all border border-gray-100 dark:border-gray-700">üîä</button>
                    </div>
                </div>
                
                <p id="train-example-q" class="text-sm text-gray-500 dark:text-gray-400 italic mb-5 hidden px-2 leading-relaxed block"></p>
                
                <button id="btn-show-answer" class="w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-3.5 rounded-xl active:scale-95 transition-all mt-2 text-sm border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                
                <div id="train-answer-block" class="hidden w-full mt-3">
                    <div class="flex flex-col justify-center items-center mb-6 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-100 dark:border-gray-800">
                        <div class="relative w-full flex justify-center items-center min-h-[40px] px-10">
                            <p id="train-de-word" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight m-0 text-center"></p>
                            <div class="absolute right-0 top-1/2 -translate-y-1/2">
                                <button id="btn-speak-answer" class="hidden bg-blue-50 dark:bg-blue-900/30 w-8 h-8 rounded-full flex items-center justify-center text-blue-500 hover:scale-110 transition-transform">üîä</button>
                            </div>
                        </div>
                        <p id="train-de-plural" class="text-xs font-medium text-gray-500 mt-2 hidden"></p>
                        <p id="train-answer-example" class="text-sm text-blue-600 dark:text-blue-400 italic font-medium mt-3 hidden px-2 leading-relaxed text-center"></p>
                    </div>

                    <div class="flex gap-2">
                        <button id="btn-forgot" class="flex-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold py-3.5 rounded-xl border border-red-100 dark:border-red-900/30 active:scale-95 transition-all text-sm hover:bg-red-100 dark:hover:bg-red-900/40">–ù–µ –ø–æ–º–Ω—é</button>
                        <button id="btn-remembered" class="flex-1 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 font-bold py-3.5 rounded-xl border border-green-100 dark:border-green-900/30 active:scale-95 transition-all text-sm hover:bg-green-100 dark:hover:bg-green-900/40">–ü–æ–º–Ω—é</button>
                    </div>
                </div>

                <div id="train-manual-block" class="hidden w-full mt-3">
                    <div class="flex gap-2 mb-2 w-full">
                        <input type="text" id="manual-article" placeholder="der" autocomplete="off" class="w-[60px] bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-1 text-center outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-sm" style="text-align-last: center;">
                        <div class="flex-1 relative flex items-center min-w-0">
                            <input type="text" id="manual-main" placeholder="–í–ø–∏—à–∏—Ç–µ —Å–ª–æ–≤–æ..." autocomplete="off" class="w-full bg-gray-50 dark:bg-gray-800 rounded-lg py-3 pl-3 pr-10 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-sm">
                            <button id="btn-mic" type="button" class="absolute right-1 p-2 text-gray-400 hover:text-blue-500 transition-colors rounded-md active:scale-90" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                            </button>
                        </div>
                    </div>
                     <div class="flex gap-2 mb-2 w-full hidden" id="manual-plural-container">
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg py-3 px-1 text-center outline-none font-medium text-gray-500 w-[60px] min-w-0 flex items-center justify-center text-xs">die (pl)</div>
                        <input type="text" id="manual-plural" placeholder="–§–æ—Ä–º–∞ –º–Ω. —á–∏—Å–ª–∞..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-3 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-sm">
                    </div>
                    <div class="flex gap-2 mb-2 w-full hidden" id="manual-verb-forms-container">
                        <input type="text" id="manual-praeteritum" placeholder="Pr√§teritum (machte)" autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-2 text-center outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-xs">
                        <input type="text" id="manual-partizip" placeholder="Partizip II (gemacht)" autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-3 px-2 text-center outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white font-medium transition-all disabled:opacity-50 min-w-0 text-xs">
                    </div>
                    <div id="manual-feedback" class="hidden w-full text-center py-3 rounded-lg font-medium text-sm mb-3 transition-all"></div>

                    <div id="train-umlauts" class="flex justify-center gap-2 mb-4">
                        <button type="button" tabindex="-1" onmousedown="insertChar('√§', event)" class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√§</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√∂', event)" class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√∂</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√º', event)" class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√º</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√ü', event)" class="bg-gray-50 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-sm text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95">√ü</button>
                    </div>
                    <button id="btn-check-manual" class="w-full bg-blue-500 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-all disabled:opacity-50 text-sm shadow-md shadow-blue-500/20 hover:bg-blue-600">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>
        </section>

        <section id="view-stats" class="hidden pb-10 pt-4">
            </section>
    </main>

    <div id="backup-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex justify-center items-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 text-center animate-in zoom-in-95 duration-200 relative">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>
                <button onclick="document.getElementById('backup-modal').classList.add('hidden')" class="text-gray-400 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 w-8 h-8 rounded-full flex items-center justify-center font-bold transition-colors">√ó</button>
            </div>
            <p class="text-sm text-gray-500 mb-6 text-left leading-relaxed">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ª–æ–≤–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.</p>
            <button onclick="exportData()" class="w-full bg-blue-500 text-white font-medium py-3.5 rounded-xl shadow-md shadow-blue-500/20 mb-4 hover:bg-blue-600 active:scale-95 transition-all flex justify-center items-center gap-2 text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> –°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
            </button>
             <div class="relative mb-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200 dark:border-gray-800"></div></div>
                <div class="relative flex justify-center text-xs font-medium"><span class="px-2 bg-white dark:bg-gray-900 text-gray-400">–∏–ª–∏</span></div>
            </div>
            <button id="btn-trigger-restore" class="w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium py-3.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95 transition-all flex justify-center items-center gap-2 border border-gray-200 dark:border-gray-700 text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞
            </button>
            <input type="file" id="file-restore" accept=".csv" class="hidden">
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex justify-center items-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-gray-900 w-full max-w-lg rounded-[2rem] p-5 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 max-h-[90dvh] flex flex-col relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-white">–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ</h2>
                <button id="close-modal" class="text-gray-400 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors">√ó</button>
            </div>
            <div class="overflow-y-auto pr-1 -mr-1 pb-1">
                <div id="modal-tabs" class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl mb-4">
                    <button id="tab-single" class="flex-1 py-2 text-sm font-medium rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">–û–¥–Ω–æ —Å–ª–æ–≤–æ</button>
                    <button id="tab-bulk" class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300">–°–ø–∏—Å–∫–æ–º (CSV)</button>
                </div>
                
                <div id="form-single">
                    <div class="flex bg-gray-50 dark:bg-gray-800/50 p-1 rounded-lg mb-3 border border-gray-100 dark:border-gray-800">
                        <button id="type-noun" class="flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded-md bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white">–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ</button>
                        <button id="type-verb" class="flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300">–ì–ª–∞–≥–æ–ª / –î—Ä—É–≥–æ–µ</button>
                    </div>
                    <form id="add-form" class="space-y-3">
                        <div id="article-selector" class="flex gap-1 w-full mb-1">
                            <button type="button" id="btn-art-der" onclick="selectArticle('der')" class="flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium transition-all shadow-sm text-sm">der</button>
                            <button type="button" id="btn-art-die" onclick="selectArticle('die')" class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-500 font-medium transition-all text-sm hover:bg-gray-100 dark:hover:bg-gray-700">die</button>
                            <button type="button" id="btn-art-das" onclick="selectArticle('das')" class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-500 font-medium transition-all text-sm hover:bg-gray-100 dark:hover:bg-gray-700">das</button>
                        </div>
                        <div class="flex w-full items-center">
                            <input type="text" id="word-de" placeholder="–°–ª–æ–≤–æ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º..." required autocomplete="off" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all text-sm">
                        </div>
                        <div class="flex gap-2 w-full" id="plural-input-group">
                            <div class="bg-gray-100 dark:bg-gray-800 rounded-xl py-3 px-2 text-center outline-none font-medium text-gray-500 w-[60px] min-w-0 flex items-center justify-center text-xs">die (pl)</div>
                            <input type="text" id="word-plural" placeholder="–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all min-w-0 text-sm">
                        </div>
                        <div class="flex gap-2 w-full hidden" id="verb-forms-group">
                            <input type="text" id="word-praeteritum" placeholder="Pr√§teritum..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all min-w-0 text-sm">
                            <input type="text" id="word-partizip" placeholder="Partizip II..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 font-medium text-gray-900 dark:text-white transition-all min-w-0 text-sm">
                        </div>
                         <div id="add-umlauts" class="flex justify-center gap-2 mt-2 mb-2">
                            <button type="button" tabindex="-1" onmousedown="insertChar('√§', event)" class="bg-gray-100 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-base text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">√§</button>
                            <button type="button" tabindex="-1" onmousedown="insertChar('√∂', event)" class="bg-gray-100 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-base text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">√∂</button>
                            <button type="button" tabindex="-1" onmousedown="insertChar('√º', event)" class="bg-gray-100 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-base text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">√º</button>
                            <button type="button" tabindex="-1" onmousedown="insertChar('√ü', event)" class="bg-gray-100 dark:bg-gray-800 w-10 h-10 rounded-lg font-medium text-base text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">√ü</button>
                        </div>
                        <input type="text" id="word-ru" placeholder="–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π..." required autocomplete="off" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white transition-all text-sm">
                        <input type="text" id="word-example" placeholder="–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-4 outline-none focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-sm text-gray-900 dark:text-white transition-all">
                        <div class="flex w-full gap-2">
                            <div class="flex-[2] min-w-0"><input type="text" id="word-folder" list="folder-list" placeholder="–ö—É—Ä—Å (–Ω–∞–ø—Ä. –£—á–µ–±–Ω–∏–∫)" required class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none text-xs font-medium text-gray-900 dark:text-white focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700"></div>
                            <div class="flex-[1] min-w-0"><input type="text" id="word-level" list="level-list" placeholder="–£—Ä." class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-1 outline-none text-xs font-medium text-gray-900 dark:text-white focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700 text-center uppercase"></div>
                            <div class="flex-[2] min-w-0"><input type="text" id="word-subfolder" list="subfolder-list" placeholder="–¢–µ–º–∞ (–Ω–∞–ø—Ä. –£—Ä–æ–∫ 1)" required class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none text-xs font-medium text-gray-900 dark:text-white focus:ring-2 ring-blue-500/50 border border-gray-200 dark:border-gray-700"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white font-medium py-3.5 rounded-xl mt-2 active:scale-95 transition-all text-sm hover:bg-blue-600 shadow-md shadow-blue-500/20">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
                 <div class="hidden space-y-3" id="form-bulk">
                    <p class="text-xs text-gray-500 text-center mb-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ .csv</p>
                    <div class="flex w-full gap-2">
                        <div class="flex-[2] min-w-0"><input type="text" id="bulk-folder" list="folder-list" placeholder="–ö—É—Ä—Å" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none font-medium text-gray-900 dark:text-white text-xs border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-green-500/50"></div>
                        <div class="flex-[1] min-w-0"><input type="text" id="bulk-level" list="level-list" placeholder="–£—Ä." class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-1 outline-none font-medium text-gray-900 dark:text-white text-xs text-center uppercase border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-green-500/50"></div>
                        <div class="flex-[2] min-w-0"><input type="text" id="bulk-subfolder" list="subfolder-list" placeholder="–¢–µ–º–∞" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-3 px-3 outline-none font-medium text-gray-900 dark:text-white text-xs border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-green-500/50"></div>
                    </div>
                    <div class="mt-2 p-6 border-2 border-dashed border-green-300 dark:border-green-800/50 bg-green-50 dark:bg-green-900/10 rounded-xl text-center transition-all group hover:bg-green-100 dark:hover:bg-green-900/20 cursor-pointer" onclick="document.getElementById('bulk-file').click()">
                        <input type="file" id="bulk-file" accept=".csv" class="hidden">
                        <div class="flex flex-col items-center gap-2 pointer-events-none">
                            <svg class="w-8 h-8 text-green-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span class="text-green-600 dark:text-green-400 font-medium text-sm" id="bulk-file-label">–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª</span>
                        </div>
                    </div>
                    <button id="btn-upload-csv" class="w-full bg-green-500 text-white font-medium py-3.5 rounded-xl mt-2 active:scale-95 transition-all text-sm hover:bg-green-600 shadow-md shadow-green-500/30">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 w-full glass border-t border-gray-200 dark:border-gray-800 z-30 pt-2 pb-[calc(env(safe-area-inset-bottom,0px)+8px)] px-4">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button id="nav-dict" class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group">
                <svg class="w-6 h-6 group-[.active-tab-tech]:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                <span class="text-[10px] font-medium group-[.active-tab-tech]:text-blue-500">–°–ª–æ–≤–∞—Ä—å</span>
            </button>
            <button id="nav-train" class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group">
                 <svg class="w-6 h-6 group-[.active-tab-tech]:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span class="text-[10px] font-medium group-[.active-tab-tech]:text-blue-500">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
            </button>
            <button id="nav-stats" class="flex flex-col items-center gap-1 transition-all text-gray-400 hover:text-gray-900 dark:hover:text-white group">
                <svg class="w-6 h-6 group-[.active-tab-tech]:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <span class="text-[10px] font-medium group-[.active-tab-tech]:text-blue-500">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
            </button>
        </div>
    </nav>

    <datalist id="folder-list"></datalist><datalist id="level-list"></datalist><datalist id="subfolder-list"></datalist>

    <script>
        const escapeStr = (str) => (str||'').replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "&quot;");
        const API_URL = '/words';
        let currentType = 'noun';
        let editId = null;
        let globalWords = [];
        
        let sessionStartMs = 0;
        const DAILY_GOAL_MINUTES = 15;
        const MAX_SCORE = 6; 
        
        let dictTabFilter = 'active'; 
        let trainDirection = 'auto'; 
        let currentIsGermanQuestion = false;
        let currentArticle = 'der';
        let collapsedDictTopics = {};

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        }

        async function apiFetch(url, options = {}) {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error('Network Error');
            return res;
        }

        const getLevelColor = (level) => {
            if (!level) return 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400';
            const l = level.toUpperCase().replace(/–ê/g, 'A').replace(/–í/g, 'B').replace(/–°/g, 'C');
            if (l.includes('A1')) return 'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-400';
            if (l.includes('A2')) return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';
            if (l.includes('B1')) return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400';
            if (l.includes('B2')) return 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400';
            if (l.includes('C1')) return 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';
            return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
        };

        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        const updateIcons = () => {
            if (document.documentElement.classList.contains('dark')) {
                darkIcon.classList.add('hidden'); lightIcon.classList.remove('hidden');
            } else {
                lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden');
            }
        };
        updateIcons();

        themeToggleBtn.onclick = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateIcons();
        };

        window.speakWord = (text, event) => {
            if (event) event.stopPropagation();
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text); u.lang = 'de-DE'; u.rate = 0.85;
            window.speechSynthesis.speak(u);
        };

        window.activeInput = null;
        document.addEventListener('focusin', e => { if(e.target.tagName === 'INPUT') window.activeInput = e.target; });

        window.insertChar = (char, event) => {
            event.preventDefault(); 
            if (!window.activeInput) return;
            const start = window.activeInput.selectionStart;
            const end = window.activeInput.selectionEnd;
            const val = window.activeInput.value;
            window.activeInput.value = val.slice(0, start) + char + val.slice(end);
            window.activeInput.selectionStart = window.activeInput.selectionEnd = start + 1;
            window.activeInput.dispatchEvent(new Event('input'));
        };

        const handleEnter = (e) => {
            if (e.key === 'Enter') {
                const btnCheck = document.getElementById('btn-check-manual');
                const btnNext = document.getElementById('btn-show-answer');
                
                if (btnCheck && !btnCheck.disabled && !document.getElementById('train-manual-block').classList.contains('hidden')) {
                    e.preventDefault();
                    btnCheck.click();
                } else if (btnNext && !btnNext.classList.contains('hidden')) {
                    e.preventDefault();
                    btnNext.click();
                }
            }
        };
        document.addEventListener('keydown', handleEnter);

        function saveSessionTime() {
            if (sessionStartMs > 0) {
                const elapsedMs = Date.now() - sessionStartMs;
                const tzoffset = (new Date()).getTimezoneOffset() * 60000;
                const localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 10);
                try {
                    let history = JSON.parse(localStorage.getItem('studyHistory')) || {};
                    if (!history[localISOTime]) history[localISOTime] = 0;
                    history[localISOTime] += elapsedMs;
                    localStorage.setItem('studyHistory', JSON.stringify(history));
                } catch(e) {}
                sessionStartMs = 0;
            }
        }

        const views = { dict: document.getElementById('view-dict'), train: document.getElementById('view-train'), stats: document.getElementById('view-stats') };
        const navBtns = { dict: document.getElementById('nav-dict'), train: document.getElementById('nav-train'), stats: document.getElementById('nav-stats') };
        const isWordDue = (w) => Date.now() >= (w.next_review || 0);

        async function fetchWords() {
            try {
                const res = await apiFetch(API_URL); 
                const data = await res.json();
                if (Array.isArray(data)) {
                    globalWords = data;
                    localStorage.setItem('offline_words_db', JSON.stringify(globalWords)); 
                }
            } catch (e) { 
                console.warn("–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º. –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏.");
                try {
                    const saved = localStorage.getItem('offline_words_db');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        if (Array.isArray(parsed)) globalWords = parsed;
                    }
                } catch(err) {}
            }
            
            if (!Array.isArray(globalWords)) globalWords = [];
            try {
                document.getElementById('folder-list').innerHTML = [...new Set(globalWords.map(w => w.folder))].filter(Boolean).map(f => `<option value="${escapeStr(f)}">`).join('');
                document.getElementById('level-list').innerHTML = [...new Set(globalWords.map(w => w.level).filter(Boolean))].map(l => `<option value="${escapeStr(l)}">`).join('');
                document.getElementById('subfolder-list').innerHTML = [...new Set(globalWords.map(w => w.subfolder))].filter(Boolean).map(s => `<option value="${escapeStr(s)}">`).join('');
            } catch(e) {}
        }

        async function switchView(target) {
            if (target !== 'train') saveSessionTime();

            Object.keys(views).forEach(v => {
                const isActive = (v === target);
                views[v].classList.toggle('hidden', !isActive);
                navBtns[v].classList.toggle('active-tab-tech', isActive);
            });
            document.getElementById('header-title').innerText = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
            document.getElementById('add-btn').classList.toggle('hidden', target !== 'dict');
            
            await fetchWords();
            document.getElementById('header-title').innerText = {dict:'–°–ª–æ–≤–∞—Ä—å', train:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', stats:'–ü—Ä–æ–≥—Ä–µ—Å—Å'}[target];
            
            try {
                if (target === 'dict') renderDict();
                if (target === 'train') setupTrainMenu();
                if (target === 'stats') loadStats();
            } catch(e) { console.error(e); }
            
            window.scrollTo(0, 0);
        }

        navBtns.dict.onclick = () => switchView('dict');
        navBtns.train.onclick = () => switchView('train');
        navBtns.stats.onclick = () => switchView('stats');

        window.selectArticle = (art) => {
            currentArticle = art;
            const btns = { der: document.getElementById('btn-art-der'), die: document.getElementById('btn-art-die'), das: document.getElementById('btn-art-das') };
            Object.values(btns).forEach(b => {
                b.className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-500 font-medium transition-all text-sm hover:bg-gray-100 dark:hover:bg-gray-700";
            });
            if (art === 'der') btns.der.className = "flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium transition-all shadow-sm text-sm";
            else if (art === 'die') btns.die.className = "flex-1 py-2 rounded-lg border-2 border-red-500 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium transition-all shadow-sm text-sm";
            else if (art === 'das') btns.das.className = "flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-medium transition-all shadow-sm text-sm";
        };

        const wordInp = document.getElementById('word-de');
        wordInp.oninput = () => {
            if (currentType !== 'noun') return;
            const w = wordInp.value.trim().toLowerCase();
            let g = null;
            if (w.match(/(ung|heit|keit|schaft|tion|t√§t|ik|ur|enz|anz|ie|e)$/)) g = 'die';
            else if (w.match(/(chen|lein|ment|um|ma|nis|o)$/)) g = 'das';
            else if (w.match(/(ismus|ling|ig|or|ist|ant|ent|er)$/)) g = 'der';
            if (g && currentArticle !== g) selectArticle(g);
        };

        document.getElementById('dict-tab-active').onclick = () => {
            dictTabFilter = 'active';
            document.getElementById('dict-tab-active').className = "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white";
            document.getElementById('dict-tab-mastered').className = "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 transition-all flex items-center justify-center gap-1 hover:text-gray-700 dark:hover:text-gray-300";
            renderDict();
        };

        document.getElementById('dict-tab-mastered').onclick = () => {
            dictTabFilter = 'mastered';
            document.getElementById('dict-tab-mastered').className = "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all flex items-center justify-center gap-1 text-gray-900 dark:text-white";
            document.getElementById('dict-tab-active').className = "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            renderDict();
        };

        const searchInp = document.getElementById('search-input');
        searchInp.oninput = () => {
            if (searchInp.value.trim().length > 0) collapsedDictTopics = {};
            renderDict(searchInp.value.toLowerCase());
        };

        window.toggleTopic = (topicKey) => {
            collapsedDictTopics[topicKey] = !collapsedDictTopics[topicKey];
            renderDict(searchInp.value.toLowerCase());
        };

        function renderDict(query = searchInp.value.toLowerCase()) {
            const container = document.getElementById('dict-list');
            try {
                let filtered = globalWords.filter(w => (w.word_de || "").toLowerCase().includes(query) || (w.word_ru || "").toLowerCase().includes(query));
                if (dictTabFilter === 'active') filtered = filtered.filter(w => w.score < MAX_SCORE);
                else filtered = filtered.filter(w => w.score >= MAX_SCORE);

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="text-center py-20"><p class="text-gray-400 font-medium text-sm">${dictTabFilter==='mastered'?'–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç üòî':'–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Ç–µ–∫—É—â–∏–µ —Å–ª–æ–≤–∞ –≤—ã—É—á–µ–Ω—ã üéâ'}</p></div>`;
                    return;
                }

                const colors = { der: 'text-der', die: 'text-die', das: 'text-das' };
                const grouped = {};
                filtered.forEach(w => { 
                    const f = w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞';
                    const l = w.level || '–û–±—â–µ–µ';
                    const s = w.subfolder || '–ë–µ–∑ —Ç–µ–º—ã';
                    if (!grouped[f]) grouped[f] = {}; 
                    if (!grouped[f][l]) grouped[f][l] = {}; 
                    if (!grouped[f][l][s]) grouped[f][l][s] = []; 
                    grouped[f][l][s].push(w); 
                });

                let savedFolderOrder = [];
                let savedTopicOrder = {};
                try { savedFolderOrder = JSON.parse(localStorage.getItem('folderOrder')) || []; } catch(e){}
                try { savedTopicOrder = JSON.parse(localStorage.getItem('topicOrder')) || {}; } catch(e){}

                const folderNames = Object.keys(grouped).sort((a, b) => {
                    let idxA = savedFolderOrder.indexOf(a); let idxB = savedFolderOrder.indexOf(b);
                    if (idxA === -1) idxA = 9999; if (idxB === -1) idxB = 9999;
                    return idxA - idxB;
                });

                let html = '<div id="dict-folders-container">';
                folderNames.forEach(f => {
                    const safeF = escapeStr(f);
                    html += `
                    <div class="dict-folder mb-6 bg-white dark:bg-gray-900 rounded-[1.5rem] shadow-sm border border-gray-100 dark:border-gray-800 overflow-hidden" data-folder="${safeF}">
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 p-4 border-b border-gray-100 dark:border-gray-800">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="cursor-move drag-handle-folder text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                                </div>
                                <h2 class="text-base font-bold text-gray-900 dark:text-white truncate">${f}</h2>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <button onclick="renameFolder('${safeF}')" class="p-2 text-gray-400 hover:text-blue-500 transition-colors" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫—É—Ä—Å">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                                <button onclick="fastAddCourse('${safeF}')" class="text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-blue-100 active:scale-95 transition-all">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="dict-topics-container p-2 space-y-2" data-folder="${safeF}">
                    `;
                    
                    let topics = [];
                    for (const l in grouped[f]) {
                        for (const s in grouped[f][l]) {
                            topics.push({ l, s, words: grouped[f][l][s], key: `${f}|${l}|${s}` });
                        }
                    }

                    topics.sort((a, b) => {
                        let orderArr = savedTopicOrder[f] || [];
                        let idxA = orderArr.indexOf(a.key); let idxB = orderArr.indexOf(b.key);
                        if (idxA === -1) idxA = 9999; if (idxB === -1) idxB = 9999;
                        return idxA - idxB;
                    });

                    topics.forEach(t => {
                        const l = t.l; const s = t.s; const wordsInTopic = t.words; const topicKey = t.key;
                        const safeL = escapeStr(l); const safeS = escapeStr(s); const safeTopicKey = escapeStr(topicKey);
                        if (collapsedDictTopics[topicKey] === undefined) collapsedDictTopics[topicKey] = true; 
                        const isCollapsed = collapsedDictTopics[topicKey];
                        const chevronClass = isCollapsed ? '' : 'rotate-180';

                        html += `
                        <div class="dict-topic bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 overflow-hidden transition-all" data-topic="${safeTopicKey}">
                            <div class="flex justify-between items-center p-3 pr-2 transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div class="flex items-center gap-2 min-w-0 flex-1">
                                    <div class="cursor-move drag-handle-topic text-gray-400 hover:text-gray-600 p-1 -ml-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                                    </div>
                                    <div class="flex items-center gap-2 min-w-0 flex-1 cursor-pointer" onclick="toggleTopic('${safeTopicKey}')">
                                        <svg class="w-4 h-4 text-gray-400 transition-transform ${chevronClass} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        ${l !== '–û–±—â–µ–µ' ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md flex-shrink-0 ${getLevelColor(l)}">${l}</span>` : ''}
                                        <h3 class="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">${s} <span class="text-gray-400 font-normal">(${wordsInTopic.length})</span></h3>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 pl-2">
                                    <button onclick="renameSubfolder('${safeF}', '${safeL}', '${safeS}'); event.stopPropagation();" class="p-1.5 text-gray-400 hover:text-blue-500 transition-colors" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button onclick="fastAdd('${safeF}', '${safeL}', '${safeS}'); event.stopPropagation();" class="text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100 active:scale-95 transition-all">+ –°–ª–æ–≤–æ</button>
                                    <button onclick="deleteFolder('${safeF}', '${safeL}', '${safeS}'); event.stopPropagation();" class="text-red-400 p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-all" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>

                            <div class="${isCollapsed ? 'hidden' : 'p-2 space-y-1.5 bg-gray-50 dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800'}">
                        `;
                        
                        wordsInTopic.forEach(w => {
                            let extraInfo = '';
                            if (w.word_type === 'noun' && w.plural) extraInfo = `(pl. ${w.plural})`;
                            else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) extraInfo = `(${w.praeteritum || '-'}, ${w.partizip || '-'})`;
                            const safeWordDe = escapeStr(w.word_de);

                            html += `
                            <div onclick="openEdit(${w.id})" class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 flex justify-between items-center active:scale-[0.99] transition-all cursor-pointer hover:border-blue-200">
                                <div class="flex-1 pr-3 min-w-0">
                                    <p class="text-base font-bold text-gray-900 dark:text-white leading-tight truncate">${w.word_type==='noun'?`<span class="${colors[w.article]} font-normal mr-1">${w.article}</span>`:''}${w.word_de} <span class="text-gray-400 text-xs font-normal ml-1">${extraInfo}</span></p>
                                    <p class="text-gray-500 text-sm font-medium mt-0.5 truncate">${w.word_ru}</p>
                                    ${w.example ? `<p class="text-[11px] text-gray-400 mt-1 italic leading-tight truncate">"${escapeStr(w.example)}"</p>` : ''}
                                </div>
                                <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                    <div class="flex gap-1 mb-1">
                                        <button onclick="speakWord('${(w.word_type==='noun'?w.article+' ':'')+safeWordDe}', event)" class="p-2 bg-gray-50 dark:bg-gray-700 rounded-full text-gray-400 hover:text-blue-500 transition-colors">üîä</button>
                                        <button onclick="deleteWord(${w.id}, event)" class="p-2 bg-gray-50 dark:bg-gray-700 rounded-full text-gray-400 hover:text-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                    <span class="text-xs font-bold ${w.score>=MAX_SCORE?'text-green-500':(w.score>=4?'text-orange-500':'text-gray-400')}">${Math.min(w.score, MAX_SCORE)}/${MAX_SCORE}</span>
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    });
                    html += `</div></div>`; 
                });
                html += '</div>'; 
                
                container.innerHTML = html;
                setTimeout(initSortable, 100);
            } catch(err) { container.innerHTML = `<div class="text-center py-20 text-red-500">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à.</div>`; }
        }

        function initSortable() {
            if (typeof Sortable === 'undefined') { setTimeout(initSortable, 500); return; }
            const folderContainer = document.getElementById('dict-folders-container');
            if (folderContainer) {
                new Sortable(folderContainer, {
                    handle: '.drag-handle-folder', animation: 250, delay: 150, delayOnTouchOnly: true, ghostClass: 'sortable-ghost',
                    onEnd: function () {
                        const order = Array.from(folderContainer.querySelectorAll('.dict-folder')).map(el => el.dataset.folder);
                        localStorage.setItem('folderOrder', JSON.stringify(order));
                    }
                });
            }
            document.querySelectorAll('.dict-topics-container').forEach(topicContainer => {
                new Sortable(topicContainer, {
                    handle: '.drag-handle-topic', animation: 250, delay: 150, delayOnTouchOnly: true, ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        const f = evt.item.closest('.dict-folder').dataset.folder;
                        const order = Array.from(topicContainer.querySelectorAll('.dict-topic')).map(el => el.dataset.topic);
                        let savedTopicOrder = {};
                        try { savedTopicOrder = JSON.parse(localStorage.getItem('topicOrder')) || {}; } catch(e){}
                        savedTopicOrder[f] = order; localStorage.setItem('topicOrder', JSON.stringify(savedTopicOrder));
                    }
                });
            });
        }

        window.renameFolder = async (oldFolder) => {
            const newFolder = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∫—É—Ä—Å–∞ "${oldFolder}":`, oldFolder);
            if (newFolder && newFolder.trim() !== '' && newFolder.trim() !== oldFolder) {
                try {
                    await apiFetch('/words/rename_folder', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({old_folder: oldFolder, new_folder: newFolder.trim()}) });
                    await fetchWords(); renderDict();
                } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!'); }
            }
        };

        window.renameSubfolder = async (f, l, oldS) => {
            const newS = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–º—ã "${oldS}":`, oldS);
            if (newS && newS.trim() !== '' && newS.trim() !== oldS) {
                try {
                    await apiFetch('/words/rename_subfolder', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({folder: f, level: l, old_subfolder: oldS, new_subfolder: newS.trim()}) });
                    const oldKey = `${f}|${l}|${oldS}`; const newKey = `${f}|${l}|${newS.trim()}`;
                    if (collapsedDictTopics[oldKey] !== undefined) { collapsedDictTopics[newKey] = collapsedDictTopics[oldKey]; delete collapsedDictTopics[oldKey]; }
                    await fetchWords(); renderDict();
                } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!'); }
            }
        };

        const modal = document.getElementById('add-modal');
        const setType = (t) => {
            currentType = t;
            document.getElementById('type-noun').className = t === 'noun' ? "flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded-md bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('type-verb').className = t === 'verb' ? "flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded-md bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white" : "flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('article-selector').classList.toggle('hidden', t === 'verb');
            document.getElementById('plural-input-group').classList.toggle('hidden', t === 'verb');
            const verbGroup = document.getElementById('verb-forms-group');
            if(verbGroup) verbGroup.classList.toggle('hidden', t !== 'verb');
        };

        document.getElementById('type-noun').onclick = () => setType('noun');
        document.getElementById('type-verb').onclick = () => setType('verb');

        const showSingleTab = () => {
            document.getElementById('form-single').classList.remove('hidden'); document.getElementById('form-bulk').classList.add('hidden');
            document.getElementById('tab-single').className = "flex-1 py-2 text-sm font-medium rounded-lg bg-white dark:bg-gray-700 shadow-sm transition-all text-gray-900 dark:text-white";
            document.getElementById('tab-bulk').className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
        };
        const showBulkTab = () => {
            document.getElementById('form-bulk').classList.remove('hidden'); document.getElementById('form-single').classList.add('hidden');
            // –ó–µ–ª–µ–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤–∫–ª–∞–¥–∫–∏ CSV
            document.getElementById('tab-bulk').className = "flex-1 py-2 text-sm font-bold rounded-lg bg-green-500 text-white shadow-md shadow-green-500/40 transition-all transform scale-[1.02]";
            document.getElementById('tab-single').className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 transition-all hover:text-gray-700 dark:hover:text-gray-300";
        };

        document.getElementById('tab-single').onclick = showSingleTab;
        document.getElementById('tab-bulk').onclick = showBulkTab;

        document.getElementById('add-btn').onclick = () => { 
            editId = null; document.getElementById('modal-title').innerText = "–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ"; 
            document.getElementById('add-form').reset(); 
            document.getElementById('bulk-folder').value = ''; document.getElementById('bulk-level').value = ''; document.getElementById('bulk-subfolder').value = ''; 
            const bulkFile = document.getElementById('bulk-file'); if(bulkFile) bulkFile.value = '';
            const bulkLabel = document.getElementById('bulk-file-label'); if(bulkLabel) bulkLabel.innerText = '–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª';
            setType('noun'); showSingleTab(); selectArticle('der'); modal.classList.remove('hidden'); 
        };
        document.getElementById('close-modal').onclick = () => modal.classList.add('hidden');
        
        window.openEdit = (id) => {
            const w = globalWords.find(x => x.id === id); if(!w) return;
            editId = w.id; document.getElementById('modal-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"; showSingleTab();
            setType(w.word_type); if(w.word_type === 'noun') selectArticle(w.article || 'der');
            document.getElementById('word-de').value = w.word_de; document.getElementById('word-ru').value = w.word_ru;
            document.getElementById('word-plural').value = w.plural || ""; document.getElementById('word-praeteritum').value = w.praeteritum || "";
            document.getElementById('word-partizip').value = w.partizip || ""; document.getElementById('word-example').value = w.example || "";
            document.getElementById('word-folder').value = w.folder; document.getElementById('word-level').value = w.level || ""; document.getElementById('word-subfolder').value = w.subfolder;
            modal.classList.remove('hidden');
        };

        window.fastAdd = (folder, level, subfolder) => {
            editId = null; document.getElementById('modal-title').innerText = "–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ";
            document.getElementById('add-form').reset(); setType('noun'); showSingleTab(); selectArticle('der');
            const lvl = level === '–û–±—â–µ–µ' ? '' : level;
            document.getElementById('word-folder').value = folder; document.getElementById('word-level').value = lvl; document.getElementById('word-subfolder').value = subfolder;
            document.getElementById('bulk-folder').value = folder; document.getElementById('bulk-level').value = lvl; document.getElementById('bulk-subfolder').value = subfolder;
            modal.classList.remove('hidden'); setTimeout(() => document.getElementById('word-de').focus(), 150);
        };

        window.fastAddCourse = (folder) => {
            editId = null; document.getElementById('modal-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É / —Å–ª–æ–≤–∞";
            document.getElementById('add-form').reset(); setType('noun'); showSingleTab(); selectArticle('der');
            document.getElementById('word-folder').value = folder; document.getElementById('word-level').value = ''; document.getElementById('word-subfolder').value = ''; 
            document.getElementById('bulk-folder').value = folder; document.getElementById('bulk-level').value = ''; document.getElementById('bulk-subfolder').value = ''; 
            modal.classList.remove('hidden'); setTimeout(() => document.getElementById('word-subfolder').focus(), 150);
        };

        window.deleteWord = async (id, event) => { 
            if (event) event.stopPropagation(); 
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –Ω–∞–≤—Å–µ–≥–¥–∞?')) { await apiFetch(`${API_URL}/${id}`, { method: 'DELETE' }); await fetchWords(); renderDict(); } 
        };

        window.deleteFolder = async (f, l, s) => {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É "${s}" —Å–æ –≤—Å–µ–º–∏ —Å–ª–æ–≤–∞–º–∏ –≤–Ω—É—Ç—Ä–∏?`)) {
                await apiFetch('/words/delete_folder', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({folder: f, level: l, subfolder: s}) });
                await fetchWords(); renderDict();
            }
        };

        document.getElementById('add-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                word_type: currentType, article: currentType==='noun' ? currentArticle : '',
                word_de: document.getElementById('word-de').value.trim(), plural: currentType==='noun' ? document.getElementById('word-plural').value.trim() : '',
                praeteritum: currentType==='verb' ? document.getElementById('word-praeteritum').value.trim() : '', partizip: currentType==='verb' ? document.getElementById('word-partizip').value.trim() : '',
                word_ru: document.getElementById('word-ru').value.trim(), example: document.getElementById('word-example').value.trim(),
                folder: document.getElementById('word-folder').value.trim(), level: document.getElementById('word-level').value.trim(), subfolder: document.getElementById('word-subfolder').value.trim()
            };
            const url = editId ? `${API_URL}/${editId}/full` : API_URL;
            await apiFetch(url, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            modal.classList.add('hidden'); searchInp.value = ''; 
            const newTopicKey = `${payload.folder}|${payload.level || '–û–±—â–µ–µ'}|${payload.subfolder}`; collapsedDictTopics[newTopicKey] = false;
            await fetchWords(); renderDict();
        };

        document.getElementById('btn-upload-csv').onclick = async () => {
            const f = new FormData(); 
            const folder = document.getElementById('bulk-folder').value.trim(); const level = document.getElementById('bulk-level').value.trim(); const subfolder = document.getElementById('bulk-subfolder').value.trim(); const fileInput = document.getElementById('bulk-file');
            if (!folder || !subfolder || !fileInput.files[0]) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫—É—Ä—Å, —Ç–µ–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");
            f.append('folder', folder); f.append('level', level); f.append('subfolder', subfolder); f.append('file', fileInput.files[0]);
            
            const btn = document.getElementById('btn-upload-csv'); btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...'; btn.disabled = true;
            try {
                await apiFetch('/upload_csv', { method: 'POST', body: f }); modal.classList.add('hidden'); 
                const newTopicKey = `${folder}|${level || '–û–±—â–µ–µ'}|${subfolder}`; collapsedDictTopics[newTopicKey] = false;
                await fetchWords(); renderDict();
            } catch(e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!"); }
            finally { btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞'; btn.disabled = false; }
        };

        document.getElementById('bulk-file').onchange = function() {
            const label = document.getElementById('bulk-file-label');
            if(this.files[0]) label.innerText = this.files[0].name; else label.innerText = '–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª';
        };

        window.exportData = () => { window.location.href = `/export_csv`; };

        let trainList = []; let curIdx = 0;

        window.setDirection = (dir) => {
            trainDirection = dir;
            const activeCls = "flex-1 py-2 text-[10px] font-bold rounded-lg bg-white dark:bg-gray-700 text-blue-500 shadow-sm transition-all uppercase";
            const inactiveCls = "flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 transition-all uppercase hover:text-gray-700 dark:hover:text-gray-300";
            document.getElementById('dir-auto').className = dir === 'auto' ? activeCls : inactiveCls;
            document.getElementById('dir-ru-de').className = dir === 'ru-de' ? activeCls : inactiveCls;
            document.getElementById('dir-de-ru').className = dir === 'de-ru' ? activeCls : inactiveCls;
        };
        
        function setupTrainMenu() {
            const container = document.getElementById('train-topics-container');
            try {
                container.innerHTML = '';
                const newWordsCount = globalWords.filter(w => w.score < MAX_SCORE && isWordDue(w)).length;
                const masteredCount = globalWords.filter(w => w.score >= MAX_SCORE).length;
                const waitingCount = globalWords.filter(w => w.score < MAX_SCORE && !isWordDue(w)).length;
                const weakWordsCount = globalWords.filter(w => w.score < 4 && isWordDue(w)).length;

                let html = `
                    <button onclick="startTraining('all')" class="w-full text-left bg-gradient-to-br from-blue-500 to-indigo-600 hover:scale-[0.98] transition-all p-5 rounded-2xl shadow-md text-white flex justify-between items-center group mb-3">
                        <div>
                            <h3 class="text-lg font-bold">–°–ª–æ–≤–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                            <p class="text-blue-100 text-[11px] font-medium mt-1">–î–æ—Å—Ç—É–ø–Ω–æ: ${newWordsCount} ${waitingCount>0?`| –û–∂–∏–¥–∞—é—Ç: ${waitingCount}`:''}</p>
                        </div>
                        <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                    </button>
                `;

                if (weakWordsCount > 0) {
                    html += `
                        <button onclick="startTraining('weak')" class="w-full text-left bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800/50 hover:scale-[0.98] transition-all p-4 rounded-xl flex justify-between items-center group mb-3">
                            <div>
                                <h3 class="text-orange-700 dark:text-orange-400 text-sm font-bold">–°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞</h3>
                                <p class="text-orange-600/70 dark:text-orange-500/70 text-[10px] font-medium mt-0.5">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è: ${weakWordsCount}</p>
                            </div>
                            <div class="text-orange-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>
                        </button>
                    `;
                }

                if (masteredCount > 0) {
                    html += `
                        <button onclick="startTraining('mastered')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center group mb-3">
                            <div>
                                <h3 class="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2">üèÜ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞—Ä—Ö–∏–≤</h3>
                                <p class="text-gray-500 text-[10px] font-medium mt-0.5">–ò–∑—É—á–µ–Ω–æ: ${masteredCount}</p>
                            </div>
                            <div class="text-gray-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        </button>
                    `;
                }

                const groupedTopics = {};
                globalWords.forEach(w => {
                    const f = w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞'; const key = `${w.folder}|${w.level||'–û–±—â–µ–µ'}|${w.subfolder}`;
                    if (!groupedTopics[f]) groupedTopics[f] = new Set(); groupedTopics[f].add(key);
                });

                const activeTopicsHTML = []; const masteredTopicsHTML = [];

                for (const folder in groupedTopics) {
                    const courseWords = globalWords.filter(w => (w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞') === folder);
                    const cWordsCount = courseWords.filter(w => w.score < MAX_SCORE && isWordDue(w)).length;
                    
                    let folderActiveHTML = '';
                    if (cWordsCount > 0) {
                        folderActiveHTML += `
                            <button onclick="startTraining('course|${escapeStr(folder)}')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-2 mt-4 flex justify-between items-center group">
                                <div>
                                    <h3 class="text-sm font-bold text-gray-900 dark:text-white">${folder} (–í–µ—Å—å –∫—É—Ä—Å)</h3>
                                    <p class="text-[11px] text-gray-500 font-medium mt-0.5">–î–æ—Å—Ç—É–ø–Ω–æ: ${cWordsCount}</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700 w-8 h-8 rounded-full flex items-center justify-center text-gray-400"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                            </button>
                        `;
                    } else {
                        folderActiveHTML += `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-5 mb-2 ml-1">${folder}</h3>`;
                    }

                    let folderMasteredHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-5 mb-2 ml-1">${folder}</h3>`;
                    let hasActive = false; let hasMastered = false;

                    groupedTopics[folder].forEach(t => {
                        const [f, l, s] = t.split('|');
                        const allInTopic = globalWords.filter(w => w.folder === f && (w.level||'–û–±—â–µ–µ') === l && w.subfolder === s);
                        const wordsCount = allInTopic.filter(w => w.score < MAX_SCORE && isWordDue(w)).length;
                        const waitingCount = allInTopic.filter(w => w.score < MAX_SCORE && !isWordDue(w)).length;
                        const archivedCount = allInTopic.filter(w => w.score >= MAX_SCORE).length;
                        
                        if (wordsCount === 0 && waitingCount === 0 && archivedCount > 0) {
                            hasMastered = true;
                            folderMasteredHTML += `
                                <button onclick="startTraining('${escapeStr(t)}', true)" class="w-full text-left bg-gray-50 dark:bg-gray-800/40 hover:scale-[0.98] transition-all p-3 rounded-lg border border-gray-100 dark:border-gray-800 flex justify-between items-center mb-1.5 opacity-70">
                                    <div>
                                        <div class="flex items-center gap-2 mb-0.5">
                                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400 line-through">${s}</h3>
                                        </div>
                                        <p class="text-xs text-gray-400">–í –∞—Ä—Ö–∏–≤–µ: ${archivedCount}</p>
                                    </div>
                                    <div class="text-green-500">‚úì</div>
                                </button>
                            `;
                        } else {
                            hasActive = true;
                            folderActiveHTML += `
                                <button onclick="startTraining('${escapeStr(t)}')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-3 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center mb-1.5 ml-2 w-[calc(100%-8px)]">
                                    <div>
                                        <div class="flex items-center gap-2 mb-0.5">
                                            ${l !== '–û–±—â–µ–µ' ? `<span class="text-[10px] font-bold px-1.5 py-0.5 rounded-md ${getLevelColor(l)}">${l}</span>` : ''}
                                            <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">${s}</h3>
                                        </div>
                                        <p class="text-xs text-gray-500">–°–ª–æ–≤: ${wordsCount} <span class="opacity-60">${waitingCount>0?`| –û–∂–∏–¥–∞—é—Ç: ${waitingCount}`:''}</span></p>
                                    </div>
                                    <div class="text-gray-400"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                                </button>
                            `;
                        }
                    });

                    if (hasActive) activeTopicsHTML.push(folderActiveHTML);
                    if (hasMastered) masteredTopicsHTML.push(folderMasteredHTML);
                }

                container.innerHTML = html + activeTopicsHTML.join('') + (masteredTopicsHTML.length > 0 ? '<div class="mt-6 border-t border-gray-200 dark:border-gray-800 pt-4"></div><h2 class="text-sm font-bold text-center text-gray-500 mb-3">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ç–µ–º—ã</h2>' + masteredTopicsHTML.join('') : '');
                document.getElementById('train-setup-block').classList.remove('hidden'); document.getElementById('train-card-block').classList.add('hidden');
            } catch(err) { console.error(err); }
        }

        window.startTraining = (sel, forceArchive = false) => {
            let availableWords = globalWords.filter(w => w.score < MAX_SCORE && isWordDue(w));

            if (sel === 'all') { trainList = availableWords; } 
            else if (sel === 'weak') { trainList = availableWords.filter(w => w.score < 4); }
            else if (sel.startsWith('course|')) { const courseName = sel.split('|')[1]; trainList = availableWords.filter(w => (w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞') === courseName); }
            else if (sel === 'mastered' || forceArchive) { 
                if (forceArchive) { const [f, l, s] = sel.split('|'); trainList = globalWords.filter(w => w.folder === f && (w.level||'–û–±—â–µ–µ') === l && w.subfolder === s); } 
                else { trainList = globalWords.filter(w => w.score >= MAX_SCORE); }
            }
            else { const [f, l, s] = sel.split('|'); trainList = availableWords.filter(w => w.folder === f && (w.level||'–û–±—â–µ–µ') === l && w.subfolder === s); }
            
            if (!trainList.length) return alert('–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Å–ª–æ–≤ –Ω–µ—Ç! –û—Ç–¥—ã—Ö–∞–π.');
            trainList.sort(() => 0.5 - Math.random()); curIdx = 0; sessionStartMs = Date.now();
            document.getElementById('train-setup-block').classList.add('hidden'); document.getElementById('train-card-block').classList.remove('hidden'); renderCard();
        };

        document.getElementById('btn-stop-training').onclick = () => { saveSessionTime(); setupTrainMenu(); };

        function renderCard() {
            const cardBlock = document.getElementById('train-card-block');
            cardBlock.classList.remove('animate-fold-up'); 

            if (curIdx >= trainList.length) { 
                saveSessionTime(); document.getElementById('main-scroll').scrollTo(0, 0); setupTrainMenu(); return; 
            }
            
            const w = trainList[curIdx]; 
            const qEl = document.getElementById('train-question'); const exQ = document.getElementById('train-example-q'); const badge = document.getElementById('train-level-badge');
            
            document.getElementById('train-total-cards').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${trainList.length - curIdx}`;
            document.getElementById('train-card-progress-text').innerText = `–û—Å–≤–æ–µ–Ω–æ: ${Math.min(w.score, MAX_SCORE)}/${MAX_SCORE}`;
            document.getElementById('train-card-progress-fill').style.width = `${Math.min(100, (w.score / MAX_SCORE) * 100)}%`;
            
            document.getElementById('train-answer-block').classList.add('hidden'); document.getElementById('train-manual-block').classList.add('hidden'); 
            document.getElementById('btn-show-answer').classList.add('hidden'); document.getElementById('manual-feedback').classList.add('hidden');
            document.getElementById('train-de-plural').classList.add('hidden');
            if(exQ) { exQ.classList.add('hidden'); exQ.className = "text-sm text-gray-500 dark:text-gray-400 italic mb-5 hidden px-2 leading-relaxed block"; }

            const manArt = document.getElementById('manual-article'); const manMain = document.getElementById('manual-main'); 
            const manPluralContainer = document.getElementById('manual-plural-container'); const manPlural = document.getElementById('manual-plural');
            const manVerbContainer = document.getElementById('manual-verb-forms-container'); const manPraet = document.getElementById('manual-praeteritum'); const manPart = document.getElementById('manual-partizip');
            const btnCheck = document.getElementById('btn-check-manual'); const umlautBar = document.getElementById('train-umlauts');
            const btnSpeakQ = document.getElementById('btn-speak-question'); const btnSpeakAns = document.getElementById('btn-speak-answer'); const btnMic = document.getElementById('btn-mic');

            if(manArt) manArt.disabled = false; if(manMain) manMain.disabled = false; if(manPlural) manPlural.disabled = false;
            if(manPraet) manPraet.disabled = false; if(manPart) manPart.disabled = false; if(btnCheck) btnCheck.disabled = false;

            const fullGerman = (w.word_type==='noun' ? (w.article||'') + ' ' : '') + (w.word_de||'');
            let state = w.score < 4 ? 'L1' : w.score < 6 ? 'L2' : 'Archive';

            if (trainDirection === 'de-ru') currentIsGermanQuestion = true; 
            else if (trainDirection === 'ru-de') currentIsGermanQuestion = false; 
            else currentIsGermanQuestion = state === 'L2' ? false : Math.random() > 0.5;

            if (currentIsGermanQuestion) {
                if(btnSpeakQ) { btnSpeakQ.classList.remove('hidden'); btnSpeakQ.onclick = (e) => speakWord(fullGerman, e); }
                if(btnSpeakAns) btnSpeakAns.classList.add('hidden');
            } else {
                if(btnSpeakQ) btnSpeakQ.classList.add('hidden');
                if(btnSpeakAns) { btnSpeakAns.classList.remove('hidden'); btnSpeakAns.onclick = (e) => speakWord(fullGerman, e); }
            }

            if (recognition && btnMic) {
                btnMic.classList.remove('hidden');
                btnMic.onclick = () => {
                    recognition.lang = currentIsGermanQuestion ? 'ru-RU' : 'de-DE'; recognition.start();
                    btnMic.classList.add('text-red-500', 'animate-pulse'); btnMic.classList.remove('text-gray-400');
                };
                recognition.onresult = (event) => {
                    let transcript = event.results[0][0].transcript.replace(/[.,!?]$/, '').trim();
                    if (!currentIsGermanQuestion && w.word_type === 'noun') {
                        const parts = transcript.split(' '); const art = parts[0].toLowerCase();
                        if (['der', 'die', 'das'].includes(art)) { manArt.value = art; manMain.value = parts.slice(1).join(' '); } else manMain.value = transcript;
                    } else manMain.value = transcript;
                };
                recognition.onend = () => { btnMic.classList.remove('text-red-500', 'animate-pulse'); btnMic.classList.add('text-gray-400'); };
                recognition.onerror = () => { btnMic.classList.remove('text-red-500', 'animate-pulse'); btnMic.classList.add('text-gray-400'); };
            } else if (btnMic) { btnMic.classList.add('hidden'); }

            const ansEx = document.getElementById('train-answer-example');
            if (w.example && ansEx) { ansEx.innerText = '"' + w.example + '"'; ansEx.classList.remove('hidden'); } else if (ansEx) ansEx.classList.add('hidden');

            document.getElementById('train-de-word').innerText = currentIsGermanQuestion ? (w.word_ru||'') : fullGerman;
            if (w.word_type === 'noun' && w.plural) document.getElementById('train-de-plural').innerText = `–º–Ω. —á.: die ${w.plural}`;
            else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) document.getElementById('train-de-plural').innerText = `–§–æ—Ä–º—ã: ${w.praeteritum || '-'}, ${w.partizip || '-'}`;

            if (state === 'L1' || state === 'Archive') {
                if(badge) { 
                    if (state === 'Archive') { badge.innerText = "–ê—Ä—Ö–∏–≤"; badge.className = "px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-gray-100 dark:bg-gray-800 text-gray-500"; } 
                    else { badge.innerText = `–£–∑–Ω–∞–≤–∞–Ω–∏–µ (${w.score}/4)`; badge.className = "px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400"; }
                }
                if(qEl) qEl.innerText = currentIsGermanQuestion ? fullGerman : (w.word_ru||''); 
                document.getElementById('btn-show-answer').classList.remove('hidden');
            } else if (state === 'L2') {
                if(badge) { badge.innerText = `–ü–∏—Å—å–º–æ (${w.score === 4 ? '1/2' : '–§–∏–Ω–∞–ª'})`; badge.className = "px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400"; }
                if(qEl) qEl.innerText = currentIsGermanQuestion ? fullGerman : (w.word_ru||'');
                if(!currentIsGermanQuestion && w.example && exQ) { 
                    try { const safeWord = (w.word_de||'').replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); exQ.innerHTML = escapeStr(w.example).replace(new RegExp(safeWord, 'ig'), '_____'); } catch(e) { exQ.innerHTML = escapeStr(w.example); }
                    exQ.classList.remove('hidden'); 
                }
                
                document.getElementById('train-manual-block').classList.remove('hidden');
                
                if (currentIsGermanQuestion) {
                    if(manArt) manArt.classList.add('hidden'); 
                    if(manMain) { manMain.value = ''; manMain.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥..."; }
                    if(manPluralContainer) manPluralContainer.classList.add('hidden'); if(manVerbContainer) manVerbContainer.classList.add('hidden'); if(umlautBar) umlautBar.classList.add('hidden'); 
                    setTimeout(() => { if(manMain) manMain.focus() }, 150);
                } else {
                    if(manArt) { manArt.classList.remove('hidden'); manArt.classList.toggle('hidden', w.word_type==='verb'); manArt.value = ''; }
                    if(manMain) { manMain.value = ''; manMain.placeholder = "–°–ª–æ–≤–æ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º..."; }
                    if (w.word_type === 'noun' && w.plural) { if(manPluralContainer) manPluralContainer.classList.remove('hidden'); if(manPlural) manPlural.value = ''; } else { if(manPluralContainer) manPluralContainer.classList.add('hidden'); }
                    if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) { if(manVerbContainer) manVerbContainer.classList.remove('hidden'); if(manPraet) manPraet.value = ''; if(manPart) manPart.value = ''; } else { if(manVerbContainer) manVerbContainer.classList.add('hidden'); }
                    if(umlautBar) umlautBar.classList.remove('hidden'); 
                    setTimeout(() => { const target = w.word_type==='noun' ? document.getElementById('manual-article') : document.getElementById('manual-main'); if (target) target.focus(); }, 150);
                }
            }
        }

        async function updateScore(newScore, isCorrect) {
            const cardBlock = document.getElementById('train-card-block');
            cardBlock.classList.add('animate-fold-up');

            let nextReviewMs = 0;
            if (isCorrect) {
                const now = Date.now();
                if (newScore <= 1) nextReviewMs = now + 12 * 3600000; 
                else if (newScore === 2) nextReviewMs = now + 86400000; 
                else if (newScore === 3) nextReviewMs = now + 3 * 86400000; 
                else if (newScore === 4) nextReviewMs = now + 7 * 86400000; 
                else if (newScore === 5) nextReviewMs = now + 14 * 86400000; 
                else nextReviewMs = now + 30 * 86400000; 
            }
            
            try { await apiFetch(`${API_URL}/${trainList[curIdx].id}/score`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({score: newScore, next_review: nextReviewMs})}); } catch (e) {}
            const gwItem = globalWords.find(gw => gw.id === trainList[curIdx].id); if(gwItem) { gwItem.score = newScore; gwItem.next_review = nextReviewMs; }
            trainList[curIdx].score = newScore; 
            localStorage.setItem('offline_words_db', JSON.stringify(globalWords)); 
            
            curIdx++; setTimeout(renderCard, 250);
        }

        document.getElementById('btn-show-answer').onclick = () => { 
            document.getElementById('btn-show-answer').classList.add('hidden'); document.getElementById('train-answer-block').classList.remove('hidden'); 
            const w = trainList[curIdx]; if (w.word_type === 'noun' && w.plural) document.getElementById('train-de-plural').classList.remove('hidden'); else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) document.getElementById('train-de-plural').classList.remove('hidden');
        };
        
        document.getElementById('btn-forgot').onclick = () => updateScore(0, false); 
        document.getElementById('btn-remembered').onclick = () => { const w = trainList[curIdx]; updateScore(Math.min(w.score + 1, MAX_SCORE), true); };
        
        document.getElementById('btn-check-manual').onclick = () => {
            const w = trainList[curIdx]; 
            const art = (document.getElementById('manual-article').value || "").trim().toLowerCase(); 
            const main = (document.getElementById('manual-main').value || "").trim();
            const typedPlural = (document.getElementById('manual-plural').value || "").trim().toLowerCase();
            const typedPraet = (document.getElementById('manual-praeteritum').value || "").trim().toLowerCase();
            const typedPart = (document.getElementById('manual-partizip').value || "").trim().toLowerCase();
            
            const feedback = document.getElementById('manual-feedback'); const btnCheck = document.getElementById('btn-check-manual');
            let isCorrect = false; let correctAnswer = "";

            if (!currentIsGermanQuestion) {
                const expectedArt = (w.article ? w.article.toLowerCase() : ""); const expectedWord = (w.word_de ? w.word_de.toLowerCase() : "");
                const expectedPlural = (w.plural ? w.plural.toLowerCase() : ""); const expectedPraet = (w.praeteritum ? w.praeteritum.toLowerCase() : ""); const expectedPart = (w.partizip ? w.partizip.toLowerCase() : "");
                
                if (w.word_type === 'noun') {
                    if (w.plural) { isCorrect = (art === expectedArt) && (main.toLowerCase() === expectedWord) && (typedPlural === expectedPlural); correctAnswer = `${w.article} ${w.word_de} (die ${w.plural})`; } 
                    else { isCorrect = (art === expectedArt) && (main.toLowerCase() === expectedWord); correctAnswer = `${w.article} ${w.word_de}`; }
                } else if (w.word_type === 'verb') {
                    let baseCorrect = (main.toLowerCase() === expectedWord); let formsCorrect = true;
                    if (w.praeteritum || w.partizip) { formsCorrect = (typedPraet === expectedPraet) && (typedPart === expectedPart); correctAnswer = `${w.word_de} (${w.praeteritum}, ${w.partizip})`; } 
                    else { correctAnswer = w.word_de; }
                    isCorrect = baseCorrect && formsCorrect;
                } else { isCorrect = main.toLowerCase() === expectedWord; correctAnswer = w.word_de; }
            } else { const expectedWord = (w.word_ru ? w.word_ru.toLowerCase() : ""); isCorrect = main.toLowerCase() === expectedWord; correctAnswer = w.word_ru; }

            document.getElementById('manual-article').disabled = true; document.getElementById('manual-main').disabled = true; document.getElementById('manual-plural').disabled = true; document.getElementById('manual-praeteritum').disabled = true; document.getElementById('manual-partizip').disabled = true; btnCheck.disabled = true;
            feedback.className = "w-full text-center py-3 rounded-xl font-medium text-sm mb-3 transition-all animate-in fade-in zoom-in duration-200 border";

            if (isCorrect) {
                feedback.classList.add('bg-green-50', 'text-green-600', 'border-green-200', 'dark:bg-green-900/20', 'dark:border-green-800'); feedback.innerText = "–í–µ—Ä–Ω–æ!"; feedback.classList.remove('hidden');
                setTimeout(() => updateScore(Math.min(w.score + 1, MAX_SCORE), true), 1000);
            } else {
                feedback.classList.add('bg-red-50', 'text-red-600', 'border-red-200', 'dark:bg-red-900/20', 'dark:border-red-800'); feedback.innerText = `–û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correctAnswer}`; feedback.classList.remove('hidden');
                setTimeout(() => updateScore(0, false), 2500);
            }
        };

        document.getElementById('btn-trigger-restore').onclick = () => document.getElementById('file-restore').click();
        
        document.getElementById('file-restore').onchange = async function() {
            if(!this.files[0]) return;
            if(!confirm("–í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç –≤–∞—à—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) { this.value = ''; return; }
            const f = new FormData(); f.append('file', this.files[0]);
            const btn = document.getElementById('btn-trigger-restore'); const originalText = btn.innerHTML; btn.innerHTML = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...'; btn.disabled = true;
            try {
                const res = await apiFetch('/restore_backup', { method: 'POST', body: f }); const result = await res.json();
                if(result.status === 'success') { document.getElementById('backup-modal').classList.add('hidden'); alert(`–£—Å–ø–µ—à–Ω–æ! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${result.restored}`); await fetchWords(); loadStats(); } 
                else alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!");
            } catch(e) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞."); } finally { btn.innerHTML = originalText; btn.disabled = false; this.value = ''; }
        };

        window.resetFolderStats = async (f, l, s) => {
            if(confirm(`–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–º—ã "${s}"?`)){
                await apiFetch('/words/reset_folder', {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({folder:f, level:l, subfolder:s})}); await fetchWords(); loadStats();
            }
        };

        function loadStats() {
            const stats = document.getElementById('view-stats');
            try {
                const total = globalWords.length; 
                const mastered = globalWords.filter(w => w.score >= MAX_SCORE).length;
                const pctMastery = total === 0 ? 0 : Math.round((mastered / total) * 100);

                let statusLevel = "–ù–æ–≤–∏—á–æ–∫ (A1)";
                if (mastered > 50) statusLevel = "–°—Ç—É–¥–µ–Ω—Ç (A2)";
                if (mastered > 200) statusLevel = "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (B1)";
                if (mastered > 500) statusLevel = "–ü—Ä–æ—Ñ–∏ (B2+)";

                const folders = {};
                globalWords.forEach(w => { 
                    const k = `${w.folder}|${w.level||'–û–±—â–µ–µ'}|${w.subfolder}`; 
                    if(!folders[k]) folders[k] = {f:w.folder, l:w.level||'–û–±—â–µ–µ', s:w.subfolder, total:0, done:0}; 
                    folders[k].total++; if(w.score>=MAX_SCORE) folders[k].done++; 
                });

                const sortedFolders = Object.values(folders).sort((a, b) => {
                    const pctA = a.done / a.total; const pctB = b.done / b.total;
                    if (pctB !== pctA) return pctA - pctB; return a.s.localeCompare(b.s); 
                });

                let history = {}; try { history = JSON.parse(localStorage.getItem('studyHistory')) || {}; } catch(e){}
                
                let streak = 0;
                let d = new Date(); let tz = d.getTimezoneOffset() * 60000;
                let todayIso = new Date(d.getTime() - tz).toISOString().slice(0, 10);
                d.setDate(d.getDate() - 1); let yesterdayIso = new Date(d.getTime() - tz).toISOString().slice(0, 10);

                let checkD = new Date();
                if (history[todayIso] > 0) {} 
                else if (history[yesterdayIso] > 0) { checkD.setDate(checkD.getDate() - 1); } 
                else { checkD = null; }

                if (checkD) {
                    while (true) {
                        let iso = new Date(checkD.getTime() - checkD.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
                        if (history[iso] > 0) { streak++; checkD.setDate(checkD.getDate() - 1); } else { break; }
                    }
                }

                const daysHtml = []; const maxDailyMs = DAILY_GOAL_MINUTES * 60000;
                let minutesToday = Math.floor((history[todayIso] || 0) / 60000);

                for (let i = 6; i >= 0; i--) {
                    let iterD = new Date(); iterD.setDate(iterD.getDate() - i); let tzIter = iterD.getTimezoneOffset() * 60000;
                    let iso = new Date(iterD.getTime() - tzIter).toISOString().slice(0, 10);
                    let ms = history[iso] || 0; let pct = Math.min(100, (ms / maxDailyMs) * 100);
                    let dayName = ['–í–°', '–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë'][iterD.getDay()];
                    
                    daysHtml.push(`
                        <div class="flex flex-col items-center gap-2">
                             <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-24 relative overflow-hidden">
                                <div class="absolute bottom-0 left-0 right-0 bg-blue-500 transition-all duration-1000 rounded-full" style="height: ${pct}%"></div>
                            </div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase">${dayName}</span>
                        </div>
                    `);
                }

                // –õ–æ–≥–∏–∫–∞ –ê—á–∏–≤–æ–∫
                const achievements = [
                    { id: 'first_word', title: '–ü–µ—Ä–≤—ã–π —à–∞–≥', desc: '–í—ã—É—á–∏—Ç—å 1 —Å–ª–æ–≤–æ', check: mastered >= 1, icon: 'üåü', color: 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400' },
                    { id: 'words_50', title: '–°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å', desc: '50 —Å–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ', check: mastered >= 50, icon: 'üìö', color: 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' },
                    { id: 'words_200', title: '–ü–æ–ª–∏–≥–ª–æ—Ç', desc: '200 —Å–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ', check: mastered >= 200, icon: 'üß†', color: 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400' },
                    { id: 'streak_3', title: '–í —Ä–∏—Ç–º–µ', desc: '–£—á–∏—Ç—å 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥', check: streak >= 3, icon: 'üî•', color: 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400' },
                    { id: 'streak_7', title: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü', desc: '–£—á–∏—Ç—å 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', check: streak >= 7, icon: '‚ö°', color: 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' },
                    { id: 'goal_met', title: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', desc: '–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ü–µ–ª—å –Ω–∞ –¥–µ–Ω—å', check: minutesToday >= DAILY_GOAL_MINUTES, icon: 'üéØ', color: 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' }
                ];

                const achievementsHtml = achievements.map(a => {
                    const isUnlocked = a.check;
                    const bgClass = isUnlocked ? 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow-sm' : 'bg-gray-50 dark:bg-gray-800/40 border-dashed border-gray-200 dark:border-gray-700 opacity-60 grayscale';
                    const iconBg = isUnlocked ? a.color : 'bg-gray-200 text-gray-500 dark:bg-gray-700';
                    return `
                    <div class="${bgClass} p-3 rounded-xl border flex items-center gap-3 transition-all">
                        <div class="${iconBg} w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0">${a.icon}</div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-900 dark:text-white leading-tight">${a.title}</h4>
                            <p class="text-[10px] font-medium text-gray-500 mt-0.5">${a.desc}</p>
                        </div>
                    </div>`;
                }).join('');

                stats.innerHTML = `
                    <div class="flex flex-col items-center mb-8 mt-2">
                        <div class="w-48 h-48 relative flex items-center justify-center mb-4">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="96" cy="96" r="88" stroke="currentColor" class="text-gray-100 dark:text-gray-800" stroke-width="12" fill="none"/>
                                <circle cx="96" cy="96" r="88" stroke="currentColor" class="text-blue-500 transition-all duration-1000 ease-out" stroke-width="12" fill="none" stroke-dasharray="552.9" stroke-dashoffset="${552.9 * (1 - pctMastery / 100)}" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                <span class="text-gray-400 text-xs font-medium uppercase tracking-widest mb-1">–û—Å–≤–æ–µ–Ω–æ</span>
                                <span class="text-5xl font-black text-gray-900 dark:text-white tracking-tighter leading-none">${pctMastery}%</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 px-4 py-1.5 rounded-full border border-blue-100 dark:border-blue-800/50">
                            <span class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest">–°—Ç–∞—Ç—É—Å: ${statusLevel}</span>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-5 rounded-[1.5rem] shadow-sm border border-gray-100 dark:border-gray-700 mb-8">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (7 –¥–Ω–µ–π)</h3>
                             <span class="text-xs font-bold text-gray-400">–¶–µ–ª—å: ${DAILY_GOAL_MINUTES} –º–∏–Ω</span>
                        </div>
                        <div class="grid grid-cols-7 gap-2">
                            ${daysHtml.join('')}
                        </div>
                    </div>
                    
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 ml-2">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                    <div class="grid grid-cols-2 gap-3 mb-8">
                        ${achievementsHtml}
                    </div>

                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 ml-2">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-4">
                        ${sortedFolders.map(dat => {
                            const pct = Math.round((dat.done / dat.total) * 100);
                            const isDone = pct === 100;
                            const barColor = isDone ? 'bg-green-500' : 'bg-blue-500';
                            const textColor = isDone ? 'text-green-600 dark:text-green-400' : 'text-gray-900 dark:text-white';
                            
                            return `
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 relative flex flex-col justify-between overflow-hidden">
                                <button onclick="resetFolderStats('${escapeStr(dat.f)}', '${escapeStr(dat.l)}', '${escapeStr(dat.s)}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors z-10" title="–°–±—Ä–æ—Å–∏—Ç—å">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                </button>
                                
                                <div class="relative z-10 mb-5">
                                    <div class="flex items-center gap-2 mb-2 pr-6">
                                        ${dat.l !== '–û–±—â–µ–µ' ? `<span class="text-[9px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-md ${getLevelColor(dat.l)}">${dat.l}</span>` : ''}
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest truncate">${dat.f}</span>
                                    </div>
                                    <h4 class="font-bold text-base ${textColor} pr-4">${dat.s}</h4>
                                </div>
                                
                                <div class="relative z-10 mt-auto">
                                    <div class="flex justify-between items-end mb-2">
                                        <span class="text-xl font-black ${isDone ? 'text-green-500' : 'text-blue-500'}">${pct}%</span>
                                        <span class="text-xs font-medium text-gray-400">${dat.done} / ${dat.total}</span>
                                    </div>
                                    <div class="w-full bg-gray-100 dark:bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="${barColor} h-full transition-all duration-1000 ease-out" style="width: ${pct}%"></div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    
                    <button onclick="document.getElementById('backup-modal').classList.remove('hidden')" class="w-full mb-4 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-2xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all flex justify-center items-center gap-2 shadow-sm border border-gray-100 dark:border-gray-700 text-sm active:scale-95">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> 
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                    </button>
                `;
            } catch(err) {}
        }

        switchView('dict');
    </script>
</body>
</html>