<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>W√∂rterbuch Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { der: '#3b82f6', die: '#ef4444', das: '#10b981' } } } };
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; -webkit-tap-highlight-color: transparent; height: 100dvh; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .dark .glass { background: rgba(17, 24, 39, 0.85); border-color: rgba(255,255,255,0.05); }
        .active-tab { color: #3b82f6; transform: translateY(-2px); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-[#f2f2f7] dark:bg-black text-gray-900 dark:text-white transition-colors duration-300 min-h-screen flex flex-col overflow-hidden">

    <div class="hidden bg-teal-100 text-teal-700 dark:bg-teal-900/40 dark:text-teal-400 bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400 bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-400 bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-400 bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400 bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-400 bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400 line-through grayscale opacity-60 bg-emerald-500 text-emerald-50 text-teal-500"></div>

    <header class="fixed top-0 left-0 right-0 pt-12 pb-3 px-4 glass border-b border-gray-200 dark:border-gray-800 z-40 transition-all">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <h1 id="header-title" class="text-xl font-extrabold tracking-tight">–°–ª–æ–≤–∞—Ä—å</h1>
            <div class="flex items-center gap-3">
                <button id="theme-toggle" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
                </button>
                <button id="add-btn" class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md shadow-blue-500/30 hover:scale-105 active:scale-95 transition-all text-lg font-medium">+</button>
            </div>
        </div>
    </header>

   <main id="main-scroll" class="pt-24 pb-24 max-w-2xl mx-auto px-3 w-full overflow-y-auto">
        
        <section id="view-dict" class="pt-4 pb-10">
            <div class="mb-4">
                <div class="relative group">
                    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ (–Ω–µ–º / —Ä—É—Å)..." autocomplete="off" class="w-full bg-white dark:bg-gray-900 border-none rounded-xl py-2.5 pl-9 shadow-sm outline-none focus:ring-2 ring-blue-500 transition-all dark:text-white text-sm">
                    <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            
            <div class="flex bg-gray-200/50 dark:bg-gray-800/80 p-1 rounded-xl mb-4">
                <button id="dict-tab-active" class="flex-1 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm dark:text-white transition-all">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
                <button id="dict-tab-mastered" class="flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 dark:text-gray-400 transition-all flex items-center justify-center gap-1">–ê—Ä—Ö–∏–≤ üèÜ</button>
            </div>

            <div id="dict-list">
                <div class="text-center py-20"><p class="text-gray-400 font-bold text-sm animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
            </div>
        </section>

        <section id="view-train" class="hidden relative pt-4 pb-10">
            <div id="train-setup-block" class="w-full animate-in fade-in slide-in-from-bottom-4 duration-300 sm:mt-16">
                <div class="flex bg-gray-200/50 dark:bg-gray-800/80 p-1 rounded-xl mb-4 mt-2 gap-1">
                    <button id="dir-auto" onclick="setDirection('auto')" class="flex-1 py-2 text-[10px] font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm text-blue-500 border border-blue-500 transition-all">üß† –ú–∏–∫—Å</button>
                    <button id="dir-ru-de" onclick="setDirection('ru-de')" class="flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 dark:text-gray-400 border border-transparent transition-all">üá∑üá∫ ‚ûî üá©üá™</button>
                    <button id="dir-de-ru" onclick="setDirection('de-ru')" class="flex-1 py-2 text-[10px] font-bold rounded-lg text-gray-500 dark:text-gray-400 border border-transparent transition-all">üá©üá™ ‚ûî üá∑üá∫</button>
                </div>
                <div id="train-topics-container" class="space-y-3"></div>
            </div>

            <div id="train-card-block" class="hidden w-full bg-white dark:bg-gray-900 p-5 rounded-[1.5rem] shadow-xl text-center relative flex flex-col transition-all border border-gray-100 dark:border-gray-800 mt-2 sm:mt-24">
                <button id="btn-stop-training" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 bg-gray-50 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold z-10">√ó</button>
                
                <div class="mb-3"><span id="train-level-badge" class="px-2.5 py-0.5 rounded-md text-[9px] font-black uppercase tracking-widest bg-blue-100 text-blue-600">LEVEL 1</span></div>
                
                <div class="mb-5 w-full px-1">
                    <div class="flex justify-between text-[9px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider">
                        <span id="train-card-progress-text">–û—á–∫–∏: 0/6</span>
                        <span id="train-total-cards">–°–ª–æ–≤: 0</span>
                    </div>
                    <div class="w-full bg-gray-100 dark:bg-gray-800 h-1.5 rounded-full overflow-hidden relative">
                        <div class="absolute left-[66.6%] top-0 bottom-0 w-0.5 bg-white dark:bg-gray-900 z-10 opacity-60"></div>
                        <div id="train-card-progress-fill" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="relative w-full flex justify-center items-center min-h-[40px] mb-2 px-10">
                    <h2 id="train-question" class="text-xl sm:text-2xl font-black dark:text-white leading-tight tracking-tight m-0 text-center break-words">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <div class="absolute right-0 top-1/2 -translate-y-1/2">
                        <button id="btn-speak-question" class="hidden bg-gray-50 dark:bg-gray-800 w-8 h-8 rounded-full flex items-center justify-center text-gray-500 dark:text-gray-400 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all shadow-sm text-base">üîä</button>
                    </div>
                </div>
                
                <p id="train-example-q" class="text-[11px] text-gray-400 italic mb-5 hidden px-2 leading-relaxed"></p>
                
                <button id="btn-show-answer" class="w-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-xl active:scale-95 transition-all mt-2 text-sm">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                
                <div id="train-answer-block" class="hidden w-full mt-3">
                    <div class="flex flex-col justify-center items-center mb-5">
                        <div class="relative w-full flex justify-center items-center min-h-[40px] px-10">
                            <p id="train-de-word" class="text-lg sm:text-xl font-bold dark:text-white leading-tight tracking-tight m-0 text-center"></p>
                            <div class="absolute right-0 top-1/2 -translate-y-1/2">
                                <button id="btn-speak-answer" class="hidden bg-blue-50 dark:bg-blue-900/30 w-8 h-8 rounded-full flex items-center justify-center text-blue-500 hover:scale-110 transition-transform shadow-sm text-base">üîä</button>
                            </div>
                        </div>
                        <p id="train-de-plural" class="text-[11px] font-bold text-gray-500 mt-1 hidden"></p>
                        <p id="train-answer-example" class="text-[11px] text-blue-500/80 dark:text-blue-400 italic font-medium mt-3 hidden px-2 leading-relaxed"></p>
                    </div>

                    <div class="flex gap-2">
                        <button id="btn-forgot" class="flex-1 bg-red-50 dark:bg-red-900/20 text-red-500 font-bold py-2.5 rounded-xl border border-red-100 dark:border-red-900/30 active:scale-95 transition-all text-sm">–ó–∞–±—ã–ª (–°–±—Ä–æ—Å)</button>
                        <button id="btn-remembered" class="flex-1 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 font-bold py-2.5 rounded-xl border border-green-100 dark:border-green-900/30 active:scale-95 transition-all text-sm">–ü–æ–º–Ω—é</button>
                    </div>
                </div>

                <div id="train-manual-block" class="hidden w-full mt-3">
                    <div class="flex gap-2 mb-2 w-full">
                        <input type="text" id="manual-article" placeholder="der" autocomplete="off" class="w-[60px] bg-gray-50 dark:bg-gray-800 rounded-lg py-2.5 px-1 text-center outline-none focus:ring-2 ring-blue-500 dark:text-white font-bold transition-all shadow-inner disabled:opacity-50 min-w-0 text-sm" style="text-align-last: center;">
                        
                        <div class="flex-1 relative flex items-center min-w-0">
                            <input type="text" id="manual-main" placeholder="–°–ª–æ–≤–æ..." autocomplete="off" class="w-full bg-gray-50 dark:bg-gray-800 rounded-lg py-2.5 pl-3 pr-10 outline-none focus:ring-2 ring-blue-500 dark:text-white font-bold transition-all shadow-inner disabled:opacity-50 min-w-0 text-sm">
                            <button id="btn-mic" type="button" class="absolute right-1 p-2 text-gray-400 hover:text-blue-500 transition-colors rounded-md active:scale-90" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-2 w-full hidden" id="manual-plural-container">
                        <div class="bg-gray-100 dark:bg-gray-800/50 rounded-lg py-2.5 px-1 text-center outline-none font-bold text-gray-400 dark:text-gray-500 w-[60px] min-w-0 flex items-center justify-center text-xs">die</div>
                        <input type="text" id="manual-plural" placeholder="–ú–Ω. —á–∏—Å–ª–æ..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-2.5 px-3 outline-none focus:ring-2 ring-blue-500 dark:text-white font-bold transition-all shadow-inner disabled:opacity-50 min-w-0 text-sm">
                    </div>

                    <div class="flex gap-2 mb-2 w-full hidden" id="manual-verb-forms-container">
                        <input type="text" id="manual-praeteritum" placeholder="Pr√§teritum (machte)" autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-2.5 px-2 text-center outline-none focus:ring-2 ring-blue-500 dark:text-white font-bold transition-all shadow-inner disabled:opacity-50 min-w-0 text-xs">
                        <input type="text" id="manual-partizip" placeholder="Partizip II (gemacht)" autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-lg py-2.5 px-2 text-center outline-none focus:ring-2 ring-blue-500 dark:text-white font-bold transition-all shadow-inner disabled:opacity-50 min-w-0 text-xs">
                    </div>

                    <div id="manual-feedback" class="hidden w-full text-center py-2.5 rounded-lg font-bold text-sm mb-2 transition-all animate-in fade-in zoom-in duration-200"></div>

                    <div id="train-umlauts" class="flex justify-center gap-1.5 mb-3">
                        <button type="button" tabindex="-1" onmousedown="insertChar('√§', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-sm dark:text-white shadow-sm hover:bg-gray-200 active:scale-90">√§</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√∂', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-sm dark:text-white shadow-sm hover:bg-gray-200 active:scale-90">√∂</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√º', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-sm dark:text-white shadow-sm hover:bg-gray-200 active:scale-90">√º</button>
                        <button type="button" tabindex="-1" onmousedown="insertChar('√ü', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-sm dark:text-white shadow-sm hover:bg-gray-200 active:scale-90">√ü</button>
                    </div>
                    <button id="btn-check-manual" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-all disabled:opacity-50 text-sm">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>
        </section>

        <section id="view-stats" class="hidden pb-10 space-y-3 pt-4 sm:mt-8"></section>
    </main>

    <div id="backup-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden flex justify-center items-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-3xl p-5 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 text-center animate-in zoom-in-95 duration-200 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-black dark:text-white">–î–∞–Ω–Ω—ã–µ</h2>
                <button onclick="document.getElementById('backup-modal').classList.add('hidden')" class="text-gray-400 bg-gray-100 dark:bg-gray-800 w-7 h-7 rounded-full flex items-center justify-center font-bold">√ó</button>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-5 text-left leading-relaxed">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –µ–≥–æ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.</p>
            <button onclick="exportData()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 mb-4 hover:scale-105 active:scale-95 transition-all flex justify-center items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø
            </button>
            <div class="relative mb-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100 dark:border-gray-800"></div></div>
                <div class="relative flex justify-center text-xs"><span class="px-2 bg-white dark:bg-gray-900 text-gray-400">–∏–ª–∏</span></div>
            </div>
            <button id="btn-trigger-restore" class="w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold py-3 rounded-xl hover:scale-105 active:scale-95 transition-all flex justify-center items-center gap-2 border border-gray-200 dark:border-gray-700 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É
            </button>
            <input type="file" id="file-restore" accept=".csv" class="hidden">
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden flex justify-center items-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-gray-900 w-full max-w-lg rounded-[2rem] p-5 shadow-2xl transition-all border border-gray-100 dark:border-gray-800 max-h-[90dvh] flex flex-col relative" onclick="event.stopPropagation()">
            
            <div class="flex justify-between items-center mb-3 flex-shrink-0">
                <h2 id="modal-title" class="text-xl font-black dark:text-white tracking-tight">–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ</h2>
                <button id="close-modal" class="text-gray-400 bg-gray-100 dark:bg-gray-800 w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg hover:text-red-500 transition-colors">√ó</button>
            </div>
            
            <div class="overflow-y-auto pr-1 -mr-1 pb-1">
                <div id="modal-tabs" class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg mb-3">
                    <button id="tab-single" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-gray-700 shadow-sm dark:text-white transition-all">–û–¥–Ω–æ —Å–ª–æ–≤–æ</button>
                    <button id="tab-bulk" class="flex-1 py-1.5 text-xs font-bold rounded-md text-gray-500 dark:text-gray-400 transition-all">–ü–∞—á–∫–∞ (CSV)</button>
                </div>
                
                <div id="form-single">
                    <div class="flex bg-gray-50 dark:bg-gray-800/50 p-1 rounded-lg mb-3 border border-gray-100 dark:border-gray-800">
                        <button id="type-noun" class="flex-1 py-1.5 text-[9px] font-black tracking-widest rounded-md bg-white dark:bg-gray-600 shadow-sm dark:text-white transition-all">–°–£–©–ï–°–¢–í–ò–¢–ï–õ–¨–ù–û–ï</button>
                        <button id="type-verb" class="flex-1 py-1.5 text-[9px] font-black tracking-widest text-gray-500 transition-all">–ì–õ–ê–ì–û–õ / –ò–ù–û–ï</button>
                    </div>
                    <form id="add-form" class="space-y-2.5">
                        
                        <div id="article-selector" class="flex gap-1 w-full mb-1">
                            <button type="button" id="btn-art-der" onclick="selectArticle('der')" class="flex-1 py-1.5 rounded-lg border-2 border-blue-500 bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold transition-all shadow-sm transform scale-[1.02] text-sm">der</button>
                            <button type="button" id="btn-art-die" onclick="selectArticle('die')" class="flex-1 py-1.5 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-500 font-bold transition-all shadow-sm text-sm">die</button>
                            <button type="button" id="btn-art-das" onclick="selectArticle('das')" class="flex-1 py-1.5 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-500 font-bold transition-all shadow-sm text-sm">das</button>
                        </div>

                        <div class="flex w-full items-center">
                            <input type="text" id="word-de" placeholder="–°–ª–æ–≤–æ (–Ω–∞–ø—Ä. Tisch)..." required autocomplete="off" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none focus:ring-2 ring-blue-500 font-bold dark:text-white transition-all text-sm">
                        </div>
                        
                        <div class="flex gap-2 w-full" id="plural-input-group">
                            <div class="bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-1 text-center outline-none font-bold text-gray-400 dark:text-gray-500 w-[60px] min-w-0 flex items-center justify-center text-xs">die</div>
                            <input type="text" id="word-plural" placeholder="–ú–Ω. —á–∏—Å–ª–æ (Plural)..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none focus:ring-2 ring-blue-500 font-bold dark:text-white transition-all min-w-0 text-sm">
                        </div>

                        <div class="flex gap-2 w-full hidden" id="verb-forms-group">
                            <input type="text" id="word-praeteritum" placeholder="Pr√§teritum (machte)..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none focus:ring-2 ring-blue-500 font-bold dark:text-white transition-all min-w-0 text-sm">
                            <input type="text" id="word-partizip" placeholder="Partizip II (gemacht)..." autocomplete="off" class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none focus:ring-2 ring-blue-500 font-bold dark:text-white transition-all min-w-0 text-sm">
                        </div>

                        <div id="add-umlauts" class="flex justify-center gap-1.5 mt-1 mb-1">
                            <button type="button" tabindex="-1" onmousedown="insertChar('√§', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-base dark:text-white shadow-sm hover:bg-gray-200">√§</button>
                            <button type="button" tabindex="-1" onmousedown="insertChar('√∂', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-base dark:text-white shadow-sm hover:bg-gray-200">√∂</button>
                            <button type="button" tabindex="-1" onmousedown="insertChar('√º', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-base dark:text-white shadow-sm hover:bg-gray-200">√º</button>
                            <button type="button" tabindex="-1" onmousedown="insertChar('√ü', event)" class="bg-gray-100 dark:bg-gray-800 w-9 h-9 rounded-lg font-bold text-base dark:text-white shadow-sm hover:bg-gray-200">√ü</button>
                        </div>
                        <input type="text" id="word-ru" placeholder="–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π..." required autocomplete="off" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none focus:ring-2 ring-blue-500 dark:text-white transition-all text-sm">
                        <input type="text" id="word-example" placeholder="–ü—Ä–∏–º–µ—Ä (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none italic text-xs dark:text-gray-300 focus:ring-2 ring-blue-500 transition-all">
                        
                        <div class="flex w-full gap-2">
                            <div class="flex-[2] min-w-0">
                                <input type="text" id="word-folder" list="folder-list" placeholder="–ö—É—Ä—Å" required class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none text-xs font-semibold dark:text-white focus:ring-2 ring-blue-500">
                            </div>
                            <div class="flex-[1] min-w-0">
                                <input type="text" id="word-level" list="level-list" placeholder="–£—Ä." class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-1 outline-none text-xs font-semibold dark:text-white focus:ring-2 ring-blue-500 text-center uppercase">
                            </div>
                            <div class="flex-[2] min-w-0">
                                <input type="text" id="word-subfolder" list="subfolder-list" placeholder="–¢–µ–º–∞" required class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none text-xs font-semibold dark:text-white focus:ring-2 ring-blue-500">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 mt-1 active:scale-95 transition-all text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
                
                <div class="hidden space-y-3" id="form-bulk">
                    <p class="text-[10px] text-gray-500 dark:text-gray-400 text-center mb-2">–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –∫ —Ç–µ–∫—É—â–∏–º.</p>
                    <div class="flex w-full gap-2">
                        <div class="flex-[2] min-w-0">
                            <input type="text" id="bulk-folder" list="folder-list" placeholder="–ö—É—Ä—Å" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none font-bold dark:text-white text-xs">
                        </div>
                        <div class="flex-[1] min-w-0">
                            <input type="text" id="bulk-level" list="level-list" placeholder="–£—Ä." class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-1 outline-none font-bold dark:text-white text-xs text-center uppercase">
                        </div>
                        <div class="flex-[2] min-w-0">
                            <input type="text" id="bulk-subfolder" list="subfolder-list" placeholder="–¢–µ–º–∞" class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2.5 px-3 outline-none font-bold dark:text-white text-xs">
                        </div>
                    </div>
                    <div class="mt-2 p-5 border-2 border-dashed border-green-200 dark:border-green-800/50 bg-green-50/50 dark:bg-green-900/10 rounded-xl text-center transition-all group hover:bg-green-50 dark:hover:bg-green-900/20">
                        <input type="file" id="bulk-file" accept=".csv" class="hidden">
                        <label for="bulk-file" class="cursor-pointer flex flex-col items-center gap-2">
                            <svg class="w-6 h-6 text-green-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span class="text-green-600 dark:text-green-400 font-bold text-xs">–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª</span>
                        </label>
                    </div>
                    <button id="btn-upload-csv" class="w-full bg-green-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-500/40 mt-2 active:scale-95 transition-all text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—á–∫—É</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 w-full glass border-t border-gray-200 dark:border-gray-800 z-30 pt-2 pb-[calc(env(safe-area-inset-bottom,0px)+8px)] px-4">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button id="nav-dict" class="flex flex-col items-center gap-1 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                <span class="text-[9px] font-black uppercase tracking-widest">–°–ª–æ–≤–∞—Ä—å</span>
            </button>
            <button id="nav-train" class="flex flex-col items-center gap-1 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span class="text-[9px] font-black uppercase tracking-widest">–£—á–∏—Ç—å</span>
            </button>
            <button id="nav-stats" class="flex flex-col items-center gap-1 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <span class="text-[9px] font-black uppercase tracking-widest">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
            </button>
        </div>
    </nav>

    <datalist id="folder-list"></datalist><datalist id="level-list"></datalist><datalist id="subfolder-list"></datalist>

    <script>
        const API_URL = '/words';
        let currentType = 'noun';
        let editId = null;
        let globalWords = [];
        
        let sessionStartMs = 0;
        const DAILY_GOAL_MINUTES = 15;
        const MAX_SCORE = 6; 
        
        let dictTabFilter = 'active'; 
        let trainDirection = 'auto'; 
        let currentIsGermanQuestion = false;
        let currentArticle = 'der';

        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –°–û–°–¢–û–Ø–ù–ò–Ø –ü–ê–ü–û–ö
        let collapsedDictTopics = {};

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        }

        async function apiFetch(url, options = {}) {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            return res;
        }

        const getLevelColor = (level) => {
            if (!level) return 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400';
            const l = level.toUpperCase().replace(/–ê/g, 'A').replace(/–í/g, 'B').replace(/–°/g, 'C');
            if (l.includes('A1')) return 'bg-teal-100 text-teal-700 dark:bg-teal-900/40 dark:text-teal-400';
            if (l.includes('A2')) return 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400';
            if (l.includes('B1')) return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-400';
            if (l.includes('B2')) return 'bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-400';
            if (l.includes('C1')) return 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400';
            if (l.includes('C2')) return 'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-400';
            return 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400';
        };

        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        const updateIcons = () => {
            if (document.documentElement.classList.contains('dark')) {
                darkIcon.classList.add('hidden'); lightIcon.classList.remove('hidden');
            } else {
                lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden');
            }
        };
        updateIcons();

        themeToggleBtn.onclick = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateIcons();
        };

        window.speakWord = (text, event) => {
            if (event) event.stopPropagation();
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text); u.lang = 'de-DE'; u.rate = 0.85;
            window.speechSynthesis.speak(u);
        };

        window.activeInput = null;
        document.addEventListener('focusin', e => { if(e.target.tagName === 'INPUT') window.activeInput = e.target; });

        window.insertChar = (char, event) => {
            event.preventDefault(); 
            if (!window.activeInput) return;
            const start = window.activeInput.selectionStart;
            const end = window.activeInput.selectionEnd;
            const val = window.activeInput.value;
            window.activeInput.value = val.slice(0, start) + char + val.slice(end);
            window.activeInput.selectionStart = window.activeInput.selectionEnd = start + 1;
            window.activeInput.dispatchEvent(new Event('input'));
        };

        const handleEnter = (e) => {
            if (e.key === 'Enter') {
                const btnCheck = document.getElementById('btn-check-manual');
                const btnNext = document.getElementById('btn-show-answer');
                
                if (btnCheck && !btnCheck.disabled && !document.getElementById('train-manual-block').classList.contains('hidden')) {
                    e.preventDefault();
                    btnCheck.click();
                } else if (btnNext && !btnNext.classList.contains('hidden')) {
                    e.preventDefault();
                    btnNext.click();
                }
            }
        };
        document.addEventListener('keydown', handleEnter);

        function saveSessionTime() {
            if (sessionStartMs > 0) {
                const elapsedMs = Date.now() - sessionStartMs;
                const tzoffset = (new Date()).getTimezoneOffset() * 60000;
                const localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 10);
                
                let history = JSON.parse(localStorage.getItem('studyHistory')) || {};
                if (!history[localISOTime]) history[localISOTime] = 0;
                history[localISOTime] += elapsedMs;
                
                localStorage.setItem('studyHistory', JSON.stringify(history));
                sessionStartMs = 0;
            }
        }

        const views = { dict: document.getElementById('view-dict'), train: document.getElementById('view-train'), stats: document.getElementById('view-stats') };
        const navBtns = { dict: document.getElementById('nav-dict'), train: document.getElementById('nav-train'), stats: document.getElementById('nav-stats') };

        async function fetchWords() {
            try {
                const res = await apiFetch(API_URL); 
                globalWords = await res.json();
                document.getElementById('folder-list').innerHTML = [...new Set(globalWords.map(w => w.folder))].map(f => `<option value="${f}">`).join('');
                document.getElementById('level-list').innerHTML = [...new Set(globalWords.map(w => w.level).filter(l=>l))].map(l => `<option value="${l}">`).join('');
                document.getElementById('subfolder-list').innerHTML = [...new Set(globalWords.map(w => w.subfolder))].map(s => `<option value="${s}">`).join('');
            } catch (e) { 
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", e); 
            }
        }

        async function switchView(target) {
            if (target !== 'train') saveSessionTime();

            Object.keys(views).forEach(v => {
                const isActive = (v === target);
                views[v].classList.toggle('hidden', !isActive);
                
                if (isActive) {
                    navBtns[v].classList.add('text-blue-500', '-translate-y-0.5');
                    navBtns[v].classList.remove('text-gray-400', 'dark:text-gray-500', 'hover:text-gray-600');
                } else {
                    navBtns[v].classList.remove('text-blue-500', '-translate-y-0.5');
                    navBtns[v].classList.add('text-gray-400', 'dark:text-gray-500', 'hover:text-gray-600');
                }
            });
            document.getElementById('header-title').innerText = {dict:'–°–ª–æ–≤–∞—Ä—å', train:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', stats:'–ü—Ä–æ–≥—Ä–µ—Å—Å'}[target];
            document.getElementById('add-btn').classList.toggle('hidden', target !== 'dict');
            
            await fetchWords();
            
            if (target === 'dict') renderDict();
            if (target === 'train') setupTrainMenu();
            if (target === 'stats') loadStats();
            
            window.scrollTo(0, 0);
        }

        navBtns.dict.onclick = () => switchView('dict');
        navBtns.train.onclick = () => switchView('train');
        navBtns.stats.onclick = () => switchView('stats');

        window.selectArticle = (art) => {
            currentArticle = art;
            const btns = {
                der: document.getElementById('btn-art-der'),
                die: document.getElementById('btn-art-die'),
                das: document.getElementById('btn-art-das')
            };
            
            Object.values(btns).forEach(b => {
                b.className = "flex-1 py-1.5 rounded-lg border-2 border-transparent bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-500 font-bold transition-all shadow-sm text-sm";
            });
            
            if (art === 'der') {
                btns.der.className = "flex-1 py-1.5 rounded-lg border-2 border-blue-500 bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 font-bold transition-all shadow-sm transform scale-[1.02] text-sm";
            } else if (art === 'die') {
                btns.die.className = "flex-1 py-1.5 rounded-lg border-2 border-red-500 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-400 font-bold transition-all shadow-sm transform scale-[1.02] text-sm";
            } else if (art === 'das') {
                btns.das.className = "flex-1 py-1.5 rounded-lg border-2 border-green-500 bg-green-100 dark:bg-green-900/40 text-green-600 dark:text-green-400 font-bold transition-all shadow-sm transform scale-[1.02] text-sm";
            }
        };

        const wordInp = document.getElementById('word-de');
        wordInp.oninput = () => {
            if (currentType !== 'noun') return;
            const w = wordInp.value.trim().toLowerCase();
            let g = null;
            if (w.match(/(ung|heit|keit|schaft|tion|t√§t|ik|ur|enz|anz|ie|e)$/)) g = 'die';
            else if (w.match(/(chen|lein|ment|um|ma|nis|o)$/)) g = 'das';
            else if (w.match(/(ismus|ling|ig|or|ist|ant|ent|er)$/)) g = 'der';
            if (g && currentArticle !== g) { 
                selectArticle(g);
            }
        };

        document.getElementById('dict-tab-active').onclick = () => {
            dictTabFilter = 'active';
            document.getElementById('dict-tab-active').className = "flex-1 py-1.5 text-xs sm:text-sm font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm dark:text-white transition-all";
            document.getElementById('dict-tab-mastered').className = "flex-1 py-1.5 text-xs sm:text-sm font-bold rounded-lg text-gray-500 dark:text-gray-400 transition-all flex items-center justify-center gap-1";
            renderDict();
        };

        document.getElementById('dict-tab-mastered').onclick = () => {
            dictTabFilter = 'mastered';
            document.getElementById('dict-tab-mastered').className = "flex-1 py-1.5 text-xs sm:text-sm font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm dark:text-white transition-all flex items-center justify-center gap-1";
            document.getElementById('dict-tab-active').className = "flex-1 py-1.5 text-xs sm:text-sm font-bold rounded-lg text-gray-500 dark:text-gray-400 transition-all";
            renderDict();
        };

        const searchInp = document.getElementById('search-input');
        searchInp.oninput = () => {
            // –ï—Å–ª–∏ –∏—â–µ–º —Ç–µ–∫—Å—Ç, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ –ø–∞–ø–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (searchInp.value.trim().length > 0) {
                collapsedDictTopics = {};
            }
            renderDict(searchInp.value.toLowerCase());
        };

        window.toggleTopic = (topicKey) => {
            collapsedDictTopics[topicKey] = !collapsedDictTopics[topicKey];
            renderDict(searchInp.value.toLowerCase());
        };

        function renderDict(query = searchInp.value.toLowerCase()) {
            const container = document.getElementById('dict-list');
            
            let filtered = globalWords.filter(w => (w.word_de || "").toLowerCase().includes(query) || (w.word_ru || "").toLowerCase().includes(query));
            if (dictTabFilter === 'active') {
                filtered = filtered.filter(w => w.score < MAX_SCORE);
            } else {
                filtered = filtered.filter(w => w.score >= MAX_SCORE);
            }

            const colors = { der: 'text-der', die: 'text-die', das: 'text-das' };
            const grouped = {};
            filtered.forEach(w => { 
                const f = w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞';
                const l = w.level || '–û–±—â–µ–µ';
                const s = w.subfolder || '–ë–µ–∑ —Ç–µ–º—ã';
                if (!grouped[f]) grouped[f] = {}; 
                if (!grouped[f][l]) grouped[f][l] = {}; 
                if (!grouped[f][l][s]) grouped[f][l][s] = []; 
                grouped[f][l][s].push(w); 
            });

            let html = '';
            for (const f in grouped) {
                html += `<h2 class="text-xl font-extrabold mt-6 mb-2 dark:text-white tracking-tight pl-1 border-b border-gray-200 dark:border-gray-800 pb-2 flex items-center gap-2"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>${f}</h2>`;
                
                for (const l in grouped[f]) {
                    for (const s in grouped[f][l]) {
                        const topicKey = `${f}|${l}|${s}`;
                        
                        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω, —Ç–µ–º–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (true)
                        if (collapsedDictTopics[topicKey] === undefined) {
                            collapsedDictTopics[topicKey] = true; 
                        }
                        
                        const isCollapsed = collapsedDictTopics[topicKey];
                        const chevronClass = isCollapsed ? '' : 'rotate-180';
                        const wordsInTopic = grouped[f][l][s];

                        html += `
                        <div class="mb-2 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden transition-all">
                            
                            <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800/80 p-3 pr-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" onclick="toggleTopic('${topicKey.replace(/'/g,"\\'")}')">
                                <div class="flex items-center gap-2 min-w-0 flex-1">
                                    <svg class="w-4 h-4 text-gray-400 transition-transform ${chevronClass} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    ${l !== '–û–±—â–µ–µ' ? `<span class="text-[9px] font-black uppercase tracking-widest px-1.5 py-0.5 rounded-md flex-shrink-0 ${getLevelColor(l)}">${l}</span>` : ''}
                                    <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300 truncate">${s} <span class="text-gray-400 font-normal">(${wordsInTopic.length})</span></h3>
                                </div>
                                <div class="flex items-center gap-1 pl-2">
                                    <button onclick="fastAdd('${f.replace(/'/g,"\\'")}', '${l.replace(/'/g,"\\'")}', '${s.replace(/'/g,"\\'")}'); event.stopPropagation();" class="text-blue-500 bg-blue-100 dark:bg-blue-900/40 px-2.5 py-1.5 rounded-lg text-[10px] font-black tracking-widest hover:scale-105 active:scale-95 transition-all shadow-sm">+ –°–õ–û–í–û</button>
                                    <button onclick="deleteFolder('${f.replace(/'/g,"\\'")}', '${l.replace(/'/g,"\\'")}', '${s.replace(/'/g,"\\'")}'); event.stopPropagation();" class="text-red-500 p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition-all" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>

                            <div class="${isCollapsed ? 'hidden' : 'p-2 space-y-1.5 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800'}">
                        `;
                        
                        wordsInTopic.forEach(w => {
                            let extraInfo = '';
                            if (w.word_type === 'noun' && w.plural) extraInfo = `(pl. ${w.plural})`;
                            else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) extraInfo = `(${w.praeteritum || '-'}, ${w.partizip || '-'})`;

                            html += `
                            <div onclick="openEdit(${w.id})" class="bg-white dark:bg-gray-900 p-3 rounded-xl border border-gray-100 dark:border-gray-800 flex justify-between items-center active:scale-[0.98] transition-all cursor-pointer group hover:border-blue-200 dark:hover:border-blue-900/50">
                                <div class="flex-1 pr-3 min-w-0">
                                    <p class="text-base font-bold dark:text-white leading-tight truncate">${w.word_type==='noun'?`<span class="${colors[w.article]} font-normal mr-1">${w.article}</span>`:''}${w.word_de} <span class="text-gray-400 text-xs font-normal ml-1">${extraInfo}</span></p>
                                    <p class="text-gray-400 text-xs font-medium mt-0.5 truncate">${w.word_ru}</p>
                                    ${w.example ? `<p class="text-[11px] text-blue-500/80 dark:text-blue-400 mt-1 italic font-medium leading-tight truncate">"${w.example}"</p>` : ''}
                                </div>
                                <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                    <div class="flex gap-1 mb-1">
                                        <button onclick="speakWord('${(w.word_type==='noun'?w.article+' ':'')+w.word_de}', event)" class="p-2 bg-gray-50 dark:bg-gray-800 rounded-full text-gray-400 hover:text-blue-500 transition-colors">üîä</button>
                                        <button onclick="deleteWord(${w.id}, event)" class="p-2 bg-gray-50 dark:bg-gray-800 rounded-full text-gray-400 hover:text-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                    <span class="text-[9px] font-black ${w.score>=MAX_SCORE?'text-das':(w.score>=4?'text-orange-500':'text-gray-300')}">${Math.min(w.score, MAX_SCORE)}/${MAX_SCORE}</span>
                                </div>
                            </div>`;
                        });
                        
                        html += `</div></div>`; // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç–µ–º—ã
                    }
                }
            }
            container.innerHTML = html || `<div class="text-center py-10"><p class="text-gray-400 font-bold text-sm">${dictTabFilter==='mastered'?'–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç üòî':'–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Å–ª–æ–≤–∞ –≤—ã—É—á–µ–Ω—ã üéâ'}</p></div>`;
        }

        const modal = document.getElementById('add-modal');
        const setType = (t) => {
            currentType = t;
            document.getElementById('type-noun').className = t === 'noun' ? "flex-1 py-1.5 text-[9px] font-black tracking-widest rounded-md bg-white dark:bg-gray-600 shadow-sm dark:text-white transition-all" : "flex-1 py-1.5 text-[9px] font-black tracking-widest text-gray-500 transition-all";
            document.getElementById('type-verb').className = t === 'verb' ? "flex-1 py-1.5 text-[9px] font-black tracking-widest rounded-md bg-white dark:bg-gray-600 shadow-sm dark:text-white transition-all" : "flex-1 py-1.5 text-[9px] font-black tracking-widest text-gray-500 transition-all";
            
            document.getElementById('article-selector').classList.toggle('hidden', t === 'verb');
            document.getElementById('plural-input-group').classList.toggle('hidden', t === 'verb');
            
            const verbGroup = document.getElementById('verb-forms-group');
            if(verbGroup) verbGroup.classList.toggle('hidden', t !== 'verb');
        };

        document.getElementById('type-noun').onclick = () => setType('noun');
        document.getElementById('type-verb').onclick = () => setType('verb');

        const showSingleTab = () => {
            document.getElementById('form-single').classList.remove('hidden'); document.getElementById('form-bulk').classList.add('hidden');
            document.getElementById('tab-single').className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-gray-700 shadow-sm dark:text-white transition-all";
            document.getElementById('tab-bulk').className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-500 dark:text-gray-400 transition-all";
        };
        const showBulkTab = () => {
            document.getElementById('form-bulk').classList.remove('hidden'); document.getElementById('form-single').classList.add('hidden');
            document.getElementById('tab-bulk').className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-green-500 shadow-md shadow-green-500/40 text-white transition-all transform scale-[1.02]";
            document.getElementById('tab-single').className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-500 dark:text-gray-400 transition-all";
        };

        document.getElementById('tab-single').onclick = showSingleTab;
        document.getElementById('tab-bulk').onclick = showBulkTab;

        document.getElementById('add-btn').onclick = () => { 
            editId = null; document.getElementById('modal-title').innerText = "–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ"; 
            document.getElementById('add-form').reset(); setType('noun'); showSingleTab(); selectArticle('der'); modal.classList.remove('hidden'); 
        };
        document.getElementById('close-modal').onclick = () => modal.classList.add('hidden');
        
        window.openEdit = (id) => {
            const w = globalWords.find(x => x.id === id); if(!w) return;
            editId = w.id; document.getElementById('modal-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"; showSingleTab();
            setType(w.word_type); 
            if(w.word_type === 'noun') selectArticle(w.article || 'der');
            
            document.getElementById('word-de').value = w.word_de; document.getElementById('word-ru').value = w.word_ru;
            document.getElementById('word-plural').value = w.plural || "";
            document.getElementById('word-praeteritum').value = w.praeteritum || "";
            document.getElementById('word-partizip').value = w.partizip || "";
            document.getElementById('word-example').value = w.example || "";
            document.getElementById('word-folder').value = w.folder; document.getElementById('word-level').value = w.level || ""; document.getElementById('word-subfolder').value = w.subfolder;
            modal.classList.remove('hidden');
        };

        window.fastAdd = (folder, level, subfolder) => {
            editId = null; document.getElementById('modal-title').innerText = "–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ";
            document.getElementById('add-form').reset(); setType('noun'); showSingleTab(); selectArticle('der');
            document.getElementById('word-folder').value = folder; 
            document.getElementById('word-level').value = level === '–û–±—â–µ–µ' ? '' : level; 
            document.getElementById('word-subfolder').value = subfolder;
            modal.classList.remove('hidden'); setTimeout(() => document.getElementById('word-de').focus(), 150);
        };

        window.deleteWord = async (id, event) => { 
            if (event) event.stopPropagation(); 
            if (confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ?')) { 
                await apiFetch(`${API_URL}/${id}`, { method: 'DELETE' }); 
                await fetchWords(); 
                renderDict();
            } 
        };

        window.deleteFolder = async (f, l, s) => {
            if (confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é —Ç–µ–º—É "${s}" —Å–æ –≤—Å–µ–º–∏ —Å–ª–æ–≤–∞–º–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) {
                await apiFetch('/words/delete_folder', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({folder: f, level: l, subfolder: s}) 
                });
                await fetchWords();
                renderDict();
            }
        };

        document.getElementById('add-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                word_type: currentType, 
                article: currentType==='noun' ? currentArticle : '',
                word_de: document.getElementById('word-de').value.trim(), 
                plural: currentType==='noun' ? document.getElementById('word-plural').value.trim() : '',
                praeteritum: currentType==='verb' ? document.getElementById('word-praeteritum').value.trim() : '',
                partizip: currentType==='verb' ? document.getElementById('word-partizip').value.trim() : '',
                word_ru: document.getElementById('word-ru').value.trim(),
                example: document.getElementById('word-example').value.trim(),
                folder: document.getElementById('word-folder').value.trim(), level: document.getElementById('word-level').value.trim(), subfolder: document.getElementById('word-subfolder').value.trim()
            };
            const url = editId ? `${API_URL}/${editId}/full` : API_URL;
            await apiFetch(url, { method: editId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            modal.classList.add('hidden'); searchInp.value = ''; 
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–ø–∫—É, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏–ª–∏ —Å–ª–æ–≤–æ
            const newTopicKey = `${payload.folder}|${payload.level || '–û–±—â–µ–µ'}|${payload.subfolder}`;
            collapsedDictTopics[newTopicKey] = false;

            await fetchWords(); 
            renderDict();
        };

        document.getElementById('btn-upload-csv').onclick = async () => {
            const f = new FormData(); 
            const folder = document.getElementById('bulk-folder').value.trim(); const level = document.getElementById('bulk-level').value.trim(); const subfolder = document.getElementById('bulk-subfolder').value.trim(); const fileInput = document.getElementById('bulk-file');
            if (!folder || !subfolder || !fileInput.files[0]) return alert("–ó–∞–ø–æ–ª–Ω–∏ –∫—É—Ä—Å, —Ç–µ–º—É –∏ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª!");
            f.append('folder', folder); f.append('level', level); f.append('subfolder', subfolder); f.append('file', fileInput.files[0]);
            
            const btn = document.getElementById('btn-upload-csv');
            btn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            btn.disabled = true;
            
            try {
                await apiFetch('/upload_csv', { method: 'POST', body: f }); 
                modal.classList.add('hidden'); 
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–ø–∫—É, –≤ –∫–æ—Ç–æ—Ä—É—é –∑–∞–≥—Ä—É–∑–∏–ª–∏ –ø–∞—á–∫—É
                const newTopicKey = `${folder}|${level || '–û–±—â–µ–µ'}|${subfolder}`;
                collapsedDictTopics[newTopicKey] = false;

                await fetchWords(); 
                renderDict();
            } catch(e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!"); }
            finally {
                btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—á–∫—É';
                btn.disabled = false;
            }
        };

        document.getElementById('bulk-file').onchange = function() {
            const label = this.nextElementSibling.querySelector('span');
            if(this.files[0]) label.innerText = this.files[0].name; else label.innerText = '–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª';
        };

        window.exportData = () => {
            window.location.href = `/export_csv`;
        };

        let trainList = []; let curIdx = 0;

        window.setDirection = (dir) => {
            trainDirection = dir;
            const activeCls = "flex-1 py-2 text-[11px] font-bold rounded-lg bg-white dark:bg-gray-700 shadow-sm text-blue-500 border border-blue-500 transition-all";
            const inactiveCls = "flex-1 py-2 text-[11px] font-bold rounded-lg text-gray-500 dark:text-gray-400 border border-transparent transition-all";
            
            document.getElementById('dir-auto').className = dir === 'auto' ? activeCls : inactiveCls;
            document.getElementById('dir-ru-de').className = dir === 'ru-de' ? activeCls : inactiveCls;
            document.getElementById('dir-de-ru').className = dir === 'de-ru' ? activeCls : inactiveCls;
        };
        
        function setupTrainMenu() {
            const container = document.getElementById('train-topics-container');
            container.innerHTML = '';
            
            const newWordsCount = globalWords.filter(w => w.score < MAX_SCORE && !(w.score === 5 && Date.now() < w.next_review)).length;
            const masteredCount = globalWords.filter(w => w.score >= MAX_SCORE).length;
            const waitingCount = globalWords.filter(w => w.score === 5 && Date.now() < w.next_review).length;
            const weakWordsCount = globalWords.filter(w => w.score < 4).length;

            let html = `
                <button onclick="startTraining('all')" class="w-full text-left bg-gradient-to-br from-blue-500 to-blue-600 hover:scale-[0.98] transition-all p-4 rounded-3xl shadow-md shadow-blue-500/30 flex justify-between items-center group mb-2">
                    <div>
                        <h3 class="text-white text-lg font-bold">üìö –ù–æ–≤—ã–µ –∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</h3>
                        <p class="text-blue-100 text-[9px] font-black uppercase tracking-widest mt-0.5">–£—á–∏—Ç—å: ${newWordsCount} ${waitingCount>0?`| –ñ–¥—É—Ç 24—á: ${waitingCount}`:''}</p>
                    </div>
                    <div class="bg-white/20 w-7 h-7 rounded-full flex items-center justify-center text-white backdrop-blur-md"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                </button>
            `;

            if (weakWordsCount > 0) {
                html += `
                    <button onclick="startTraining('weak')" class="w-full text-left bg-gradient-to-br from-orange-400 to-red-500 hover:scale-[0.98] transition-all p-4 rounded-3xl shadow-md shadow-orange-500/30 flex justify-between items-center group mb-2">
                        <div>
                            <h3 class="text-white text-lg font-bold">‚ö†Ô∏è Level 1 (–£–∑–Ω–∞–≤–∞–Ω–∏–µ)</h3>
                            <p class="text-orange-100 text-[9px] font-black uppercase tracking-widest mt-0.5">–§–ª–µ—à-–∫–∞—Ä—Ç–æ—á–∫–∏ (${weakWordsCount})</p>
                        </div>
                        <div class="bg-white/20 w-7 h-7 rounded-full flex items-center justify-center text-white backdrop-blur-md"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                    </button>
                `;
            }

            if (masteredCount > 0) {
                html += `
                    <button onclick="startTraining('mastered')" class="w-full text-left bg-gradient-to-br from-yellow-400 to-yellow-600 hover:scale-[0.98] transition-all p-4 rounded-3xl shadow-md shadow-yellow-500/30 flex justify-between items-center group mb-3">
                        <div>
                            <h3 class="text-white text-lg font-bold">üèÜ –ó–æ–ª–æ—Ç–æ–π –∑–∞–ø–∞—Å</h3>
                            <p class="text-yellow-100 text-[9px] font-black uppercase tracking-widest mt-0.5">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞—Ä—Ö–∏–≤ (${masteredCount})</p>
                        </div>
                        <div class="bg-white/20 w-7 h-7 rounded-full flex items-center justify-center text-white backdrop-blur-md"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                    </button>
                `;
            }

            const groupedTopics = {};
            globalWords.forEach(w => {
                const f = w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞';
                const key = `${w.folder}|${w.level||'–û–±—â–µ–µ'}|${w.subfolder}`;
                if (!groupedTopics[f]) groupedTopics[f] = new Set();
                groupedTopics[f].add(key);
            });

            const activeTopicsHTML = [];
            const masteredTopicsHTML = [];

            for (const folder in groupedTopics) {
                
                // --- –ù–û–í–ê–Ø –§–ò–ß–ê: –¢–†–ï–ù–ò–†–û–í–ö–ê –¶–ï–õ–´–ú –ö–£–†–°–û–ú ---
                const courseWords = globalWords.filter(w => (w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞') === folder);
                const cWordsCount = courseWords.filter(w => w.score < MAX_SCORE && !(w.score === 5 && Date.now() < w.next_review)).length;
                const cWaitingCount = courseWords.filter(w => w.score === 5 && Date.now() < w.next_review).length;
                
                let folderActiveHTML = '';
                if (cWordsCount > 0) {
                    folderActiveHTML += `
                        <button onclick="startTraining('course|${folder.replace(/'/g,"\\'")}')" class="w-full text-left bg-gradient-to-r from-teal-500 to-emerald-500 hover:scale-[0.98] transition-all p-4 rounded-2xl shadow-sm text-white mb-2 mt-5 flex justify-between items-center group">
                            <div>
                                <h3 class="text-base font-bold">üéì –í–µ—Å—å –∫—É—Ä—Å: ${folder}</h3>
                                <p class="text-[10px] font-medium opacity-80 mt-0.5">–î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–æ–≤: ${cWordsCount} ${cWaitingCount>0?`| –ñ–¥—É—Ç 24—á: ${cWaitingCount}`:''}</p>
                            </div>
                            <div class="bg-white/20 w-7 h-7 rounded-full flex items-center justify-center text-white backdrop-blur-md"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
                        </button>
                    `;
                } else {
                    folderActiveHTML += `<h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mt-5 mb-1.5 ml-2">${folder}</h3>`;
                }

                let folderMasteredHTML = `<h3 class="text-[10px] font-black text-gray-400/50 uppercase tracking-widest mt-5 mb-1.5 ml-2">${folder} (–ê—Ä—Ö–∏–≤)</h3>`;
                
                let hasActive = false;
                let hasMastered = false;

                groupedTopics[folder].forEach(t => {
                    const [f, l, s] = t.split('|');
                    const allInTopic = globalWords.filter(w => w.folder === f && (w.level||'–û–±—â–µ–µ') === l && w.subfolder === s);
                    
                    const wordsCount = allInTopic.filter(w => w.score < MAX_SCORE && !(w.score === 5 && Date.now() < w.next_review)).length;
                    const waitingCount = allInTopic.filter(w => w.score === 5 && Date.now() < w.next_review).length;
                    const archivedCount = allInTopic.filter(w => w.score >= MAX_SCORE).length;
                    
                    if (wordsCount === 0 && waitingCount === 0 && archivedCount > 0) {
                        hasMastered = true;
                        folderMasteredHTML += `
                            <button onclick="startTraining('${t}', true)" class="w-full text-left bg-gray-50 dark:bg-gray-800/40 hover:scale-[0.98] transition-all p-3 rounded-xl shadow-none border border-gray-100 dark:border-gray-800 flex justify-between items-center mb-1.5 opacity-60 grayscale">
                                <div>
                                    <div class="flex items-center gap-2 mb-0.5">
                                        <span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded bg-gray-200 text-gray-500">–í–´–£–ß–ï–ù–û</span>
                                        <h3 class="text-sm font-bold dark:text-gray-400 line-through">${s}</h3>
                                    </div>
                                    <p class="text-[10px] text-gray-400 font-medium">–í –∞—Ä—Ö–∏–≤–µ: ${archivedCount}</p>
                                </div>
                                <div class="bg-gray-200 dark:bg-gray-700 w-6 h-6 rounded-full flex items-center justify-center text-green-500">‚úì</div>
                            </button>
                        `;
                    } else {
                        hasActive = true;
                        folderActiveHTML += `
                            <button onclick="startTraining('${t}')" class="w-full text-left bg-white dark:bg-gray-800 hover:scale-[0.98] transition-all p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center mb-1.5 ml-2 w-[calc(100%-8px)]">
                                <div>
                                    <div class="flex items-center gap-2 mb-0.5">
                                        ${l !== '–û–±—â–µ–µ' ? `<span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded ${getLevelColor(l)}">${l}</span>` : ''}
                                        <h3 class="text-sm font-bold dark:text-white">${s}</h3>
                                    </div>
                                    <p class="text-[10px] text-gray-400 font-medium">–°–ª–æ–≤: ${wordsCount} <span class="opacity-50">${waitingCount>0?`| –ñ–¥—É—Ç: ${waitingCount}`:''}</span></p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700 w-6 h-6 rounded-full flex items-center justify-center text-gray-400 dark:text-gray-300"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>
                            </button>
                        `;
                    }
                });

                if (hasActive) activeTopicsHTML.push(folderActiveHTML);
                if (hasMastered) masteredTopicsHTML.push(folderMasteredHTML);
            }

            container.innerHTML = html + activeTopicsHTML.join('') + (masteredTopicsHTML.length > 0 ? '<div class="mt-6 border-t border-gray-200 dark:border-gray-800 pt-3"></div><h2 class="text-sm font-bold text-center text-gray-400 mb-3">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ç–µ–º—ã</h2>' + masteredTopicsHTML.join('') : '');
            
            document.getElementById('train-setup-block').classList.remove('hidden'); 
            document.getElementById('train-card-block').classList.add('hidden');
        }

        window.startTraining = (sel, forceArchive = false) => {
            let availableWords = globalWords.filter(w => w.score < MAX_SCORE && !(w.score === 5 && Date.now() < w.next_review));

            if (sel === 'all') { trainList = availableWords; } 
            else if (sel === 'weak') { trainList = availableWords.filter(w => w.score < 4); }
            else if (sel.startsWith('course|')) {
                // –¢–†–ï–ù–ò–†–û–í–ö–ê –¶–ï–õ–´–ú –ö–£–†–°–û–ú
                const courseName = sel.split('|')[1];
                trainList = availableWords.filter(w => (w.folder || '–ë–µ–∑ –∫—É—Ä—Å–∞') === courseName);
            }
            else if (sel === 'mastered' || forceArchive) { 
                if (forceArchive) {
                    const [f, l, s] = sel.split('|');
                    trainList = globalWords.filter(w => w.folder === f && (w.level||'–û–±—â–µ–µ') === l && w.subfolder === s);
                } else {
                    trainList = globalWords.filter(w => w.score >= MAX_SCORE); 
                }
            }
            else {
                const [f, l, s] = sel.split('|');
                trainList = availableWords.filter(w => w.folder === f && (w.level||'–û–±—â–µ–µ') === l && w.subfolder === s);
            }
            
            if (!trainList.length) {
                if (sel !== 'mastered' && !forceArchive) return alert('üéâ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å! (–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç 24 —á–∞—Å–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)');
                return alert('–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.');
            }
            
            trainList.sort(() => 0.5 - Math.random()); 
            curIdx = 0;
            sessionStartMs = Date.now();
            
            document.getElementById('train-setup-block').classList.add('hidden'); 
            document.getElementById('train-card-block').classList.remove('hidden'); 
            renderCard();
        };

        document.getElementById('btn-stop-training').onclick = () => {
            saveSessionTime();
            setupTrainMenu();
        };

        function renderCard() {
            if (curIdx >= trainList.length) { 
                alert('–°–µ—Å—Å–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞!'); 
                saveSessionTime();
                document.getElementById('main-scroll').scrollTo(0, 0);
                setupTrainMenu(); 
                return; 
            }
            
            const w = trainList[curIdx]; 
            const qEl = document.getElementById('train-question'); 
            const exQ = document.getElementById('train-example-q'); 
            const badge = document.getElementById('train-level-badge');
            
            const totalCardsEl = document.getElementById('train-total-cards');
            if(totalCardsEl) totalCardsEl.innerText = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${curIdx + 1}/${trainList.length}`;
            
            const progressFill = document.getElementById('train-card-progress-fill');
            const progressText = document.getElementById('train-card-progress-text');
            if(progressText) progressText.innerText = `–û—á–∫–∏: ${Math.min(w.score, MAX_SCORE)}/${MAX_SCORE}`;
            if(progressFill) progressFill.style.width = `${Math.min(100, (w.score / MAX_SCORE) * 100)}%`;
            
            document.getElementById('train-answer-block').classList.add('hidden'); 
            document.getElementById('train-manual-block').classList.add('hidden'); 
            document.getElementById('btn-show-answer').classList.add('hidden');
            document.getElementById('manual-feedback').classList.add('hidden');
            document.getElementById('train-de-plural').classList.add('hidden');
            if(exQ) exQ.classList.add('hidden');

            const manArt = document.getElementById('manual-article'); 
            const manMain = document.getElementById('manual-main'); 
            const manPluralContainer = document.getElementById('manual-plural-container');
            const manPlural = document.getElementById('manual-plural');
            
            const manVerbContainer = document.getElementById('manual-verb-forms-container');
            const manPraet = document.getElementById('manual-praeteritum');
            const manPart = document.getElementById('manual-partizip');
            
            const btnCheck = document.getElementById('btn-check-manual');
            const umlautBar = document.getElementById('train-umlauts');
            const btnSpeakQ = document.getElementById('btn-speak-question');
            const btnSpeakAns = document.getElementById('btn-speak-answer');
            const btnMic = document.getElementById('btn-mic');

            if(manArt) manArt.disabled = false;
            if(manMain) manMain.disabled = false;
            if(manPlural) manPlural.disabled = false;
            if(manPraet) manPraet.disabled = false;
            if(manPart) manPart.disabled = false;
            if(btnCheck) btnCheck.disabled = false;

            const fullGerman = (w.word_type==='noun' ? (w.article||'') + ' ' : '') + (w.word_de||'');
            
            let state = w.score < 4 ? 'L1' : w.score < 6 ? 'L2' : 'Archive';

            if (trainDirection === 'de-ru') { currentIsGermanQuestion = true; } 
            else if (trainDirection === 'ru-de') { currentIsGermanQuestion = false; } 
            else { 
                currentIsGermanQuestion = state === 'L2' ? false : Math.random() > 0.5;
            } 

            if (currentIsGermanQuestion) {
                if(btnSpeakQ) { btnSpeakQ.classList.remove('hidden'); btnSpeakQ.onclick = (e) => speakWord(fullGerman, e); }
                if(btnSpeakAns) btnSpeakAns.classList.add('hidden');
            } else {
                if(btnSpeakQ) btnSpeakQ.classList.add('hidden');
                if(btnSpeakAns) { btnSpeakAns.classList.remove('hidden'); btnSpeakAns.onclick = (e) => speakWord(fullGerman, e); }
            }

            if (recognition && btnMic) {
                btnMic.classList.remove('hidden');
                btnMic.onclick = () => {
                    recognition.lang = currentIsGermanQuestion ? 'ru-RU' : 'de-DE';
                    recognition.start();
                    btnMic.classList.add('text-red-500', 'animate-pulse');
                    btnMic.classList.remove('text-gray-400');
                };

                recognition.onresult = (event) => {
                    let transcript = event.results[0][0].transcript.replace(/[.,!?]$/, '').trim();
                    
                    if (!currentIsGermanQuestion && w.word_type === 'noun') {
                        const parts = transcript.split(' ');
                        const art = parts[0].toLowerCase();
                        if (['der', 'die', 'das'].includes(art)) {
                            manArt.value = art;
                            manMain.value = parts.slice(1).join(' ');
                        } else {
                            manMain.value = transcript;
                        }
                    } else {
                        manMain.value = transcript;
                    }
                };

                recognition.onend = () => {
                    btnMic.classList.remove('text-red-500', 'animate-pulse');
                    btnMic.classList.add('text-gray-400');
                };

                recognition.onerror = (event) => {
                    console.error("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:", event.error);
                    btnMic.classList.remove('text-red-500', 'animate-pulse');
                    btnMic.classList.add('text-gray-400');
                };
            } else if (btnMic) {
                btnMic.classList.add('hidden');
            }

            const ansEx = document.getElementById('train-answer-example');
            if (w.example && ansEx) {
                ansEx.innerText = '"' + w.example + '"';
                ansEx.classList.remove('hidden');
            } else if (ansEx) {
                ansEx.classList.add('hidden');
            }

            document.getElementById('train-de-word').innerText = currentIsGermanQuestion ? (w.word_ru||'') : fullGerman;
            
            if (w.word_type === 'noun' && w.plural) {
                document.getElementById('train-de-plural').innerText = `Plural: die ${w.plural}`;
            } else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) {
                document.getElementById('train-de-plural').innerText = `Formen: ${w.praeteritum || '-'}, ${w.partizip || '-'}`;
            }

            if (state === 'L1' || state === 'Archive') {
                if(badge) { 
                    if (state === 'Archive') {
                        badge.innerText = "–ê–†–•–ò–í üèÜ"; badge.className = "px-2.5 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-yellow-100 dark:bg-yellow-900/40 text-yellow-600 dark:text-yellow-400";
                    } else {
                        badge.innerText = `LEVEL 1: –£–ó–ù–ê–í–ê–ù–ò–ï (${w.score}/4)`; badge.className = "px-2.5 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400"; 
                    }
                }
                if(qEl) qEl.innerText = currentIsGermanQuestion ? fullGerman : (w.word_ru||''); 
                document.getElementById('btn-show-answer').classList.remove('hidden');

            } else if (state === 'L2') {
                if(badge) { badge.innerText = `LEVEL 2: –ü–ò–°–¨–ú–û (${w.score === 4 ? '1/2' : '–§–ò–ù–ê–õ'})`; badge.className = "px-2.5 py-1 rounded-md text-[9px] font-black uppercase tracking-widest bg-orange-100 dark:bg-orange-900/40 text-orange-600 dark:text-orange-400"; }
                if(qEl) qEl.innerText = currentIsGermanQuestion ? fullGerman : (w.word_ru||'');
                
                if(!currentIsGermanQuestion && w.example && exQ) { 
                    try {
                        const safeWord = (w.word_de||'').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        exQ.innerHTML = w.example.replace(new RegExp(safeWord, 'ig'), '_____'); 
                    } catch(e) { exQ.innerHTML = w.example; }
                    exQ.classList.remove('hidden'); 
                }
                
                document.getElementById('train-manual-block').classList.remove('hidden');
                
                if (currentIsGermanQuestion) {
                    if(manArt) manArt.classList.add('hidden'); 
                    if(manMain) { manMain.value = ''; manMain.placeholder = "–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π..."; }
                    if(manPluralContainer) manPluralContainer.classList.add('hidden');
                    if(manVerbContainer) manVerbContainer.classList.add('hidden');
                    if(umlautBar) umlautBar.classList.add('hidden'); 
                    setTimeout(() => { if(manMain) manMain.focus() }, 150);
                } else {
                    if(manArt) { manArt.classList.remove('hidden'); manArt.classList.toggle('hidden', w.word_type==='verb'); manArt.value = ''; }
                    if(manMain) { manMain.value = ''; manMain.placeholder = "–°–ª–æ–≤–æ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º..."; }
                    
                    if (w.word_type === 'noun' && w.plural) {
                        if(manPluralContainer) manPluralContainer.classList.remove('hidden');
                        if(manPlural) manPlural.value = '';
                    } else {
                        if(manPluralContainer) manPluralContainer.classList.add('hidden');
                    }

                    if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) {
                        if(manVerbContainer) manVerbContainer.classList.remove('hidden');
                        if(manPraet) manPraet.value = '';
                        if(manPart) manPart.value = '';
                    } else {
                        if(manVerbContainer) manVerbContainer.classList.add('hidden');
                    }

                    if(umlautBar) umlautBar.classList.remove('hidden'); 
                    setTimeout(() => { 
                        const target = w.word_type==='noun' ? document.getElementById('manual-article') : document.getElementById('manual-main');
                        if (target) target.focus();
                    }, 150);
                }
            }
        }

        async function updateScore(newScore, nextReviewMs) {
            await apiFetch(`${API_URL}/${trainList[curIdx].id}/score`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({score: newScore, next_review: nextReviewMs})});
            const gwItem = globalWords.find(gw => gw.id === trainList[curIdx].id);
            if(gwItem) { gwItem.score = newScore; gwItem.next_review = nextReviewMs; }
            trainList[curIdx].score = newScore; 
            curIdx++; renderCard();
        }

        document.getElementById('btn-show-answer').onclick = () => { 
            document.getElementById('btn-show-answer').classList.add('hidden'); 
            document.getElementById('train-answer-block').classList.remove('hidden'); 
            
            const w = trainList[curIdx];
            if (w.word_type === 'noun' && w.plural) {
                document.getElementById('train-de-plural').classList.remove('hidden');
            } else if (w.word_type === 'verb' && (w.praeteritum || w.partizip)) {
                document.getElementById('train-de-plural').classList.remove('hidden');
            }
        };
        
        document.getElementById('btn-forgot').onclick = () => updateScore(0, 0); 
        document.getElementById('btn-remembered').onclick = () => {
            const w = trainList[curIdx];
            if (w.score < 4) updateScore(w.score + 1, 0);
            else updateScore(w.score, 0); 
        };
        
        document.getElementById('btn-check-manual').onclick = () => {
            const w = trainList[curIdx]; 
            
            const artRaw = document.getElementById('manual-article').value;
            const mainRaw = document.getElementById('manual-main').value;
            const pluralRaw = document.getElementById('manual-plural').value;
            const praetRaw = document.getElementById('manual-praeteritum').value;
            const partRaw = document.getElementById('manual-partizip').value;

            const art = (artRaw ? artRaw.trim().toLowerCase() : ""); 
            const main = (mainRaw ? mainRaw.trim() : "");
            const typedPlural = (pluralRaw ? pluralRaw.trim().toLowerCase() : "");
            const typedPraet = (praetRaw ? praetRaw.trim().toLowerCase() : "");
            const typedPart = (partRaw ? partRaw.trim().toLowerCase() : "");
            
            const feedback = document.getElementById('manual-feedback');
            const btnCheck = document.getElementById('btn-check-manual');
            
            let isCorrect = false;
            let correctAnswer = "";

            if (!currentIsGermanQuestion) {
                const expectedArt = (w.article ? w.article.toLowerCase() : "");
                const expectedWord = (w.word_de ? w.word_de.toLowerCase() : "");
                const expectedPlural = (w.plural ? w.plural.toLowerCase() : "");
                const expectedPraet = (w.praeteritum ? w.praeteritum.toLowerCase() : "");
                const expectedPart = (w.partizip ? w.partizip.toLowerCase() : "");
                
                if (w.word_type === 'noun') {
                    if (w.plural) {
                        isCorrect = (art === expectedArt) && (main.toLowerCase() === expectedWord) && (typedPlural === expectedPlural);
                        correctAnswer = `${w.article} ${w.word_de} (die ${w.plural})`;
                    } else {
                        isCorrect = (art === expectedArt) && (main.toLowerCase() === expectedWord);
                        correctAnswer = `${w.article} ${w.word_de}`;
                    }
                } else if (w.word_type === 'verb') {
                    let baseCorrect = (main.toLowerCase() === expectedWord);
                    let formsCorrect = true;
                    if (w.praeteritum || w.partizip) {
                        formsCorrect = (typedPraet === expectedPraet) && (typedPart === expectedPart);
                        correctAnswer = `${w.word_de} (${w.praeteritum}, ${w.partizip})`;
                    } else {
                        correctAnswer = w.word_de;
                    }
                    isCorrect = baseCorrect && formsCorrect;
                } else {
                    isCorrect = main.toLowerCase() === expectedWord;
                    correctAnswer = w.word_de;
                }
            } else {
                const expectedWord = (w.word_ru ? w.word_ru.toLowerCase() : "");
                isCorrect = main.toLowerCase() === expectedWord;
                correctAnswer = w.word_ru;
            }

            document.getElementById('manual-article').disabled = true;
            document.getElementById('manual-main').disabled = true;
            document.getElementById('manual-plural').disabled = true;
            document.getElementById('manual-praeteritum').disabled = true;
            document.getElementById('manual-partizip').disabled = true;
            btnCheck.disabled = true;

            feedback.className = "w-full text-center py-2.5 rounded-lg font-bold text-sm mb-2 transition-all animate-in fade-in zoom-in duration-200 shadow-sm";

            if (isCorrect) {
                feedback.classList.add('bg-green-100', 'text-green-700', 'dark:bg-green-900/40', 'dark:text-green-400');
                feedback.innerText = "üéâ –û—Ç–ª–∏—á–Ω–æ!";
                feedback.classList.remove('hidden');
                
                if (w.score === 4) {
                    setTimeout(() => updateScore(5, Date.now() + (24 * 60 * 60 * 1000)), 1000); 
                } else if (w.score === 5) {
                    setTimeout(() => updateScore(6, 0), 1000); 
                } else {
                    setTimeout(() => updateScore(w.score + 1, 0), 1000);
                }

            } else {
                feedback.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-900/40', 'dark:text-red-400');
                feedback.innerText = `‚ùå –û—à–∏–±–∫–∞! –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correctAnswer}`;
                feedback.classList.remove('hidden');
                setTimeout(() => updateScore(0, 0), 2500);
            }
        };

        document.getElementById('btn-trigger-restore').onclick = () => document.getElementById('file-restore').click();
        
        document.getElementById('file-restore').onchange = async function() {
            if(!this.files[0]) return;
            if(!confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â–∏–µ —Å–ª–æ–≤–∞ –∏ –∑–∞–º–µ–Ω–∏—Ç –∏—Ö –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±—ç–∫–∞–ø–∞. –í—ã —É–≤–µ—Ä–µ–Ω—ã?")) {
                this.value = '';
                return;
            }
            
            const f = new FormData();
            f.append('file', this.files[0]);
            
            const btn = document.getElementById('btn-trigger-restore');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            btn.disabled = true;
            
            try {
                const res = await apiFetch('/restore_backup', { method: 'POST', body: f });
                const result = await res.json();
                if(result.status === 'success') {
                    document.getElementById('backup-modal').classList.add('hidden');
                    alert(`‚úÖ –ë–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–ª–æ–≤: ${result.restored}`);
                    await fetchWords();
                    loadStats();
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏!");
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–∑—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞."); }
            finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                this.value = '';
            }
        };

        window.resetFolderStats = async (f, l, s) => {
            if(confirm(`–û–±–Ω—É–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —Ç–µ–º—ã "${s}"?`)){
                await apiFetch('/words/reset_folder', {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({folder:f, level:l, subfolder:s})});
                await fetchWords(); 
                loadStats();
            }
        };

        function loadStats() {
            const stats = document.getElementById('view-stats');
            const total = globalWords.length; 
            const mastered = globalWords.filter(w => w.score >= MAX_SCORE).length;
            const folders = {};
            
            globalWords.forEach(w => { 
                const k = `${w.folder}|${w.level||'–û–±—â–µ–µ'}|${w.subfolder}`; 
                if(!folders[k]) folders[k] = {f:w.folder, l:w.level||'–û–±—â–µ–µ', s:w.subfolder, total:0, done:0}; 
                folders[k].total++; 
                if(w.score>=MAX_SCORE) folders[k].done++; 
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: —Å–Ω–∞—á–∞–ª–∞ —Ç–µ, –≥–¥–µ –±–æ–ª—å—à–µ % –≤—ã—É—á–µ–Ω–Ω–æ–≥–æ (–Ω–æ –Ω–µ 100%), –∑–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            const sortedFolders = Object.values(folders).sort((a, b) => {
                const pctA = a.done / a.total;
                const pctB = b.done / b.total;
                if (pctB !== pctA) return pctB - pctA;
                return a.s.localeCompare(b.s);
            });

            const today = new Date().toDateString();
            let dailyStats = JSON.parse(localStorage.getItem('dailyStudy')) || { date: today, ms: 0 };
            if (dailyStats.date !== today) dailyStats = { date: today, ms: 0 };
            
            const minutesToday = Math.floor(dailyStats.ms / 60000);
            const timeProgressPct = Math.min(100, (minutesToday / DAILY_GOAL_MINUTES) * 100);

            stats.innerHTML = `
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-5 rounded-3xl text-white shadow-xl shadow-purple-500/30">
                    <p class="text-[10px] font-black opacity-80 uppercase tracking-widest">–¶–µ–ª—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</p>
                    <div class="flex items-end gap-2 mt-0.5">
                        <h2 class="text-4xl font-black tracking-tighter">${minutesToday}</h2>
                        <span class="text-sm font-bold opacity-80 mb-1">/ ${DAILY_GOAL_MINUTES} –º–∏–Ω</span>
                    </div>
                    <div class="w-full bg-white/20 h-1.5 rounded-full overflow-hidden mt-3 relative">
                        <div class="bg-white h-full transition-all duration-1000" style="width: ${timeProgressPct}%"></div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-3xl text-white shadow-xl shadow-blue-500/30">
                    <p class="text-[10px] font-black opacity-80 uppercase tracking-widest">–£—Ä–æ–≤–µ–Ω—å Mastery</p>
                    <h2 class="text-4xl font-black mt-0.5 tracking-tighter">${Math.round((mastered/total||0)*100)}%</h2>
                    <p class="mt-2 text-xs font-medium">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ ${mastered} –∏–∑ ${total} —Å–ª–æ–≤.</p>
                </div>
                
                <h3 class="font-bold text-base mt-6 mb-1 dark:text-white px-1">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º</h3>
                <div class="space-y-2.5">
                    ${sortedFolders.map(dat => `
                        <div class="bg-white dark:bg-gray-800 p-3.5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 relative">
                            <button onclick="resetFolderStats('${dat.f.replace(/'/g,"\\'")}', '${dat.l.replace(/'/g,"\\'")}', '${dat.s.replace(/'/g,"\\'")}')" class="absolute top-3 right-3 text-gray-300 hover:text-orange-500 transition-colors">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            </button>
                            <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-0.5">${dat.f}</p>
                            <div class="flex items-center gap-2 mb-2 pr-6">
                                ${dat.l !== '–û–±—â–µ–µ' ? `<span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded ${getLevelColor(dat.l)}">${dat.l}</span>` : ''}
                                <h4 class="font-bold text-sm dark:text-white">${dat.s}</h4>
                            </div>
                            <div class="flex justify-end mb-1"><span class="text-[10px] font-bold text-blue-500">${dat.done}/${dat.total}</span></div>
                            <div class="w-full bg-gray-100 dark:bg-gray-700 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-blue-500 h-full transition-all duration-1000" style="width: ${(dat.done/dat.total)*100}%"></div>
                            </div>
                        </div>`).join('')}
                </div>
                
                <button onclick="document.getElementById('backup-modal').classList.remove('hidden')" class="w-full mt-4 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold py-3.5 rounded-2xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-all flex justify-center items-center gap-2 shadow-sm text-sm">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ (–ë—ç–∫–∞–ø)
                </button>
            `;
        }

        switchView('dict');
    </script>
</body>
</html>